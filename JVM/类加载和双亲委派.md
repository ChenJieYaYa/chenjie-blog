# ç±»åŠ è½½

## ä¸€ã€JVMåŠ è½½ç±»çš„æ—¶æœº

> åœ¨[JVMæ¦‚è¿°](/15.JVM/JVMæ¦‚è¿°)ä¸­è®²è§£åˆ°å­—èŠ‚ç çš„åŠ è½½æµç¨‹ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜åº”è¯¥æ¯”è¾ƒç®€å•

**JVMåœ¨*åˆæ¬¡ä¸»åŠ¨*ä½¿ç”¨æŸç±»æ—¶è¢«åŠ è½½**ï¼Œä¸»åŠ¨ä½¿ç”¨çš„æƒ…å†µå¦‚ä¸‹

- **åˆ›å»ºç±»å®ä¾‹**ï¼Œå¦‚`new Class()`

- **è®¿é—®é™æ€å˜é‡æˆ–ç»™é™æ€å˜é‡èµ‹å€¼**ï¼Œfinalä¿®é¥°å¦å¤–è€ƒè™‘

- **è°ƒç”¨é™æ€æ–¹æ³•**ï¼Œå³ä½¿ç”¨å­—èŠ‚ç `invokestatic`æŒ‡ä»¤

- **åå°„**ï¼Œå¦‚`Class.forName("java.lang.String")`

- **åˆå§‹åŒ–å­ç±»æ—¶ï¼Œå…ˆåˆå§‹åŒ–çˆ¶ç±»**ï¼Œä½†è¿™å¯¹æ¥å£ä¸é€‚ç”¨

  > åˆå§‹åŒ–ç±»ï¼Œä¸ä¼šå…ˆåˆå§‹åŒ–å…¶å®ç°çš„æ¥å£
  >
  > åˆå§‹åŒ–æ¥å£ï¼Œä¸ä¼šå…ˆåˆå§‹åŒ–å…¶çˆ¶æ¥å£

- **æ¥å£å®šä¹‰defaultæ–¹æ³•ï¼Œåˆå§‹åŒ–æ¥å£å®ç°ç±»å‰å…ˆåˆå§‹åŒ–è¯¥æ¥å£**

- **JVMå¯åŠ¨æ—¶ï¼Œè¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»**ï¼ŒåŒ…å«main()

- **åˆæ¬¡è°ƒç”¨MethodHandleå®ä¾‹æ—¶ï¼Œåˆå§‹åŒ–è¯¥MethodHandleæŒ‡å‘çš„æ–¹æ³•æ‰€åœ¨çš„ç±»**

## äºŒã€ç±»åŠ è½½çš„è¿‡ç¨‹

> åœ¨[JVMæ¦‚è¿°](/15.JVM/JVMæ¦‚è¿°)ä¸­è®²è§£åˆ°å­—èŠ‚ç çš„åŠ è½½æµç¨‹ï¼Œç±»åŠ è½½è¿‡ç¨‹å°±æ˜¯å­—èŠ‚ç åŠ è½½æµç¨‹

### 1.Loading(åŠ è½½)

#### 1.1.åŠ è½½ç†è§£

åŠ è½½ç®€è€Œè¨€ä¹‹å°±æ˜¯**æŸ¥æ‰¾ç±»çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œç”Ÿæˆå­—èŠ‚ç ï¼Œå°†å­—èŠ‚ç åŠ è½½åˆ°æœºå™¨å†…å­˜ï¼Œå¹¶åœ¨å†…å­˜ä¸­æ„å»ºJavaç±»åŸå‹(ç±»æ¨¡æ¿å¯¹è±¡)**

**ç±»æ¨¡æ¿å¯¹è±¡å®é™…æ˜¯Javaç±»åœ¨JVMä¸­çš„å¿«ç…§**ï¼ŒJVMä»å­—èŠ‚ç æ–‡ä»¶ä¸­è§£æå‡ºå¸¸é‡æ± ã€ç±»å­—æ®µã€ç±»æ–¹æ³•ç­‰ä¿¡æ¯å­˜åˆ°ç±»æ¨¡æ¿ä¸­ï¼Œä½¿JVMåœ¨è¿è¡ŒæœŸé—´èƒ½é€šè¿‡ç±»æ¨¡æ¿è·å¾—Javaç±»çš„ä»»ä½•ä¿¡æ¯ï¼Œåå°„åŸºäºè¿™ä¸€åŸºç¡€

#### 1.2.åŠ è½½è¿‡ç¨‹

- **é€šè¿‡å…¨ç±»åè·å–ç±»çš„äºŒè¿›åˆ¶æ•°æ®**

- è§£æç±»çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæˆä¸º**æ–¹æ³•åŒºä¸­çš„æ•°æ®ç»“æ„(ç±»æ¨¡æ¿å¯¹è±¡)**

- **å †ä¸­åˆ›å»ºjava.lang.Classç±»å®ä¾‹ï¼Œä½œä¸ºæ–¹æ³•åŒºè¯¥ç±»æ•°æ®çš„å½“é—®å…¥å£**

  > Classå¯¹è±¡åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­åˆ›å»ºï¼Œæ¯ä¸ªç±»å¯¹åº”ä¸€ä¸ªClasså¯¹è±¡ï¼Œä¸”Classå¯¹è±¡çš„æ„é€ å‡½æ•°ç§æœ‰ï¼Œåªæœ‰JVMå¯åˆ›å»º

  > æ³¨æ„æ•°ç»„ç±»æœ¬èº«ä¸æ˜¯ç”±ç±»åŠ è½½å™¨è´Ÿè´£åˆ›å»ºï¼Œè€Œæ˜¯JVMè¿è¡Œæ—¶æ ¹æ®éœ€è¦åˆ›å»ºï¼Œä½†æ•°ç»„ç±»çš„å…ƒç´ éœ€è¦é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½

  > è‹¥è¾“å…¥æ•°æ®ä¸æ˜¯ClassFileï¼ŒæŠ›å‡ºå¼‚å¸¸ClassFormatError

#### 1.3.äºŒè¿›åˆ¶æµçš„è·å–æ–¹å¼

- æ–‡ä»¶ç³»ç»Ÿè¯»å…¥.classæ–‡ä»¶ï¼ˆæœ€å¸¸è§ï¼‰
- è¿è¡Œæ—¶ç”ŸæˆclassäºŒè¿›åˆ¶ä¿¡æ¯
- è¯»jarã€zipç­‰å½’æ¡£æ–‡ä»¶ï¼Œæå–ç±»æ–‡ä»¶
- å®ç°æ”¾åœ¨æ•°æ®åº“çš„äºŒè¿›åˆ¶æ•°æ®
- ä½¿ç”¨åè®®é€šè¿‡ç½‘ç»œåŠ è½½

### 2.Linking(é“¾æ¥)

#### 2.1.Verification(éªŒè¯)

**éªŒè¯çš„ç›®çš„æ˜¯ä¿è¯åŠ è½½çš„å­—èŠ‚ç åˆæ³•**ï¼ŒéªŒè¯çš„æ­¥éª¤æ¯”è¾ƒå¤æ‚ï¼Œå®é™…è¦éªŒè¯çš„é¡¹ç›®ä¹Ÿå¾ˆç¹å¤šï¼Œå¤§æ¦‚éªŒè¯è¿‡ç¨‹å¦‚ä¸‹

![1657506041788](assets/1657506041788.png)

**å…¶ä¸­æ ¼å¼éªŒè¯ä¼šåœ¨åŠ è½½é˜¶æ®µä¸€èµ·æ‰§è¡Œï¼ŒéªŒè¯é€šè¿‡åï¼Œç±»åŠ è½½å™¨æ‰ä¼šå°†ç±»çš„äºŒè¿›åˆ¶æ•°æ®åŠ è½½åˆ°æ–¹æ³•åŒº**ï¼Œå…¶ä»–éªŒè¯ä¼šåœ¨æ–¹æ³•åŒºä¸­è¿›è¡Œï¼Œç¬¦å·å¼•ç”¨éªŒè¯ä¼šåœ¨è§£æé˜¶æ®µæ‰§è¡Œ

#### 2.2.Preparation(å‡†å¤‡)

è¯¥é˜¶æ®µä¼š**ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼**ï¼Œå¯¹äºè¯¥é˜¶æ®µåº”æ³¨æ„ä»¥ä¸‹å‡ ç‚¹

- Javaä¸æ”¯æŒbooleanç±»å‹ï¼Œæ‰€ä»¥å¯¹äºbooleanç±»å‹å†…éƒ¨å®é™…æ˜¯intï¼Œinté»˜è®¤å€¼0æ‰€ä»¥å¯¹åº”äºfalse
- è¯¥é˜¶æ®µä¸åŒ…å«static finalç±»å‹çš„æ•°æ®ï¼Œå› ä¸ºfinalç±»å‹çš„æ•°æ®åœ¨ç¼–è¯‘é˜¶æ®µå°±è¢«åˆ†é…(3.2ä¸­å…·ä½“è®²è§£)
- è¯¥é˜¶æ®µä¸ä¼šä¸ºç±»çš„å®ä¾‹å˜é‡åˆå§‹åŒ–ï¼Œå› ä¸ºå®ä¾‹å˜é‡éšç€å¯¹è±¡ä¸€èµ·è¢«åˆ†é…åˆ°Javaå †ä¸­
- åˆå§‹åŒ–ä¸º**é»˜è®¤å€¼**ï¼Œæ³¨æ„æ˜¯é»˜è®¤å€¼

#### 2.3.Resolution(è§£æ)

è¯¥é˜¶æ®µ**å°†ç±»ã€æ¥å£ã€å­—æ®µå’Œæ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬ä¸ºç›´æ¥å¼•ç”¨**

ç¬¦å·å¼•ç”¨æŒ‡å­—é¢é‡çš„å¼•ç”¨ï¼Œå’ŒVMçš„å†…éƒ¨æ•°æ®ç»“æ„å’Œå†…å­˜å¸ƒå±€æ— å…³ï¼Œå®¹æ˜“ç†è§£çš„æ˜¯Classç±»æ–‡ä»¶é€šè¿‡å¸¸é‡æ± äº§ç”Ÿå¤§é‡ç¬¦å·å¼•ç”¨ï¼Œ**JVMä¸ºæ¯ä¸ªç±»éƒ½å‡†å¤‡æ–¹æ³•è¡¨ï¼Œå½“è°ƒç”¨æŸæ–¹æ³•æ—¶åªéœ€è¦çŸ¥é“è¯¥æ–¹æ³•åœ¨æ–¹æ³•è¡¨ä¸­çš„åç§»é‡å³å¯ç›´æ¥è°ƒç”¨ï¼Œé€šè¿‡è§£æå¯å°†ç¬¦å·å¼•ç”¨è½¬å˜ä¸ºç›®æ ‡æ–¹æ³•åœ¨æ–¹æ³•è¡¨ä¸­çš„ä½ç½®**ï¼Œä»è€Œä½¿æ–¹æ³•è¢«æˆåŠŸè°ƒç”¨

ä»¥println()ä¸ºä¾‹ï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œç³»ç»Ÿéœ€è¦æ˜ç¡®çŸ¥é“è¯¥æ–¹æ³•çš„ä½ç½®ï¼Œ`System.out.println()`æ–¹æ³•çš„å­—èŠ‚ç ä¸º`invokevirtual #24 <java/io/PrintStream.println>`ï¼Œå¯¹åº”çš„æ–¹æ³•è¡¨å¦‚ä¸‹

![1657507177812](assets/1657507177812.png)

### 3.Initialization(åˆå§‹åŒ–)

#### 3.1.åˆå§‹åŒ–é˜¶æ®µ

å¦‚æœå‰é¢çš„æ­¥éª¤æ²¡æœ‰é—®é¢˜ï¼Œè¡¨ç¤ºç±»å¯ä»¥é¡ºåˆ©çš„è£…è½½åˆ°ç³»ç»Ÿä¸­ï¼Œæ­¤æ—¶ç±»æ‰ä¼š**å¼€å§‹æ‰§è¡ŒJavaå­—èŠ‚ç **ï¼Œå³**åˆ°è¾¾åˆå§‹åŒ–é˜¶æ®µæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„Javaç¨‹åºä»£ç **ï¼Œå³**æ­¤é˜¶æ®µæ ¹æ®ç¨‹åºå‘˜ç¼–å†™çš„Javaä»£ç åˆå§‹åŒ–`static`å˜é‡å’Œèµ„æº(`static{}`)**

**åˆå§‹åŒ–é˜¶æ®µçš„é‡è¦å·¥ä½œæ˜¯æ‰§è¡Œç±»çš„åˆå§‹åŒ–æ–¹æ³•`<clinit>()`**ï¼Œè¯¥æ–¹æ³•åªèƒ½ç”±Javaç¼–è¯‘å™¨ç”Ÿæˆï¼Œç”±JVMè°ƒç”¨ï¼Œç¨‹åºå‘˜æ— æ³•è‡ªå®šä¹‰è¯¥æ–¹æ³•ï¼Œæ›´æ— æ³•åœ¨ç¨‹åºä¸­ç›´æ¥è°ƒç”¨

> `<clinit>() `æ˜¯ç±»æ„é€ å™¨æ–¹æ³•ï¼Œå®ƒä¸ç±»çš„æ„é€ æ–¹æ³•`<init>`æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
>
> `<init>()`ï¼šå®ä¾‹æ„é€ å™¨æ–¹æ³•ï¼Œå¯¹éé™æ€å˜é‡è§£æåˆå§‹åŒ–ï¼Œnewå¯¹è±¡æ—¶è°ƒç”¨å¯¹è±¡ç±»çš„constructoræ–¹æ³•æ—¶æ‰§`<init>()`ï¼Œå³å®ä¾‹åŒ–å¯¹è±¡æ—¶è°ƒç”¨
>
> > å®ä¾‹åŒ–çš„å››ç§é€”å¾„ï¼šnewã€Classæˆ–Constructor å¯¹è±¡çš„newInstance()ã€ä»»æ„å¯¹è±¡çš„clone()ã€ObjectInputStreamçš„getObject()ååºåˆ—åŒ–
>
> `<clinit>()`ï¼šç±»æ„é€ å™¨æ–¹æ³•ï¼Œå¯¹é™æ€å˜é‡ã€é™æ€ä»£ç å—è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨ç±»åŠ è½½è¿‡ç¨‹çš„åˆå§‹åŒ–é˜¶æ®µJVMä¼šæ‰§è¡Œ`<clinit>()`

åœ¨åŠ è½½ç±»ä¹‹å‰ï¼ŒJVMè¯•å›¾åŠ è½½è¯¥ç±»çš„çˆ¶ç±»ï¼Œå› æ­¤çˆ¶ç±»æ€»æ˜¯åœ¨å­ç±»ä¹‹å‰è¢«è°ƒç”¨

#### 3.2.static finalä¿®é¥°çš„å­—æ®µåœ¨å“ªä¸ªé˜¶æ®µè¢«èµ‹å€¼ï¼Ÿ

**é“¾æ¥é˜¶æ®µçš„å‡†å¤‡ç¯èŠ‚èµ‹å€¼(æ˜¾å¼èµ‹å€¼)**

- åŸºæœ¬æ•°æ®ç±»å‹ä½¿ç”¨static finalä¿®é¥°ï¼Œåˆ™æ˜¾å¼èµ‹å€¼(ç›´æ¥èµ‹å€¼å¸¸é‡ï¼Œè€Œéè°ƒç”¨æ–¹æ³•)

```Java
public static final int i = 10;
```

- Stringä½¿ç”¨static finalä¿®é¥°ä¸”ä½¿ç”¨å­—é¢é‡çš„æ–¹å¼èµ‹å€¼

```java
public static final String str = "hello";
```

**åˆå§‹åŒ–é˜¶æ®µ`<clinit>()`ä¸­èµ‹å€¼**

- æ’é™¤ä¸Šè¿°çš„åœ¨å‡†å¤‡ç¯èŠ‚èµ‹å€¼çš„æƒ…å†µä¹‹å¤–çš„æƒ…å†µ

```java
public static int i = 10;
public static final int i = new Random().nextInt();

public static Integer i = Integer.valueOf(100);
public static final Integer i = Integer.valueOf(100);

public static String str = "hello";
public static final String str = new String("hello");
```

#### 3.3.`<clinit>()`çš„çº¿ç¨‹å®‰å…¨æ€§

å¯¹äº`<clinit>()`æ–¹æ³•çš„è°ƒç”¨ï¼ŒJVMä¼šåœ¨å†…éƒ¨ç¡®ä¿å…¶å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„å®‰å…¨æ€§ï¼Œå³ç¡®ä¿å…¶è¢«æ­£ç¡®åœ°åŠ é”ã€åŒæ­¥ï¼Œè‹¥å¤šçº¿ç¨‹åŒæ—¶åˆå§‹åŒ–æŸç±»ï¼Œé‚£ä¹ˆ**åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œè¯¥ç±»çš„`<clinit>()`**ï¼Œå…¶ä»–çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œä½†è¿™åŒæ—¶ä¹Ÿä¼šå¸¦æ¥å¤šçº¿ç¨‹åœºæ™¯ä¸‹åŠ é”å†æ¥çš„é—®é¢˜ï¼Œå¦‚è¿›è¡Œè€—æ—¶æ“ä½œå¯èƒ½é€ æˆé˜»å¡ã€æ­»é”ç­‰ï¼Œå¹¶ä¸”è¿™ç§æ­»é”å¾ˆéš¾å‘ç°

è‹¥ä¹‹å‰çš„çº¿ç¨‹æˆåŠŸåŠ è½½ç±»ï¼Œåˆ™ç­‰åœ¨é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å°±æ²¡æœ‰æœºä¼šå†æ‰§è¡Œ`<clinit>()`ï¼Œå½“éœ€è¦ä½¿ç”¨è¯¥ç±»æ—¶ï¼ŒJVMä¼šç›´æ¥è¿”å›ç»™å®ƒå·±ç»å‡†å¤‡å¥½çš„ä¿¡æ¯

#### 3.4.ä¸»åŠ¨ä½¿ç”¨ä¸è¢«åŠ¨ä½¿ç”¨

**ä¸»åŠ¨ä½¿ç”¨**ï¼š**JVMä¸ä¼šæ— æ¡ä»¶åœ°è£…è½½Class**ï¼ŒJVMè§„å®šç±»æˆ–æ¥å£åœ¨**åˆæ¬¡ä½¿ç”¨å‰å¿…é¡»è¦è¿›è¡Œåˆå§‹åŒ–**ï¼Œæ­¤å¤„æŒ‡çš„â€œä½¿ç”¨â€æ˜¯æŒ‡ä¸»åŠ¨ä½¿ç”¨ï¼Œä¸»åŠ¨ä½¿ç”¨åªæœ‰å¦‚ä¸‹æƒ…å†µï¼Œå¦‚æœå‡ºç°å¦‚ä¸‹æƒ…å†µåˆ™ä¼šå¯¹ç±»è¿›è¡Œåˆå§‹åŒ–æ“ä½œ

- **åˆ›å»ºç±»å®ä¾‹**ï¼Œå¦‚`new Class()`

- **è®¿é—®é™æ€å˜é‡æˆ–ç»™é™æ€å˜é‡èµ‹å€¼**ï¼Œfinalä¿®é¥°å¦å¤–è€ƒè™‘

- **è°ƒç”¨é™æ€æ–¹æ³•**ï¼Œå³ä½¿ç”¨å­—èŠ‚ç `invokestatic`æŒ‡ä»¤

- **åå°„**ï¼Œå¦‚`Class.forName("java.lang.String")`

- **åˆå§‹åŒ–å­ç±»æ—¶ï¼Œå…ˆåˆå§‹åŒ–çˆ¶ç±»**ï¼Œä½†è¿™å¯¹æ¥å£ä¸é€‚ç”¨

  > åˆå§‹åŒ–ç±»ï¼Œä¸ä¼šå…ˆåˆå§‹åŒ–å…¶å®ç°çš„æ¥å£
  >
  > åˆå§‹åŒ–æ¥å£ï¼Œä¸ä¼šå…ˆåˆå§‹åŒ–å…¶çˆ¶æ¥å£

- **æ¥å£å®šä¹‰defaultæ–¹æ³•ï¼Œåˆå§‹åŒ–æ¥å£å®ç°ç±»å‰å…ˆåˆå§‹åŒ–è¯¥æ¥å£**

- **JVMå¯åŠ¨æ—¶ï¼Œè¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»**ï¼ŒåŒ…å«main()

- **åˆæ¬¡è°ƒç”¨MethodHandleå®ä¾‹æ—¶ï¼Œåˆå§‹åŒ–è¯¥MethodHandleæŒ‡å‘çš„æ–¹æ³•æ‰€åœ¨çš„ç±»**

**è¢«åŠ¨ä½¿ç”¨**ï¼šé™¤ä»¥ä¸Šæƒ…å†µå¤–çš„å…¶ä»–éƒ½å±äºè¢«åŠ¨ä½¿ç”¨ï¼Œ**è¢«åŠ¨ä½¿ç”¨ä¸ä¼šå¼•èµ·ç±»åˆå§‹åŒ–**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»£ç ä¸­å‡ºç°çš„ç±»ä¸ä¸€å®šéƒ½è¢«åŠ è½½æˆ–åˆå§‹åŒ–ï¼Œè‹¥ä¸ç¬¦åˆä¸»åŠ¨åŠ è½½ä¹Ÿä¸ä¼šè¢«åˆå§‹åŒ–

### 4.Using(ä½¿ç”¨)

ä»»ä½•ç±»åœ¨ä½¿ç”¨å‰éƒ½è¦ç»è¿‡é“¾æ¥é˜¶æ®µ(éªŒè¯ã€å‡†å¤‡ã€è§£æ)ï¼Œç„¶åå°±ç­‰ç€å¼€å‘äººå‘˜ä½¿ç”¨

### 5.Unloading(å¸è½½)

**ç±»çš„ç”Ÿå‘½å‘¨æœŸä½•æ—¶ç»“æŸï¼Œå–å†³äºè¯¥ç±»Classå¯¹è±¡ä½•æ—¶ç»“æŸç”Ÿå‘½å‘¨æœŸ**ï¼Œå½“Classå¯¹è±¡ä¸å†è¢«å¼•ç”¨ï¼ŒClasså¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œè¯¥ç±»åœ¨æ–¹æ³•åŒºä¸­çš„æ•°æ®ç»“æ„è¢«å¸è½½ï¼Œä¸¾ä¸ªé¸¡è…¿ğŸ—

![1657696502657](assets/1657696502657.png)

**å·²ç»åŠ è½½çš„ç±»è¢«å¸è½½çš„å‡ ç‡å¾ˆå°ï¼Œè‡³å°‘è¢«å¸è½½çš„æ—¶é—´æ˜¯ä¸ç¡®å®šçš„**

## ä¸‰ã€JVMç±»åŠ è½½å™¨ç±»å‹

### 1.Bootstrap ClassLoader(å¯åŠ¨ç±»åŠ è½½å™¨)

å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½`jre/lib`ä¸‹çš„æ ¸å¿ƒjaråŒ…

![1657537137768](assets/1657537137768.png)

### 2.Extension ClassLoader(æ‰©å±•ç±»åŠ è½½å™¨)

æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½`jre/lib/ext`ä¸‹çš„æ ¸å¿ƒjaråŒ…

![1657537192942](assets/1657537192942.png)

### 3.Application ClassLoader(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)

åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨åŠ è½½`classpath`ä¸‹çš„ç±»åº“ï¼Œå³ç¨‹åºæ‰€åœ¨ç›®å½•ä¸‹çš„ç±»åº“

### 4.éªŒè¯ä¸‰ä¸ªç±»åŠ è½½å™¨çš„ç›®æ ‡è·¯å¾„

#### 4.1.ä»£ç æ‰“å°éªŒè¯ç›®æ ‡è·¯å¾„

â‘ ç¼–å†™LoadPath

```java
package ClassLoaderPath;

import java.net.URL;
import java.net.URLClassLoader;

public class LoadPath {
	public static void main(String[] args) {
        System.out.println("å¯åŠ¨ç±»çš„åŠ è½½è·¯å¾„");
        URL[] urls = sun.misc.Launcher.getBootstrapClassPath().getURLs();//Cç¼–å†™
        for (URL url : urls) {
            System.out.println(url);
        }
        System.out.println("----------------------------");
 
        //å–å¾—æ‰©å±•ç±»åŠ è½½å™¨
        URLClassLoader extClassLoader = (URLClassLoader) ClassLoader.getSystemClassLoader().getParent();
        System.out.println(extClassLoader);
        System.out.println("æ‰©å±•ç±»åŠ è½½å™¨çš„åŠ è½½è·¯å¾„ï¼š");
        urls = extClassLoader.getURLs();
        for (URL url : urls) {
            System.out.println(url);
        }
        System.out.println("----------------------------");
 
 
        //å–å¾—åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨
        URLClassLoader appClassLoader = (URLClassLoader) ClassLoader.getSystemClassLoader();
        System.out.println(appClassLoader);
        System.out.println("åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨çš„åŠ è½½è·¯å¾„ï¼š");
        urls = appClassLoader.getURLs();
        for (URL url : urls) {
            System.out.println(url);
        }
        System.out.println("----------------------------");
    }
}
```

â‘¡ç»“æœ

```
å¯åŠ¨ç±»çš„åŠ è½½è·¯å¾„
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/resources.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/rt.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/sunrsasign.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/jsse.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/jce.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/charsets.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/jfr.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/classes
----------------------------
sun.misc.Launcher$ExtClassLoader@2a139a55
æ‰©å±•ç±»åŠ è½½å™¨çš„åŠ è½½è·¯å¾„ï¼š
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/access-bridge-64.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/cldrdata.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/dhf/
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/dnsns.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/jaccess.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/jfxrt.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/localedata.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/nashorn.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/sunec.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/sunjce_provider.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/sunmscapi.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/sunpkcs11.jar
file:/D:/develop/Java/jdk1.8.0_65/jre/lib/ext/zipfs.jar
----------------------------
sun.misc.Launcher$AppClassLoader@4e0e2f2a
åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨çš„åŠ è½½è·¯å¾„ï¼š
file:/E:/JAVASE_WordSpace/MyClassLoader/bin/
----------------------------
```

#### 4.2æºç æŸ¥çœ‹éªŒè¯ç›®æ ‡è·¯å¾„

Launcherä¸ºå…¥å£

![1657542294153](assets/1657542294153.png)

![1657542358739](assets/1657542358739.png)

![1657542390967](assets/1657542390967.png)

## å››ã€è‡ªå®šä¹‰ç±»åŠ è½½å™¨

### 1.å®ç°åŸç†

**å®ç°åŸç†**æ˜¯é€šè¿‡ç±»åæ‰¾åˆ°å¯¹åº”`.class`å¯¹è±¡ï¼Œå°†`.class`å¯¹è±¡è½¬ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œæœ€ååˆ©ç”¨äºŒè¿›åˆ¶æ•°æ®ç”ŸæˆClasså¯¹è±¡

**ä»£ç å®ç°åŸç†**æ˜¯ç»§æ‰¿`ClassLoader`ç±»ï¼Œé‡å†™`loadClass()`æˆ–`findClass()`ï¼Œé‡å†™æ–¹æ³•ä¸­è°ƒç”¨çˆ¶ç±»`defineClass()`å°†äºŒè¿›åˆ¶æ•°æ®è½¬ä¸ºClasså¯¹è±¡è¿”å›

> é‡å†™loadClass()å¯èƒ½ç ´ç¯åŒäº²å§”æ´¾æœºåˆ¶

### 2.ä»£ç å®ç°

â‘ å®šä¹‰éœ€è¦è¢«è‡ªå®šä¹‰åŠ è½½å™¨åŠ è½½çš„ç±»MyTestï¼ˆE:\JVM\MyClassLoaderï¼‰

```java
public class MyTest {
    static {
        System.out.println("hello!!!");
    }
}
```

â‘¡ç¼–è¯‘MyTest.javaå¾—åˆ°.classæ–‡ä»¶

```cmd
C:\Users\CJ>e:

C:\Users\CJ>cd E:\JVM\MyClassLoader

E:\JVM\MyClassLoader>javac MyTest.java
```

â‘¢è‡ªå®šä¹‰ç±»åŠ è½½å™¨MyClassLoaderï¼ˆeclipseï¼‰

```java
import java.io.BufferedInputStream;
import java.io.ByteArrayOutputStream;
import java.io.FileInputStream;
import java.io.IOException;
 
public class MyClassLoader extends ClassLoader{
    private String byteCodePath;//è¦åŠ è½½çš„å­—èŠ‚ç æ–‡ä»¶çš„è·¯å¾„
    public MyClassLoader(String byteCodePath){
        this.byteCodePath = byteCodePath;
    }
	
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        String fileName = byteCodePath + name + ".class";//æ‹¼æ¥è¦åŠ è½½çš„å­—èŠ‚ç æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
		
        BufferedInputStream in = null;
        ByteArrayOutputStream out = null;
        try {
            in = new BufferedInputStream(new FileInputStream(fileName));//è¾“å…¥æµè¯»å–.classæ–‡ä»¶
            out = new ByteArrayOutputStream();
			
            int len = 0;
            byte[] data = new byte[1024];//1kb
            while((len = in.read(data)) != -1){
                out.write(data,0,len);
            }
            byte[] bytes = out.toByteArray();//è·å–åˆ°å­—èŠ‚ç çš„äºŒè¿›åˆ¶æµ
            Class<?> aClass = defineClass(null, bytes, 0, bytes.length);// è°ƒç”¨çˆ¶ç±»æ–¹æ³•è·å–Classå¯¹è±¡
            return aClass;
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            // é‡Šæ”¾èµ„æº
            if (in != null){
                try {
                    in.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
            if (out != null){
                try {
                    out.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        return null;
    }
}
```

â‘£å®šä¹‰æµ‹è¯•ç±»ï¼ˆeclipseï¼‰

```java
package MyClassLoader;

public class Test {
    public static void main(String[] args)throws Exception {
		//1.æ„å»ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨
        MyClassLoader myClassLoader = new MyClassLoader("E://JVM//MyClassLoader//"); //è¦åŠ è½½çš„è·¯å¾„
        //2.é€šè¿‡.classæ–‡ä»¶è·å–Classå¯¹è±¡
		Class<?> myTest = myClassLoader.findClass("MyTest");
		//æ³¨æ„ä¸»åŠ¨ä½¿ç”¨åŠ è½½å™¨åŠ è½½classæ–‡ä»¶ä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–æ–¹æ³•<clinit>()ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡åˆ›å»ºå¯¹è±¡çš„æ–¹å¼æŸ¥çœ‹é™æ€æ–¹æ³•æ˜¯å¦æ‰§è¡Œ
		Object obj = myTest.getConstructor().newInstance(null);
    }
}
```

â‘¤ç»“æœåœ¨æ§åˆ¶å°è¾“å‡º`hello!!!`

## äº”ã€åŒäº²å§”æ´¾æœºåˆ¶

### 1.ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾ï¼Ÿ

**åŒäº²å§”æ´¾æœºåˆ¶**æŒ‡å½“ç±»åŠ è½½å™¨æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼Œè¯¥ç±»åŠ è½½å™¨é¦–å…ˆä¼šæŠŠè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œåªæœ‰çˆ¶ç±»åŠ è½½å™¨åœ¨è‡ªå·±çš„æœç´¢èŒƒå›´å†…æ‰¾ä¸åˆ°æŒ‡å®šç±»æ—¶ï¼Œå­ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½

### 2.åŒäº²å§”æ´¾å·¥ä½œæµç¨‹

![1657541161575](assets/1657541161575.png)

**é¦–å…ˆåˆ¤æ–­ç±»æ˜¯å¦åŠ è½½ï¼Œè‹¥æœªåŠ è½½äº¤ç»™åŒäº²å§”æ´¾å™¨åŠ è½½**

- å½“Application ClassLoaderæ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼Œä»–é¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯å°†è¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨Extension ClassLoaderå»å®Œæˆ
- å½“Extension ClassLoaderæ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼Œä»–é¦–å…ˆä¹Ÿä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯å°†è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨Bootstrap ClassLoaderå»å®Œæˆ
- å¦‚æœBootstrap ClassLoaderåŠ è½½å¤±è´¥(åœ¨%JAVA_HOME%\libä¸­æœªæ‰¾åˆ°æ‰€éœ€ç±»)ï¼Œå°±ä¼šè®©Extension ClassLoaderå°è¯•åŠ è½½
- å¦‚æœExtension ClassLoaderä¹ŸåŠ è½½å¤±è´¥ï¼Œå°±ä¼šä½¿ç”¨Application ClassLoaderåŠ è½½

**è‹¥åŒäº²å§”æ´¾å™¨éƒ½æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œåˆ™ä½¿ç”¨è‡ªå®šä¹‰åŠ è½½å™¨å»å°è¯•åŠ è½½(`findClass()`)**

**å¦‚æœå‡åŠ è½½å¤±è´¥ï¼Œåˆ™æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸**

### 3.åŒäº²å§”æ´¾æºç 

```java
protected Class<?> loadClass(String name, boolean resolve)throws ClassNotFoundException{
        synchronized (getClassLoadingLock(name)) {
            //é¦–å…ˆæ£€æŸ¥è¿™ä¸ªclassæ˜¯å¦å·²ç»åŠ è½½è¿‡
            Class<?> c = findLoadedClass(name);
            //c==nullè¡¨ç¤ºæ²¡æœ‰åŠ è½½
            if (c == null) {
                try {
                    if (parent != null) {//å¦‚æœæœ‰çˆ¶ç±»çš„åŠ è½½å™¨åˆ™è®©çˆ¶ç±»åŠ è½½å™¨åŠ è½½
                        c = parent.loadClass(name, false);
                    } else {//å¦‚æœçˆ¶ç±»çš„åŠ è½½å™¨ä¸ºç©º åˆ™è¯´æ˜é€’å½’åˆ°bootStrapClassloaderï¼Œå› ä¸ºè¿™æ˜¯Cç¼–
                        //bootStrapClassloaderæ¯”è¾ƒç‰¹æ®Šæ— æ³•é€šè¿‡getè·å–
                        c = findBootstrapClassOrNull(name);
                    }
                } catch (ClassNotFoundException e) {}
                
                //å¦‚æœçˆ¶ç±»åŠ è½½å™¨ä»ç„¶æ²¡æœ‰åŠ è½½è¿‡ï¼Œåˆ™é€’å½’å›æ¥å°è¯•è‡ªå·±å»åŠ è½½class
                if (c == null) {
                    c = findClass(name);
                }
            }
            if (resolve) {
                resolveClass(c);
            }
            return c;
        }
    }
}
```

### 4.åŒæ¸…å§”æ´¾çš„ä½œç”¨

**ä¿è¯å®‰å…¨æ€§**ï¼šé˜²æ­¢åŠ è½½åŒä¸€ä¸ª`.class`ï¼Œé€šè¿‡å‘ä¸Šå§”æ‰˜é—®ä¸€é—®æ˜¯å¦åŠ è½½è¿‡ï¼ŒåŠ è½½è¿‡å°±ä¸ç”¨å†åŠ è½½ä¸€é

**ä¿è¯å”¯ä¸€æ€§**ï¼šæ ¸å¿ƒ`.class`ä¸èƒ½è¢«ç¯¡æ”¹ï¼Œé€šè¿‡å§”æ‰˜çš„æ–¹å¼ä¸ä¼šç¯¡æ”¹æ ¸å¿ƒ`.class`ï¼Œè¯•æƒ³è‹¥æ²¡æœ‰åŒäº²å§”æ´¾æœºåˆ¶ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½è‡ªè¡ŒåŠ è½½ï¼Œè‹¥ç”¨æˆ·ç¼–å†™äº†ä¸€ä¸ªjava.lang.Objectçš„åŒåç±»æ”¾åœ¨ClassPathä¸­ï¼Œå¤šä¸ªåŠ è½½å™¨éƒ½å»åŠ è½½Objectï¼Œå¯¼è‡´ç³»ç»Ÿä¸­Objectå„ä¸ç›¸åŒï¼Œè¿è¡Œç¨‹åºæ—¶å‡ºé”™

### 5.åŒäº²å§”æ´¾çš„æœ€å¤§é—®é¢˜

**åº•å±‚çš„ç±»åŠ è½½å™¨æ— æ³•åŠ è½½åº•å±‚çš„ç±»**ï¼Œè¿™å¥è¯å¦‚ä½•ç†è§£ï¼Œä»¥JDBCçš„DriverManagerä¸ºä¾‹ï¼Œè¯·å¾€ä¸‹çœ‹ğŸ‘‡

é¦–å…ˆäº†è§£**JDBCçš„DriverManagerä¸SPIæœºåˆ¶**ï¼ŒJDBC4.0åæ— éœ€é€šè¿‡`Class.forName()`åŠ è½½é©±åŠ¨ç±»ï¼Œåªéœ€å°†é©±åŠ¨jaræ”¾åœ¨classpathè·¯å¾„ä¸‹ï¼Œé©±åŠ¨ç±»è¢«è‡ªåŠ¨åŠ è½½ï¼Œæ˜¯ä¸æ˜¯å’ŒSpringçš„SPIæœºåˆ¶å¦‚å‡ºä¸€è¾™

**SPIæœºåˆ¶æ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ï¼Œåªéœ€å°†æ¥å£å®ç°ç±»çš„å…¨é™å®šåé…ç½®åœ¨`META-INF/services/æ¥å£å…¨é™å®šå`æ–‡ä»¶ä¸‹ï¼Œå¹¶ç”±æœåŠ¡åŠ è½½å™¨è¯»å–è¯¥æ–‡ä»¶ï¼ŒåŠ¨æ€æ›¿æ¢æ¥å£å®ç°ç±»ï¼Œå®ç°è‡ªåŠ¨åŠ è½½**

æ¯ä¸ªJDBCçš„jaråŒ…ä¸‹éƒ½æœ‰ä¸€ä¸ª`META-INF/services`ç›®å½•ï¼Œå…¶ä¸­å«`java.sql.Driver`æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸­æŒ‡å®šäº†`Driver`çš„å®ç°ç±»å…¨é™å®šåï¼Œæœ‰äº†SPIæœºåˆ¶ï¼Œåªéœ€é€šè¿‡å¦‚ä¸‹ä»£ç å¯è·å–å¯¹åº”JDBCè¿æ¥ï¼Œè€Œæ— éœ€æŒ‡å®šMySqlè¿˜æ˜¯Oracleçš„é©±åŠ¨

```java
Connection con = DriverManager.getConnection(url,username,password);
```

ä½†æ˜¯ï¼ŒDriverManageræœ¬èº«å­˜åœ¨äº`jre/lib/rt.jar`ï¼Œå±äºBootstrap ClassLoaderï¼ŒåŒæ—¶DriverManagerä¼šåŠ è½½æ¯ä¸ªDriveræ¥å£çš„å®ç°ç±»å¹¶ç®¡ç†ä»–ä»¬ï¼Œè€ŒDriveræ¥å£çš„å®ç°ç±»(å¦‚`MySql Driver`)å­˜äº`classpath`ä¸‹ï¼Œå±äºApplication ClassLoaderï¼Œæ˜¾ç„¶åœ¨Bootstrap ClassLoaderä¸­æ— æ³•åŠ è½½Driveræ¥å£çš„å®ç°ç±»ï¼Œè¿™å°±æ˜¯**åº•å±‚ç±»åŠ è½½å™¨æ— æ³•åŠ è½½åº•å±‚çš„ç±»**ï¼Œå› æ­¤åªèƒ½åœ¨DriverManagerä¸­**å¼ºè¡ŒæŒ‡å®šä¸‹å±‚ç±»åŠ è½½å™¨**åŠ è½½Driverå®ç°ç±»ï¼Œè¿™å°†**æ‰“ç ´åŒäº²å§”æœºåˆ¶**

é€šè¿‡æŸ¥çœ‹DriverManageræºç å‘ç°ä½¿ç”¨ç”±å¯åŠ¨ç±»åŠ è½½çš„DriverManageræ—¶è§¦å‘å™¨staticå—ï¼Œè¿›è€ŒåŠ è½½`META-INF/services/java.sql.Driver`æŒ‡å®šçš„ç±»

```java
static {
    loadInitialDrivers();//è¿›å…¥è¯¥æ–¹æ³•
    println("JDBC DriverManager initialized");
}
```

```java
private static void loadInitialDrivers() {
    AccessController.doPrivileged(new PrivilegedAction<Void>() {//AccessControllerï¼šJavaå®‰å…¨æ¨¡å‹
        public Void run() {
            //æ¥ä¸‹æ¥è¿™ä¸€æ­¥æ˜¯æ ¸å¿ƒ***
            ServiceLoader<Driver> loadedDrivers = ServiceLoader.load(Driver.class);//ServiceLoaderå°±æ˜¯JDKæä¾›çš„SPIçš„å®ç°æ–¹å¼ï¼Œè¿›å…¥è¯¥æ–¹æ³•
            Iterator<Driver> driversIterator = loadedDrivers.iterator();//å°†æ‰«æåˆ°çš„Driverå®ç°ç±»è£…å…¥è¿­ä»£å™¨
            try{
                while(driversIterator.hasNext()) {
                    driversIterator.next();//éå†æ¯ä¸ªDriverå®ç°ç±»ï¼Œå¹¶è§¦å‘æ¯ä¸ªDriverå®ç°ç±»çš„åŠ è½½
                }
            } catch(Throwable t) {
              // Do nothing
            }
            return null;
        }
    });
}
```

```java
public static <S> ServiceLoader<S> load(Class<S> service) {
    //è·å–ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ŒContextClassLoaderæ ¹æ®é…ç½®åŠ è½½å¯¹åº”çš„ç±»
    ClassLoader cl = Thread.currentThread().getContextClassLoader();
    return ServiceLoader.load(service, cl);
}
```

ä»€ä¹ˆæ˜¯ContextClassLoaderï¼Ÿå¦‚ä»£ç æ‰€ç¤ºï¼Œ`sun.misc.Launcher`åˆå§‹åŒ–æ—¶ï¼ŒåŠ è½½AppClassLoaderèµ‹å€¼ç»™`this.loader`ï¼Œ`this.loader`è¢«è®¾ç½®ç»™ContextClassLoaderï¼Œå› æ­¤`Thread.currentThread().getContextClassLoader()`é»˜è®¤è·å–çš„å°±æ˜¯AppClassLoaderï¼Œå½“ç„¶å¼€å‘è€…å¯è‡ªè¡Œæ›´æ”¹

```java
public Launcher() {
    ...
    try {
        this.loader = Launcher.AppClassLoader.getAppClassLoader(var1);
    } catch (IOException var9) {
        throw new InternalError("Could not create application class loader", var9);
    }
    Thread.currentThread().setContextClassLoader(this.loader);
    ...
}
```

> å‚è€ƒæ–‡ç« ï¼š[JDBCçš„SPIåŠ è½½æ–¹å¼](https://blog.csdn.net/syh121/article/details/120274044)

### 6.ç ´ååŒäº²å§”æ´¾çš„åœºæ™¯

åŒäº²å§”æ´¾æ¨¡å¼æ˜¯é»˜è®¤çš„æ¨¡å¼ï¼Œä½†å¹¶éå¿…é¡»ï¼Œä»¥ä¸‹åœºæ™¯ç ´ååŒäº²å§”æ´¾

* **é‡å†™ClassLoaderçš„loadClass()**ï¼Œå› ä¸ºåŒäº²å§”æ´¾çš„å®ç°ä»£ç åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œä¾‹å¦‚**Tomcatçš„WebappClassLoader**ï¼ŒWebappClassLoaderé‡å†™`loadClass()`ï¼Œå…ˆåŠ è½½è‡ªå·±çš„Classï¼Œæ‰¾ä¸åˆ°å†å§”æ‰˜Parentï¼Œè¿™æ ·åšæœ‰ä»€ä¹ˆå®é™…æ„ä¹‰å‘¢ï¼Ÿä¸ƒä¸­è®²è§£ğŸ˜˜

- **JDBCã€Dubboã€Eleasticsearchçš„SPIæœºåˆ¶**ï¼Œæœ¬èŠ‚5ä¸­è¯¦ç»†è®²è§£åˆ°JDBCæ˜¯å¦‚ä½•ç ´åçš„
- OSGi(Karaf)çš„ClassLoaderå½¢æˆç½‘çŠ¶ç»“æ„ï¼Œæ ¹æ®éœ€è¦è‡ªç”±åŠ è½½Class

## å…­ã€ç±»åŠ è½½å™¨ç¡®ä¿ç±»åœ¨JVMä¸­çš„å”¯ä¸€æ€§

### 1.ç±»åŠ è½½å™¨å¦‚ä½•ç¡®ä¿ç±»åœ¨JVMä¸­çš„å”¯ä¸€æ€§ï¼Ÿ

ä¹¦ä¸­è¿™æ ·è¯´é“ğŸ‘‡

> å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®ç«‹å…¶åœ¨Javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§ï¼Œæ¯ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œéƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åç§°ç©ºé—´

ä¹Ÿå°±æ˜¯è¯´æ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦ç›¸ç­‰ï¼Œåªæœ‰åœ¨è¿™ä¸¤ä¸ªç±»è¢«åŒä¸€ç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¸‹æ‰æœ‰æ„ä¹‰ï¼Œå³**ç±»+ç±»åŠ è½½å™¨æ‰å”¯ä¸€ç¡®å®šä¸€ä¸ªJavaç±»**

### 2.ä¸¤ä¸ªç±»æ¥è‡ªåŒä¸€Classæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªJVMåŠ è½½ï¼Œè¿™ä¸¤ä¸ªç±»ä¸€å®šç›¸ç­‰å—ï¼Ÿ

ä¸ä¸€å®šï¼Œè¿˜éœ€è¦åˆ¤æ–­è¿™ä¸¤ä¸ªç±»æ˜¯å¦å±äºåŒä¸€ä¸ªç±»åŠ è½½å™¨

> æ­¤å¤„çš„ç›¸ç­‰åŒ…æ‹¬Classçš„equals()ã€isAssignableFrom()ã€isInstance()æ–¹æ³•çš„è¿”å›ç»“æœä¸instanceofå…³é”®å­—çš„åˆ¤æ–­ç»“æœ

â‘ ç¼–å†™æµ‹è¯•ä»£ç 

```java
package OnlyClassLoader;

import java.io.IOException;
import java.io.InputStream;

public class OnlyClassLoaderTest {
	public static void main(String[] args) throws Exception {
		ClassLoader myLoader = new ClassLoader() {
            @Override
            public Class<?> loadClass(String name) throws ClassNotFoundException {
                try {
                    String fileName=name.substring(name.lastIndexOf(".")+1)+".class";
                    InputStream is=getClass().getResourceAsStream(fileName);
                    if( is == null ){
                        return super.loadClass(name);
                    }
                    byte[] bytes = new byte[is.available()];
                    is.read(bytes); //é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨è¯»å–classæ–‡ä»¶çš„äºŒè¿›åˆ¶æµ
                    return defineClass(name, bytes, 0,bytes.length);
                    
                } catch (IOException e) {
                    e.printStackTrace();
                    throw new ClassNotFoundException(name);
                }
            }
        };
        
        Object obj = myLoader.loadClass("OnlyClassLoader.OnlyClassLoaderTest").newInstance();
        System.out.println(obj.getClass());
        System.out.println(OnlyClassLoaderTest.class);
        System.out.println("------------------------");
        System.out.println("equalsï¼š"+OnlyClassLoaderTest.class.equals(obj));
        System.out.println("isAssignableFromï¼š"+OnlyClassLoaderTest.class.isAssignableFrom(obj.getClass()));
        System.out.println("isInstanceï¼š"+OnlyClassLoaderTest.class.isInstance(obj));
        System.out.println(obj instanceof OnlyClassLoaderTest);
        System.out.println("------------------------");
        System.out.println(OnlyClassLoaderTest.class.getClassLoader());
        System.out.println(obj.getClass().getClassLoader());
	}
}
```

â‘¡è¾“å‡ºç»“æœ

```
class OnlyClassLoader.OnlyClassLoaderTest
class OnlyClassLoader.OnlyClassLoaderTest
//è¿™è¡¨æ˜objå¯¹è±¡ç¡®å®æ˜¯OnlyClassLoader.OnlyClassLoaderTestå®ä¾‹å‡ºæ¥çš„å¯¹è±¡ï¼Œæ¥è‡ªåŒä¸€ä¸ªClassæ–‡ä»¶
------------------------
equalsï¼šfalse
isAssignableFromï¼šfalse
isInstanceï¼šfalse
false
//è¿”å›falseæ˜¯å› ä¸ºè™šæ‹Ÿæœºä¸­å­˜åœ¨ä¸¤ä¸ªOnlyClassLoaderTestç±»ï¼Œä¸€ä¸ªç”±åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨åŠ è½½ï¼Œå¦ä¸€ä¸ªç”±è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½ï¼Œè™½ç„¶äºŒè€…éƒ½æ¥è‡ªåŒä¸€Classæ–‡ä»¶ï¼Œä½†ä¾ç„¶æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç±»ï¼Œåšå¯¹è±¡æ‰€å±ç±»å‹æ£€æŸ¥æ—¶ç»“æœè‡ªç„¶ä¸ºfalse
------------------------
sun.misc.Launcher$AppClassLoader@4e0e2f2a
OnlyClassLoader.OnlyClassLoaderTest$1@6d06d69c
```

## ä¸ƒã€Tomcatçš„ç±»åŠ è½½å™¨

### 1.ä¸ºä»€ä¹ˆTomcatéœ€è¦è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Ÿ

å¦‚æœTomcatç±»åŠ è½½å™¨æœºåˆ¶å’ŒåŒäº²å§”æ´¾æœºåˆ¶ä¸€æ ·ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

- **ä¸¤ä¸ªåŒåç±»æ— æ³•è¢«åŒºåˆ†**ï¼šTomcatçš„webappsç›®å½•ä¸‹æœ‰ä¸¤ä¸ªåº”ç”¨ï¼Œåˆ†åˆ«å¼•å…¥ç¬¬ä¸‰æ–¹jarï¼štool-1.0.jarå’Œtool-2.0.jarï¼Œè™½ç„¶jarçš„ç‰ˆæœ¬ä¸åŒï¼Œä½†ä¸¤ä¸ªjarä¸­éƒ½æœ‰MyTool.javaç±»ï¼Œè‹¥ä¸¥æ ¼æŒ‰ç…§åŒäº²å§”æ´¾æœºåˆ¶å¯èƒ½å¯¼è‡´ä¸¤ä¸ªåº”ç”¨ä¸­åªæœ‰ä¸€ä¸ªç±»ä¼šè¢«åŠ è½½ï¼Œå¦ä¸€ä¸ªå·²ç»åŠ è½½è¿‡(å…¨è·¯å¾„+ç±»åŠ è½½å™¨ç›¸åŒ)å¯¼è‡´ä¸ä¼šè¢«åŠ è½½ï¼Œæ‰€ä»¥**è¦ä¿è¯é¡¹ç›®å½¼æ­¤éš”ç¦»**
- **åŒä¸€ä¸ªç±»è¢«å¤šæ¬¡åŠ è½½**ï¼šä¸¤ä¸ªé¡¹ç›®éƒ½ä¾èµ–Springï¼Œå½“Springçš„jarè¢«åŠ è½½åˆ°å†…å­˜åï¼Œä¸¤ä¸ªé¡¹ç›®éƒ½åŠ è½½ä¸€æ¬¡Springçš„jarï¼Œé€ æˆèµ„æºæµªè´¹ï¼Œæ‰€ä»¥**è¦ä¿è¯é¡¹ç›®é—´èƒ½å…±äº«èµ„æº**
- **Tomcatæœ¬èº«æœ‰ç±»ï¼Œéœ€è¦å’Œé¡¹ç›®çš„ç±»è¿›è¡Œéš”ç¦»**

â‘ ç¼–å†™ä¸¤ä¸ªMyTool

```java
package com.yc.MyTool;

class MyTool{	
	public static void say(){
		System.out.println("hello");
	}
	public static void main(String[] args) {
		say();
	}
}
```

```java
package com.yc.MyTool;

public class MyTool {
	public static void say(){
		System.out.println("world");
	}
	public static void main(String[] args) {
		say();
	}
}
```

â‘¡å°†ä¸¤ä¸ªToolæ‰“æˆjar

![1657593073891](assets/1657593073891.png)

![1657593344749](assets/1657593344749.png)

â‘¢åˆ›å»ºæ™®é€šJavaé¡¹ç›®ï¼Œç¼–å†™æµ‹è¯•ä»£ç ï¼Œå¯¼å…¥ä¸¤ä¸ªjarï¼Œå‘ç°æ°¸è¿œåªè¾“å‡ºhello

```
package MyToolTest;

import com.yc.MyTool.MyTool;

public class Test {
	public static void main(String[] args) {
		MyTool tool = new MyTool();
		tool.say();
	}
}
```

### 2.Tomcatçš„ç±»åŠ è½½å™¨ç§ç±»

ä¸‰ä¸ªåŸºç¡€ç±»åŠ è½½å™¨+æ¯ä¸ªwebåº”ç”¨çš„webç±»åŠ è½½å™¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸‰ä¸ªåŸºç¡€ç±»åŠ è½½å™¨éƒ½æ˜¯åŒä¸€ä¸ª(Common)

![1657586925535](assets/1657586925535.png)

**Common ClassLoader**ï¼š çˆ¶ç±»åŠ è½½å™¨æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œæ˜¯Tomcaté¡¶å±‚çš„å…¬ç”¨ç±»åŠ è½½å™¨ï¼Œè·¯å¾„ä¸ºcommon.loaderï¼Œ**è´Ÿè´£åŠ è½½Tomcatæœ¬èº«çš„ç±»å’ŒWebåº”ç”¨éƒ½éœ€è¦çš„ç±»ï¼Œå¦‚Servletè§„èŒƒåŒ…ç­‰**

**Catalina ClassLoader**ï¼šçˆ¶ç±»åŠ è½½å™¨æ˜¯CommonåŠ è½½å™¨ï¼Œè·¯å¾„ä¸ºserver.loader(é»˜è®¤ä¸ºç©º)ï¼Œ**ç›®çš„æ˜¯éš”ç¦»Tomcatæœ¬èº«çš„ç±»å’ŒWebé¡¹ç›®çš„ç±»ï¼Œè´Ÿè´£åŠ è½½Tomcatåº”ç”¨ç±»ï¼Œå¯¹Webåº”ç”¨ä¸å¯è§(è§£è€¦åˆ)**

> è‹¥éœ€è¦å…±äº«é‡‡ç”¨çˆ¶å­å…³ç³»ï¼Œè‹¥éœ€è¦éš”ç¦»é‡‡ç”¨å¹³è¡Œå…³ç³»

**Shared ClassLoader**ï¼š çˆ¶ç±»åŠ è½½å™¨æ˜¯CommonåŠ è½½å™¨ï¼ŒShared ClassLoaderä½œä¸ºWebApp ClassLoaderçš„çˆ¶åŠ è½½å™¨ï¼Œè·¯å¾„ä¸ºshared.loader(é»˜è®¤ä¸ºç©º)ï¼Œ**è´Ÿè´£åŠ è½½Webåº”ç”¨å…±äº«çš„ç±»ï¼Œå¯¹TomcatæœåŠ¡å™¨ä¸å¯è§**

**WebApp ClassLoader**ï¼šçˆ¶ç±»åŠ è½½å™¨æ˜¯SharedåŠ è½½å™¨ï¼ŒåŠ è½½/WEB-INF/classesç›®å½•ä¸‹æœªå‹ç¼©çš„Classå’Œèµ„æºæ–‡ä»¶ä»¥åŠ/WEB-INF/libä¸‹çš„jaråŒ…ï¼Œ**ç›®çš„æ˜¯éš”ç¦»Webåº”ç”¨ï¼ŒåŒºåˆ†ç±»åç›¸åŒçš„ç±»ï¼Œå› ä¸ºè¿™äº›ç±»æ‰€å±çš„ç±»åŠ è½½å™¨ä¸åŒ**

### 3.Tomcatç±»åŠ è½½å™¨è®¾è®¡ä¼˜ç‚¹

**å…±äº«æ€§**ï¼šCommon ClassLoaderä¸Shared ClassLoader

**éš”ç¦»æ€§**ï¼šCatalina ClassLoaderä¸WebApp ClassLoader

## å…«ã€çƒ­æ›¿æ¢

### 1.ä»€ä¹ˆæ˜¯çƒ­æ›¿æ¢ï¼Ÿ

**çƒ­æ›¿æ¢**ï¼šåœ¨ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹æ›´æ”¹çš„ä»£ç ç”Ÿæ•ˆï¼Œçƒ­æ›¿æ¢å¯ä»¥æå‡å¼€å‘ä»¥åŠè°ƒè¯•çš„æ•ˆç‡ï¼ŒåŸºäºJavaç±»åŠ è½½å™¨å®ç°ï¼Œçƒ­åŠ è½½çš„ä¸å®‰å…¨æ€§å¯¼è‡´å…¶ä¸€èˆ¬ä¸ä¼šç”¨äºæ­£å¼çš„ç”Ÿäº§ç¯å¢ƒ

### 2.çƒ­æ›¿æ¢æ¡ˆä¾‹

é€šè¿‡**è‡ªå®šä¹‰ç±»åŠ è½½å™¨**å®ç°

â‘ è¢«åŠ¨æ€æ›¿æ¢çš„ç±»

```java
package HotReplace;

public class Demo {
	public void hot() {
        System.out.println("OldDemo1"); // A:old class print
        //System.out.println("NewDemo1"); // B:new class print
    }
}
```

â‘¡è‡ªå®šä¹‰ç±»åŠ è½½å™¨MyClassLoader

```java
package HotReplace;

import java.io.BufferedInputStream;
import java.io.ByteArrayOutputStream;
import java.io.FileInputStream;
import java.io.IOException;
 
public class MyClassLoader extends ClassLoader{
    private String byteCodePath;//è¦åŠ è½½çš„å­—èŠ‚ç æ–‡ä»¶çš„è·¯å¾„
    public MyClassLoader(String byteCodePath){
        this.byteCodePath = byteCodePath;
    }
	
    @Override
    public Class<?> findClass(String name) throws ClassNotFoundException {
        String fileName = byteCodePath + name + ".class";//æ‹¼æ¥è¦åŠ è½½çš„å­—èŠ‚ç æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
		
        BufferedInputStream in = null;
        ByteArrayOutputStream out = null;
        try {
            in = new BufferedInputStream(new FileInputStream(fileName));//è¾“å…¥æµè¯»å–.classæ–‡ä»¶
            out = new ByteArrayOutputStream();
			
            int len = 0;
            byte[] data = new byte[1024];//1kb
            while((len = in.read(data)) != -1){
                out.write(data,0,len);
            }
            byte[] bytes = out.toByteArray();//è·å–åˆ°å­—èŠ‚ç çš„äºŒè¿›åˆ¶æµ
            Class<?> aClass = defineClass(null, bytes, 0, bytes.length);// è°ƒç”¨çˆ¶ç±»æ–¹æ³•è·å–Classå¯¹è±¡
            return aClass;
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            // é‡Šæ”¾èµ„æº
            if (in != null){
                try {
                    in.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
            if (out != null){
                try {
                    out.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        return null;
    }
}
```

â‘¢æµ‹è¯•ç±»

```java
package HotReplace;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import MyClassLoader.MyClassLoader;

public class Test {
	public static void main(String[] args) throws ClassNotFoundException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, NoSuchMethodException, SecurityException {
		while (true) {
            try {
            	//1.æ„å»ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨
                MyClassLoader myClassLoader = new MyClassLoader("E://JAVASE_WordSpace//MyClassLoader//bin//HotReplace//"); //è¦åŠ è½½çš„è·¯å¾„
                //2.é€šè¿‡.classæ–‡ä»¶è·å–Classå¯¹è±¡
        		Class<?> myTest = myClassLoader.findClass("Demo");
        		//3.åˆ›å»ºè¿è¡Œæ—¶ç±»çš„å®ä¾‹
        		Object demo = myTest.getConstructor().newInstance(null);
        		//4.è·å–è¿è¡Œæ—¶ç±»ä¸­æŒ‡å®šçš„æ–¹æ³•
        		Method m = myTest.getMethod("hot");
        		// 5. è°ƒç”¨æŒ‡å®šçš„æ–¹æ³•
                m.invoke(demo);
                
                Thread.sleep(5000);
            } catch (Exception e) {
                System.out.println("not find");
                try {
                    Thread.sleep(5000);
                } catch (InterruptedException ex) {
                    ex.printStackTrace();
                }
            }
        }
	}
}
```

â‘£æ”¾å¼€Demoä¸­çš„ç¬¬ä¸€å¥ï¼Œè¿è¡ŒTestï¼Œéš”ä¸€æ®µæ—¶é—´å†æ”¾å¼€Demoä¸­çš„ç¬¬äºŒå¥ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹

```
OldDemo1
OldDemo1
NewDemo1
```

## ä¹ã€JVMé˜²æ­¢éå­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°JVM

### 1.å­—èŠ‚ç æ–‡ä»¶è¯¦è§£

ä»¥ä¸‹æ˜¯å­—èŠ‚ç æ–‡ä»¶ç»“æ„ï¼Œ**u4è¡¨ç¤ºæ¯é¡¹æ•°æ®å 4å­—èŠ‚ï¼Œu2è¡¨ç¤ºæ²¡é¡¹æ•°æ®å 2å­—èŠ‚**

```java
ClassFile {
    u4             magic;//Classæ–‡ä»¶çš„å¼€å¤´å››ä¸ªå­—èŠ‚ï¼Œå­˜æ”¾é­”æœ¯å­—ï¼Œè‹¥é­”æœ¯å­—æ˜¯0xcafebabeåˆ™æ˜¯Classæ–‡ä»¶
    //é€šè¿‡ä¸»æ¬¡ç‰ˆæœ¬å·å¯ä»¥æŒ‰å­—å…¸é¡ºåºå¯¹ç±»æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬è¿›è¡Œæ’åº
    u2             minor_version;//æ¬¡ç‰ˆæœ¬å·
    u2             major_version;//ä¸»ç‰ˆæœ¬å·
    u2             constant_pool_count;
    cp_info        constant_pool[constant_pool_count-1];
    u2             access_flags;
    u2             this_class;
    u2             super_class;
    u2             interfaces_count;
    u2             interfaces[interfaces_count];
    u2             fields_count;
    field_info     fields[fields_count];
    u2             methods_count;
    method_info    methods[methods_count];
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}
```

> æ­¤å¤„ä¸è¯¦ç»†è®²è§£ClassFileæ¯é¡¹çš„å«ä¹‰ï¼Œè´´å‡º[å‚åŠ æ–‡ç« ](https://blog.csdn.net/m0_45270667/article/details/108884081)ä¸€æšï¼Œæœ‰æ—¶é—´å†æ¥çœ‹çœ‹

é€šè¿‡æŸ¥çœ‹ClassFileæ–‡ä»¶ç»“æ„å¯çŸ¥ï¼Œ**JVMé€šè¿‡é­”æœ¯å­—(CA FE BA BE)è¯†åˆ«éå­—èŠ‚ç æ–‡ä»¶**

### 2.æŸ¥çœ‹ClassFileæ–‡ä»¶

â‘ ç¼–å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ä»£ç 

```java
class Hello{
	public static void main(String []args){
		System.out.println("hello");
	}
}
```

â‘¡ç”Ÿæˆå­—èŠ‚ç ï¼š`javac Hello.java`

â‘¢PowerShellçª—å£è¾“å…¥`format-hex Hello.class`

![1657613686434](assets/1657613686434.png)

## åã€æ¡ˆä¾‹æ¢ç©¶

### 1.è¯•ä»JVMå±‚é¢åˆ†æä»¥ä¸‹ä»£ç è¿è¡Œæ—¶å€¼å˜åŒ–è¿‡ç¨‹

#### 1.1.åˆ†ænum,numberçš„å€¼å˜åŒ–è¿‡ç¨‹

```java
public class Test01 {
	private static int num = 2;
	private static int number = 10;
	
	static {
        number = 20;
        System.out.println(num);
    }

    public static void main(String[] args) {
        System.out.println(Test01.num);
        System.out.println(Test01.number);
    }
}
```

```
1.Linkingä¹‹å‡†å¤‡é˜¶æ®µä¼šä¸ºnum,numberåˆ†é…å†…å­˜å¹¶èµ‹å€¼ä¸ºé»˜è®¤å€¼ï¼Œé¡ºåºæ‰§è¡Œä»£ç 
	num = 0,number = 0
2.åˆå§‹åŒ–é˜¶æ®µä¼šæ‰§è¡Œç±»ç±»åˆå§‹åŒ–æ–¹æ³•<clinit>()ï¼Œåˆå§‹åŒ–staticï¼Œé¡ºåºæ‰§è¡Œä»£ç 
	num = 2,number = 10,static{number = 20,è¾“å‡º2}
3.ä½¿ç”¨é˜¶æ®µè¾“å‡º2å’Œ20
```

#### 1.2.åˆ†æx,yçš„å€¼å˜åŒ–è¿‡ç¨‹

```java
public class Test02 {
	public static void main(String[] args) {
        Singleton s = Singleton.getInstance();
        System.out.println(Singleton.x + "  " + Singleton.y);
    }
}

class Singleton {
    //private static Singleton singleton = new Singleton();

    public static int x = 0;
    public static int y;

    //private static Singleton singleton = new Singleton();

    private Singleton() {
        x++;
        y++;
    }

    public static Singleton getInstance() {
        return singleton;
    }
}
```

æ”¾å¼€ç¬¬ä¸€å¥æ³¨è§£

```
1.Test02ç»è¿‡åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–åç»ˆäºåˆ°è¾¾ä½¿ç”¨é˜¶æ®µï¼Œæ‰§è¡Œmainä¸­æ–¹æ³•(Test02æ²¡æœ‰static)ï¼Œmainæ–¹æ³•ä¸­ä½¿ç”¨Singletonï¼Œæ¥ä¸‹æ¥åŠ è½½mainæ–¹æ³•ä¸­ä½¿ç”¨Singletonç±»
2.Linkingä¹‹å‡†å¤‡é˜¶æ®µä¼šä¸ºsingleton,x,yåˆ†é…å†…å­˜å¹¶èµ‹å€¼ä¸ºé»˜è®¤å€¼ï¼Œé¡ºåºæ‰§è¡Œä»£ç 
	singleton = null,x = 0,y = 0
3.åˆå§‹åŒ–é˜¶æ®µä¼šæ‰§è¡Œç±»ç±»åˆå§‹åŒ–æ–¹æ³•<clinit>()ï¼Œåˆå§‹åŒ–staticï¼Œé¡ºåºæ‰§è¡Œä»£ç 
	singletonè¢«newæ‰€ä»¥æ‰§è¡Œå…¶æ„é€ æ–¹æ³•{x = 1,y = 1},x = 0
4.ä½¿ç”¨é˜¶æ®µè¾“å‡º0å’Œ1
```

æ”¾å¼€ç¬¬äºŒå¥æ³¨è§£

```
1.Test02ç»è¿‡åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–åç»ˆäºåˆ°è¾¾ä½¿ç”¨é˜¶æ®µï¼Œæ‰§è¡Œmainä¸­æ–¹æ³•(Test02æ²¡æœ‰static)ï¼Œmainæ–¹æ³•ä¸­ä½¿ç”¨Singletonï¼Œæ¥ä¸‹æ¥åŠ è½½mainæ–¹æ³•ä¸­ä½¿ç”¨Singletonç±»
2.Linkingä¹‹å‡†å¤‡é˜¶æ®µä¼šä¸ºx,y,singletonåˆ†é…å†…å­˜å¹¶èµ‹å€¼ä¸ºé»˜è®¤å€¼ï¼Œé¡ºåºæ‰§è¡Œä»£ç 
	x = 0,y = 0,singleton = null
3.åˆå§‹åŒ–é˜¶æ®µä¼šæ‰§è¡Œç±»ç±»åˆå§‹åŒ–æ–¹æ³•<clinit>()ï¼Œåˆå§‹åŒ–staticï¼Œé¡ºåºæ‰§è¡Œä»£ç 
	x = 0,singletonè¢«newæ‰€ä»¥æ‰§è¡Œå…¶æ„é€ æ–¹æ³•{x = 1,y = 1}
4.ä½¿ç”¨é˜¶æ®µè¾“å‡º1å’Œ1
```

### 2.è¾“å‡ºç±»åŠ è½½å™¨çš„åç§°

```java
public class ClassLoaderTest {
    public static void main(String[] args) {
    	ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();
    	System.out.println(systemClassLoader);
    	
    	ClassLoader extClassLoader = systemClassLoader.getParent();
    	System.out.println(extClassLoader);
    	
    	ClassLoader bootstrapClassLoader = extClassLoader.getParent();
    	System.out.println(bootstrapClassLoader);
    	
    	ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();
    	System.out.println(classLoader);
    	
    	ClassLoader classLoader1 = String.class.getClassLoader();
    	System.out.println(classLoader1);
	}
}
```

```
sun.misc.Launcher$AppClassLoader@4e0e2f2a
sun.misc.Launcher$ExtClassLoader@2a139a55
null	//å¯åŠ¨ç±»åŠ è½½å™¨ç”±C++ç¼–å†™ï¼Œé€šè¿‡getParent()è·å–ä¸åˆ°
sun.misc.Launcher$AppClassLoader@4e0e2f2a
null	//Stringå±äºå¯åŠ¨ç±»åŠ è½½å™¨
```

### 3.å››ç§è·å–ClassLoaderçš„é€”å¾„æµ‹è¯•

```java
public class Test04 {
	public static void main(String[] args) {
        try {        
            //1.è·å–å½“å‰ç±»çš„ClassLoaderï¼šClass.forName().getClassLoader()
            ClassLoader classLoader1 = Class.forName("java.lang.String").getClassLoader();
            System.out.println(classLoader1);//Stringç±»ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ï¼Œæˆ‘ä»¬æ— æ³•è·å–
            
	        //2.è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ClassLoaderï¼šThread.currentThread().getContextClassLoader()
	        ClassLoader classLoader2 = Thread.currentThread().getContextClassLoader();
	        System.out.println(classLoader2);
	
	        //3.è·å–ç³»ç»Ÿçš„ClassLoaderï¼šClassLoader.getSystemClassLoader().getParent()
	        ClassLoader classLoader3 = ClassLoader.getSystemClassLoader();
	        System.out.println(classLoader3);
	        
	        //4.è·å–è°ƒç”¨è€…çš„ClassLoaderï¼šDriverManager.getCallerClassLoader()
	        //ClassLoader classLoader4 = DriverManager.getCallerClassLoader()
	        //System.out.println(classLoader4);
	    } catch (ClassNotFoundException e) {
	        e.printStackTrace();
	    }
	}
}
```

```
null
sun.misc.Launcher$AppClassLoader@4e0e2f2a
sun.misc.Launcher$AppClassLoader@4e0e2f2a
```

### 4.æµ‹è¯•åŒäº²å§”æ´¾ä¿è¯å”¯ä¸€æ€§

â‘ åˆ›å»ºStringç±»

```java
package java.lang;

public class String {
	static{
        System.out.println("æˆ‘æ˜¯è‡ªå®šä¹‰çš„Stringç±»çš„é™æ€ä»£ç å—");
    }
}
```

â‘¡ç¼–å†™StringTestç±»

```java
public class StringTest {
	public static void main(String[] args) {
        java.lang.String str = new java.lang.String();
	}
}
```

â‘£ç»“æœæŠ¥é”™

```java
Exception in thread "main" java.lang.SecurityException: Prohibited package name: java.lang
	at java.lang.ClassLoader.preDefineClass(ClassLoader.java:659)
	at java.lang.ClassLoader.defineClass(ClassLoader.java:758)
	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)
	at java.net.URLClassLoader.defineClass(URLClassLoader.java:467)
	at java.net.URLClassLoader.access$100(URLClassLoader.java:73)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:368)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:362)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.net.URLClassLoader.findClass(URLClassLoader.java:361)
	at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)
	at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
	at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:495)
```

â‘¤ä¿®æ”¹Stringç±»

```java
package java.lang;

public class String {
	static{
        System.out.println("æˆ‘æ˜¯è‡ªå®šä¹‰çš„Stringç±»çš„é™æ€ä»£ç å—");
    }
	
	public static void main(String[] args) {
        System.out.println("hello,String");
    }
}
```

â‘¥ç»“æœåŒæ ·æŠ¥é”™

```java
Exception in thread "main" java.lang.SecurityException: Prohibited package name: java.lang
	at java.lang.ClassLoader.preDefineClass(ClassLoader.java:659)
	at java.lang.ClassLoader.defineClass(ClassLoader.java:758)
	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)
	at java.net.URLClassLoader.defineClass(URLClassLoader.java:467)
	at java.net.URLClassLoader.access$100(URLClassLoader.java:73)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:368)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:362)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.net.URLClassLoader.findClass(URLClassLoader.java:361)
	at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)
	at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
	at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:495)
```

> **SecurityException**æ˜¯å®‰å…¨å¼‚å¸¸ï¼Œè¿™ç§æœºåˆ¶å«æ²™ç®±å®‰å…¨æœºåˆ¶ï¼Œä»€ä¹ˆæ˜¯æ²™ç®±(sendbox)å®‰å…¨æœºåˆ¶ï¼Ÿ
>
> æ²™ç®±æŒ‡ä¸€ä¸ªé™åˆ¶ç¨‹åºè¿è¡Œçš„ç¯å¢ƒï¼Œæ²™ç®±æœºåˆ¶æŒ‡å°†Javaä»£ç é™å®šåœ¨JVMç‰¹å®šè¿è¡ŒèŒƒå›´å†…ï¼Œé˜²æ­¢æœ¬åœ°ç³»ç»Ÿè¢«ç ´å

â‘¦å°è¯•åœ¨java.langä¸‹å®šä¹‰è‡ªå·±çš„ç±»MyClass

```java
package java.lang;

public class MyClass {
	public static void main(String[] args) {
        System.out.println("hello!");
    }
}
```

â‘§Error åˆå§‹åŒ–æœŸé—´å‡ºé”™

```java
Error occurred during initialization of VM
Unable to allocate 64320KB bitmaps for parallel garbage collection for the requested 2058240KB heap.
```

