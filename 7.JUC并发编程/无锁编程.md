# æ— é”ç¼–ç¨‹

## ä¸€ã€é—®é¢˜å¼•å…¥

ä¸ºä»€ä¹ˆä¼šå‡ºç°CASå‘¢ï¼Ÿå½“ç„¶æ˜¯å‡ºç°é—®é¢˜è§£å†³é—®é¢˜äº†

`synchronized`æ˜¯é˜»å¡å¼é”ï¼Œå­˜åœ¨å¤§é‡é—®é¢˜ï¼Œå¦‚é˜»å¡å¼é”å¯¼è‡´CPUå”¤é†’æ“ä½œåŠ å¤§å¼€é”€ï¼›ä¸å­˜åœ¨é”ä¸­æ–­æœºåˆ¶ï¼›è‹¥æ‹¿åˆ°é”çš„çº¿ç¨‹ä¸€ç›´ä¸é‡Šæ”¾é”æ€ä¹ˆè§£å†³ï¼Ÿå³æ²¡æœ‰é”è¶…æ—¶æœºåˆ¶ï¼›éå…¬å¹³é”é€ æˆå¤§é‡çš„èµ„æºç«äº‰ï¼ŒåŒæ—¶è¿˜æœ‰å¯èƒ½é€ æˆæ­»é”ç­‰å…¶ä»–å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥åæ¥å‡ºç°äº†`volatile`

`volatile`å¯ä»¥ä¿è¯å¯è§æ€§ä¸æœ‰åºæ€§ï¼Œä½†ä¸ä¿è¯åŸå­æ€§ï¼Œæœ‰æ‰€æå‡ï¼Œä½†è¿˜ä¸å¤Ÿï¼ŒæŠ€æœ¯æ›´æ–°æ¢ä»£å•Šï¼è¿™å°±æ˜¯ä½ æ‰å¤´å‘çš„åŸå› å•¦ğŸ¤«

ä¸ºäº†æ›´è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œå‡ºç°CASæ— é”ç¼–ç¨‹ï¼ŒCASå®é™…æ˜¯ä¸€ç§ä¹è§‚é”

## äºŒã€CASæ¦‚è¿°

### 1.ä»€ä¹ˆæ˜¯CASï¼Ÿ

CASå…¨ç§°Compare And Swapï¼Œ**åŸºäºä¹è§‚é”æ€æƒ³å®ç°æ— é”ç¼–ç¨‹**

> ä¹è§‚é”ï¼šå°±æ˜¯å‹‡æ•¢ç‰›ç‰›ä¸æ€•å›°éš¾çš„æ€æƒ³ï¼Œå³å…¶ä»–çº¿ç¨‹è¦ä¿®æ”¹å…±äº«å˜é‡æˆ‘ä¸æ€•ä¸æ€•å•¦ï¼Œå°±ç®—å…±äº«å˜é‡è¢«æ”¹ä¹Ÿæ²¡å…³ç³»ï¼Œè‡ªå·±å¤šé‡è¯•å‡ æ¬¡ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œä¸æ‡‚å°±çœ‹æ¥ä¸‹æ¥CASçš„åŸç†
>
> æ‚²è§‚é”ï¼šå°±æ˜¯è‡ªç§æ€æƒ³ï¼Œå¦‚æœå…±äº«å˜é‡åˆ°äº†æˆ‘æ‰‹é‡Œå…¶ä»–çº¿ç¨‹å°±ä¼‘æƒ³ç¢°å¥¹ï¼Œä»–ç°åœ¨æ˜¯æˆ‘çš„å¥³äºº(bushiå“ˆå“ˆ)ï¼Œç­‰æˆ‘ç”¨å®Œäº†å†è§£å¼€ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šï¼Œå’¦ï¼Œè¿™ä¸ªä¾‹å­æ€ä¹ˆä¼˜ç‚¹æ¸£ç”·çš„å‘³é“å“ˆå“ˆï¼Œä¸ç®¡äº†

CASä½“ç°çš„æ˜¯æ— é”å¹¶å‘ï¼Œæ— é˜»å¡å¹¶å‘ï¼Œå› ä¸ºæ²¡æœ‰åŠ å…¥`synchronized`ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œä½†åè¿‡æ¥æƒ³ï¼Œè‹¥æœ‰å¤§é‡çš„èµ„æºç«äº‰ï¼Œé‚£ä¹ˆå¿…ç„¶å¼•èµ·å¤§é‡é‡è¯•ï¼Œåè€Œä¼šå½±å“æ•ˆç‡

æ¥ä¸‹æ¥è°ˆä¸€è°ˆCASéƒ½æ˜¯æ€æ ·ä¿è¯å¹¶å‘ç¼–ç¨‹ä¸‰ç‰¹æ€§çš„

* **åŸå­æ€§**ï¼šCASåº•å±‚ä½¿ç”¨`lock cmpxchg`æŒ‡ä»¤ï¼Œå•æ ¸å¤šæ ¸ä¸‹éƒ½èƒ½ä¿è¯åŸå­æ€§ï¼Œå¯¹äºå¤šæ ¸CPUï¼Œå½“æ‰§è¡Œåˆ°`lock`æŒ‡ä»¤æ—¶ï¼ŒCPUä¼šå°†æ€»çº¿é”ä½ï¼Œå¾…æŒ‡ä»¤æ‰§è¡Œå®Œä¹‹åå†å¼€å¯æ€»çº¿ï¼Œè¿™ä¸å°±æ˜¯æ€»çº¿åŠ é”æœºåˆ¶å˜›ï¼Œ[æœ‰é”ç¼–ç¨‹](/7.JUCå¹¶å‘ç¼–ç¨‹/æœ‰é”ç¼–ç¨‹)æœ‰è®²åˆ°
* **å¯è§æ€§**ï¼šCASç»“åˆ`volatile`ä¿è¯å¯è§æ€§ï¼ŒåŸå› æ˜¯`volatile`ä»¥ä¸»å†…å­˜ä¸ºåª’ä»‹ï¼Œé¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼
* **æœ‰åºæ€§**ï¼šé‚£`volatile`éƒ½å‡ºåœºäº†è¿˜ä¸èƒ½ä¿è¯åŸå­æ€§å˜›ï¼Ÿå½“ç„¶å¯ä»¥ä¿è¯åŸå­æ€§ï¼Œ`volatile`çš„å†…å­˜å±éšœ

>**ä¸ºä»€ä¹ˆæ— é”æ•ˆç‡é«˜ï¼Ÿ**
>
>synchronizedä¼šä½¿çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™é˜»å¡ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œæ— é”æ—¶çº¿ç¨‹æ— æ³•è·å¾—é”åªä¼šå¯¼è‡´é‡è¯•ï¼Œä½†çº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œ
>
>ä¸¾ä¸ªä¾‹å­ï¼Œçº¿ç¨‹å°±å¥½æ¯”èµ›è½¦ï¼Œæ¯”èµ›æ—¶ä»–æ˜¯è¶…å¿«çš„ï¼Œä¸€æ—¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»–è¦å‡é€Ÿã€ç†„ç«ï¼Œè¢«å”¤é†’ä»¥ååˆéœ€è¦é‡æ–°æ‰“ç«ã€å¯åŠ¨ã€åŠ é€Ÿ...ä»£ä»·æ¯”è¾ƒå¤§ï¼Œå¯¹äºæ— é”ï¼ŒCPUå°±å¥½æ¯”èµ›é“ï¼Œæ²¡æœ‰èµ›é“é«˜é€Ÿæ›´æ— ä»è°ˆèµ·ï¼Œæ‰€ä»¥æ— é”ä¸‹è™½ç„¶ä¸ä¼šè¿›å…¥é˜»å¡æ€ï¼Œä½†ç”±äºCPUæ—¶é—´ç‰‡çš„å…³ç³»è¿˜æ˜¯ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥å°±ç»ªæ€

### 2.CASåŸç†

CASä¸­ä¸€ä¸ªä¸‰ä¸ªæ“ä½œæ•°ï¼Œå³**å†…å­˜æ‰€å­˜å€¼Vï¼ŒåŸå€¼Aï¼Œè¦æ”¹çš„å€¼Bï¼Œå½“ä¸”ä»…å½“V=Aæ—¶ï¼Œå°†Væ”¹ä¸ºBå¹¶è¿”å›trueï¼Œå¦åˆ™è¿”å›falseï¼Œè‹¥Vå’ŒAä¸€ç›´ä¸ç›¸ç­‰ï¼Œåˆ™ä¸€ç›´å¾ªç¯è¯¥CASæ“ä½œ(è‡ªæ—‹do-while)**

![1658625252977](assets/1658625252977.png)

### 3.CASå­˜åœ¨çš„é—®é¢˜

**ABAé—®é¢˜**ï¼Œç†è§£ä¸ºå·æ¢æ¢æŸ±ï¼Œ**é€šè¿‡å¢åŠ æ—¶é—´æˆ³æˆ–ç‰ˆæœ¬å·è§£å†³**ï¼Œå³**AtomicStampedReference**ï¼Œåˆ†å¸ƒå¼é”ä¸­åŸºäºDBçš„ä¹è§‚é”ä¾¿æ˜¯å¢åŠ versionçš„åŸç†

![1658625484273](assets/1658625484273.png)

é™¤äº†ABAé—®é¢˜è¿˜å­˜åœ¨å¤§é‡èµ„æºç«äº‰ï¼Œé€ æˆ**å¤§é‡è‡ªæ—‹**çš„é—®é¢˜ï¼Œä¸”**CASæ¯æ¬¡åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§**

## ä¸‰ã€Unsafe

### 1.Unsafeæ˜¯ä»€ä¹ˆï¼Ÿ

Unsafeæä¾›ç±»ä¼¼C++çš„**æ‰‹åŠ¨å†…å­˜ç®¡ç†èƒ½åŠ›åŠæ“ä½œçº¿ç¨‹çš„æ–¹æ³•**ï¼Œå…¨é™å®šåæ˜¯`sun.misc.Unsafe`ï¼Œå³ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½

Unsafeç”±`final`ä¿®é¥°ï¼Œå³`public final class Unsafe`ï¼Œæ‰€ä»¥ä¸èƒ½è¢«ç»§æ‰¿

Unsafeåªæœ‰ä¸€ä¸ªç§æœ‰çš„æ— å‚æ„é€ ï¼Œæ‰€ä»¥ä¸å…è®¸`new`å‡ºUnsafeå®ä¾‹ï¼Œé‚£Unsafeå¦‚ä½•åˆ›å»ºå‘¢ï¼Ÿè¯·å¾€ä¸‹çœ‹

```java
private Unsafe() {
    }
```

### 2.Unsafeåˆ›å»º

é¦–å…ˆæ¥çœ‹ä¸€ç§é”™è¯¯çš„åˆ›å»ºæ–¹å¼

```java
//ä¸ºä»€ä¹ˆæ˜¯é”™è¯¯çš„ï¼Ÿè¯·æŸ¥çœ‹getUnsafe()æºç 
private static final Unsafe unsafe = Unsafe.getUnsafe();
-------------------------------------------------------
public static Unsafe getUnsafe() {
    Class var0 = Reflection.getCallerClass();
    //æ­¤å¤„å…¶å®è¿˜çœ‹ä¸å‡ºä»€ä¹ˆï¼Œä½†æ˜¯æ­¤å¤„æœ‰ä¸€ä¸ªåˆ¤æ–­æŠ›å‡ºå¼‚å¸¸çš„è¯­å¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ifå†…æ˜¯å¦‚ä½•åˆ¤æ–­çš„ï¼Œè¿›å…¥isSystemDomainLoader()
    if (!VM.isSystemDomainLoader(var0.getClassLoader())) {
        throw new SecurityException("Unsafe");
    } else {
        return theUnsafe;
    }
}
-------------------------------------------------------
public static boolean isSystemDomainLoader(ClassLoader var0) {
	return var0 == null;//å‡ºç°ç«¯å€ª
}
-------------------------------------------------------
åˆ†æå¯çŸ¥isSystemDomainLoader()å†…ä¼šåˆ¤æ–­å½“å‰ç±»åŠ è½½å™¨æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¡¨ç¤ºæ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè¿”å›trueï¼Œè‹¥ä¸ä¸ºç©ºåˆ™è¿”å›falseï¼Œæ­¤å¤„æ˜¯Launcher$ApplicationåŠ è½½å™¨ï¼Œæ‰€ä»¥è¿”å›false
ä¸æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨åˆ™è¿”å›falseåˆ°getUnsafe()çš„ifåˆ¤æ–­ä¸­ï¼Œ!false=trueï¼Œå°†è¿›å…¥ifè¯­å¥å†…éƒ¨ï¼ŒæŠ›å‡ºSecurityExceptionå¼‚å¸¸
```

ç»¼ä¸Šé€šè¿‡ç›´æ¥`getUnsafe()`å¿…é¡»ä¿è¯æ˜¯æ ¹åŠ è½½å™¨BootStrapï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸

æ—¢ç„¶æ— æ³•`new`ï¼Œæä¾›çš„`getUnsafe()`ä¹Ÿä¸èƒ½ç”¨ï¼Œé‚£å°±åˆ«æ€ªæˆ‘ä¸è®²æ­¦å¾·ï¼Œæˆ‘è¦**åå°„**ä½ äº†ï¼Œè¿™æ˜¯æ­£ç¡®çš„åˆ›å»ºæ–¹å¼

```java
static long offset;//æˆå‘˜å˜é‡åç§»é‡
private volatile int state = 0;//æˆå‘˜å˜é‡

static Unsafe unsafe;

static {
    try {
        Field field = Unsafe.class.getDeclaredField("theUnsafe");
        field.setAccessible(true);
        //è·å–æ­¤å˜é‡çš„å€¼-->åº•å±‚ï¼štheUnsafe = new Unsafe();(é™æ€å—ä¸­)
        unsafe = (Unsafe) field.get(null);
        
        //è·å–æˆå‘˜å˜é‡stateçš„åç§»é‡
        offset = unsafe.objectFieldOffset(Test.class.getDeclaredField("state"));
        
        Test test = new Test();
        
        //ä½¿ç”¨CASæ–¹æ³•æ›¿æ¢æˆå‘˜å˜é‡çš„å€¼
        //compareAndSwapInt(è¦æ“ä½œçš„å¯¹è±¡ï¼Œè¦æ“ä½œçš„å±æ€§çš„åç§»é‡ï¼ŒåŸå€¼ï¼Œè¦æ›´æ–°çš„å€¼)ï¼šåŸå€¼ä¸å†…å­˜ä¸­çš„å€¼ç›¸åŒå°±æ›´æ–°å€¼
		Boolean success = unsafe.compareAndSwapInt(test, offset, 0, 5);
        System.out.println("ä¿®æ”¹æ˜¯å¦æˆåŠŸï¼š" + success);
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

### 3.Unsafeå†…çš„æ–¹æ³•

è´´å‡ºæ–‡ç« ä¸€ç¯‡ï¼š[https://www.jianshu.com/p/db8dce09232d](https://www.jianshu.com/p/db8dce09232d)

## å››ã€åŸå­æ“ä½œ

### 1.åŸå­æ•´æ•°

åŒ…å«AtomicBooleanã€AtomicIntegerã€AtomicLongï¼Œä»¥AtomicIntegerä¸ºä¾‹ï¼Œå…¶ä¸­åŒ…å«çš„æ–¹æ³•å¦‚ä¸‹

```java
AtomicInteger i = new AtomicInteger(0);
// è·å–å¹¶è‡ªå¢ï¼ˆi = 0, ç»“æœ i = 1, è¿”å› 0ï¼‰ï¼Œç±»ä¼¼äº i++
System.out.println(i.getAndIncrement());
// è‡ªå¢å¹¶è·å–ï¼ˆi = 1, ç»“æœ i = 2, è¿”å› 2ï¼‰ï¼Œç±»ä¼¼äº ++i
System.out.println(i.incrementAndGet());
// è‡ªå‡å¹¶è·å–ï¼ˆi = 2, ç»“æœ i = 1, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº --i
System.out.println(i.decrementAndGet());
// è·å–å¹¶è‡ªå‡ï¼ˆi = 1, ç»“æœ i = 0, è¿”å› 1ï¼‰ï¼Œç±»ä¼¼äº i--
System.out.println(i.getAndDecrement());
// è·å–å¹¶åŠ å€¼ï¼ˆi = 0, ç»“æœ i = 5, è¿”å› 0ï¼‰
System.out.println(i.getAndAdd(5));
// åŠ å€¼å¹¶è·å–ï¼ˆi = 5, ç»“æœ i = 0, è¿”å› 0ï¼‰
System.out.println(i.addAndGet(-5));
// è·å–å¹¶æ›´æ–°ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = -2, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.getAndUpdate(p -> p - 2));
// æ›´æ–°å¹¶è·å–ï¼ˆi = -2, p ä¸º i çš„å½“å‰å€¼, ç»“æœ i = 0, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.updateAndGet(p -> p + 2));
// è·å–å¹¶è®¡ç®—ï¼ˆi = 0, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 10, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
// getAndUpdate å¦‚æœåœ¨ lambda ä¸­å¼•ç”¨äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¦ä¿è¯è¯¥å±€éƒ¨å˜é‡æ˜¯ final çš„
// getAndAccumulate å¯ä»¥é€šè¿‡ å‚æ•°1 æ¥å¼•ç”¨å¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œä½†å› ä¸ºå…¶ä¸åœ¨ lambda ä¸­å› æ­¤ä¸å¿…æ˜¯ final
System.out.println(i.getAndAccumulate(10, (p, x) -> p + x));
// è®¡ç®—å¹¶è·å–ï¼ˆi = 10, p ä¸º i çš„å½“å‰å€¼, x ä¸ºå‚æ•°1, ç»“æœ i = 0, è¿”å› 0ï¼‰
// å…¶ä¸­å‡½æ•°ä¸­çš„æ“ä½œèƒ½ä¿è¯åŸå­ï¼Œä½†å‡½æ•°éœ€è¦æ— å‰¯ä½œç”¨
System.out.println(i.accumulateAndGet(-10, (p, x) -> p + x));
```

èµ°è¿‡è·¯è¿‡ä¸è¦é”™è¿‡ï¼Œå®¢å®˜æ¥ç§ä¸€ç§æºç ï¼Œä»¥`incrementAndGet()`ä¸ºä¾‹

```java
public final long incrementAndGet() {
	//unsafeæ˜¯å¦‚ä½•åˆ›å»ºï¼Ÿï¼Ÿé€šè¿‡Unsafe.getUnsafe();å› ä¸ºæ­¤å¤„ä½¿ç”¨çš„æ˜¯æ ¹åŠ è½½å™¨åŠ è½½

    //valueOffsetåœ¨é™æ€å—ä¸­è·å–ï¼Œæºç å¦‚ä¸‹
	//valueOffset = unsafe.objectFieldOffset(AtomicLong.class.getDeclaredField("value"));
	
	//getAndAddLong**
	return unsafe.getAndAddLong(this, valueOffset, 1L) + 1L;
}
--------------------------------------
public final long getAndAddLong(Object var1, long var2, long var4) {
	long var6;
	//è‡ªæ—‹:å†…å­˜ä¸­çš„å€¼ä¸var6ä¸€ç›´ä¸ç›¸ç­‰å°±ä¸€ç›´å¾ªç¯,è‹¥æœªåŠ è‡ªæ—‹ï¼Œè¯¥compareAndSwapLongè¿”å›false
	do {
		var6 = this.getLongVolatile(var1, var2);
	} while(!this.compareAndSwapLong(var1, var2, var6, var6 + var4));
	return var6;
}
```

### 2.åŸå­å¼•ç”¨

åŒ…å«AtomicReferenceã€AtomicMarkableReferenceã€AtomicStampedReferenceï¼ŒåŸå­å¼•ç”¨é¡¾åæ€ä¹‰å°±æ˜¯å°†**æ•´ä¸ªå¯¹è±¡çš„æ“ä½œçœ‹æˆåŸå­æ“ä½œ**ï¼Œä¸åŒå¯¹è±¡æ€ä¹ˆåŠï¼Ÿ**æ³›å‹**å•Š

#### 2.1.AtomicReference

å‡è®¾æœ‰å¦‚ä¸‹æ–¹æ³•ï¼Œè¯•ç€æä¾›å®‰å…¨çš„æ–¹æ³•å–æ¬¾

```java
public interface DecimalAccount {
	// è·å–ä½™é¢
	BigDecimal getBalance();
	// å–æ¬¾
	void withdraw(BigDecimal amount);
    
	// æ–¹æ³•å†…ä¼šå¯åŠ¨1000ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš-10å…ƒçš„æ“ä½œï¼Œå¦‚æœåˆå§‹ä½™é¢ä¸º10000é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯0
	static void demo(DecimalAccount account) {
		List<Thread> ts = new ArrayList<>();
		for (int i = 0; i < 1000; i++) {//åˆ›å»º1000ä¸ªçº¿ç¨‹
			ts.add(new Thread(() -> {
				account.withdraw(BigDecimal.TEN);//-10æ“ä½œï¼Œå°±æ˜¯withdraw()éœ€è¦æ­¥æ­¥å‡çº§ï¼Œé€æ¸å˜å¾—å®‰å…¨
			}));
		}
		ts.forEach(Thread::start);//å¯åŠ¨1000ä¸ªçº¿ç¨‹
		ts.forEach(t -> {
			try {
				t.join();
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		});
		System.out.println(account.getBalance());
	}
}
```

â‘ ä¸å®‰å…¨çš„å®ç°æ–¹å¼

```java
class DecimalAccountUnsafe implements DecimalAccount {
	BigDecimal balance;
	public DecimalAccountUnsafe(BigDecimal balance) {
		this.balance = balance;
	}
	@Override
	public BigDecimal getBalance() {
		return balance;
	}
	@Override
	public void withdraw(BigDecimal amount) {
		BigDecimal balance = this.getBalance();
		this.balance = balance.subtract(amount);
	}
}
```

â‘¡ä½¿ç”¨`synchronized`çš„å®‰å…¨å®ç°æ–¹å¼

```java
class DecimalAccountSafeLock implements DecimalAccount {
	private final Object lock = new Object();
	BigDecimal balance;
	public DecimalAccountSafeLock(BigDecimal balance) {
		this.balance = balance;
	}
	@Override
	public BigDecimal getBalance() {
		return balance;
	}
	@Override
	public void withdraw(BigDecimal amount) {
		synchronized (lock) {
			BigDecimal balance = this.getBalance();
			this.balance = balance.subtract(amount);
		}
	}
}
```

â‘¢ä½¿ç”¨CASçš„å®‰å…¨å®ç°æ–¹å¼

```java
class DecimalAccountSafeCas implements DecimalAccount {
    
	AtomicReference<BigDecimal> ref;//AtomicReference
    
	public DecimalAccountSafeCas(BigDecimal balance) {
		ref = new AtomicReference<>(balance);
	}
	@Override
	public BigDecimal getBalance() {
		return ref.get();
	}
	@Override
	public void withdraw(BigDecimal amount) {
		while (true) {//è‡ªæ—‹
			BigDecimal prev = ref.get();//åŸå€¼
			BigDecimal next = prev.subtract(amount);//æ–°å€¼
			if (ref.compareAndSet(prev, next)) {//CAS
				break;
			}
		}
	}
}
```

#### 2.2.AtomicStampedReference

AtomicStampedReferenceç»™åŸå­å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œ**è¿½è¸ªåŸå­å¼•ç”¨æ•´ä¸ªå˜åŒ–è¿‡ç¨‹**ï¼Œå¦‚`A->B->A->C` ï¼Œé€šè¿‡AtomicStampedReferenceå¯ä»¥çŸ¥é“å¼•ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†å‡ æ¬¡

ABAé—®é¢˜æ­£æ˜¯å› ä¸ºå­˜åœ¨æ—¶é—´å·®ï¼Œåœ¨æ—¶é—´å·®å†…å¯¹è±¡çš„å±æ€§è¢«ä¿®æ”¹ä½†æ˜¯CASæ— æ³•è¯†åˆ«ï¼Œå¢åŠ ç‰ˆæœ¬å·è§£å†³ï¼Œä»¥ä¸‹æ˜¯ABAé—®é¢˜æµ‹è¯•ä»£ç 

```java
//åŸæ¥mainåªèƒ½æ„ŸçŸ¥åˆ°prevçš„å€¼å’Œå†…å­˜ä¸­çš„æ˜¯å¦ç›¸åŒï¼Œä½†ä¸èƒ½æ„ŸçŸ¥A->B->Açš„æƒ…å†µ
import java.util.concurrent.atomic.AtomicReference;
import static java.lang.Thread.sleep;

public class ABA1_AtomicReference {
    
    static AtomicReference<String> ref = new AtomicReference<>("A");

    public static void main(String[] args) throws InterruptedException {
        System.out.println("main start...");

        String prev = ref.get();//è·å–å€¼prev=A

        other();//æ¨¡æ‹Ÿä¸­é—´æœ‰å…¶å®ƒçº¿ç¨‹å¹²æ‰°ï¼Œå‘ç”ŸABA
        sleep(2);

        //å°è¯•æ”¹ä¸ºC
        System.out.println("change A->Cï¼š" + ref.compareAndSet(prev, "C"));//true
    }

    private static void other() throws InterruptedException {
        new Thread(() -> {
            System.out.println("change A->Bï¼š" + ref.compareAndSet(ref.get(), "B"));//true
        }, "t1").start();
        sleep(1);
        new Thread(() -> {
            System.out.println("change B->Aï¼š" + ref.compareAndSet(ref.get(), "A"));//true
        }, "t2").start();
    }
}
```

ä½¿ç”¨AtomicStampedReferenceå¢åŠ ç‰ˆæœ¬å·è§£å†³

```JAVA
import java.util.concurrent.atomic.AtomicStampedReference;
import static java.lang.Thread.sleep;

public class ABA2_AtomicStampedReference {
    //(å˜é‡å€¼ï¼Œé€’å¢æ ‡é‡)
    static AtomicStampedReference<String> ref = new AtomicStampedReference<>("A", 0);

    public static void main(String[] args) throws InterruptedException {
        System.out.println("main start...");

        String prev = ref.getReference();//è·å–å€¼prev=A
        int stamp = ref.getStamp();//è·å–ç‰ˆæœ¬å·
        System.out.println("ç‰ˆæœ¬ï¼š" + stamp);

        other();//æ¨¡æ‹Ÿä¸­é—´æœ‰å…¶å®ƒçº¿ç¨‹å¹²æ‰°ï¼Œå‘ç”ŸABA
        sleep(2);

        //å°è¯•æ”¹ä¸ºC   (åŸå€¼,æ–°å€¼,åŸç‰ˆæœ¬,æ–°ç‰ˆæœ¬)
        System.out.println("change A->Cï¼š" + ref.compareAndSet(prev, "C", stamp, stamp + 1));//false
    }

    private static void other() throws InterruptedException {
        new Thread(() -> {
            System.out.println("change A->Bï¼š" + ref.compareAndSet(ref.getReference(), "B", ref.getStamp(), ref.getStamp() + 1));//true
        }, "t1").start();
        sleep(1);
        new Thread(() -> {
            System.out.println("change B->Aï¼š" + ref.compareAndSet(ref.getReference(), "A", ref.getStamp(), ref.getStamp() + 1));//true
        }, "t2").start();
    }
}
```

#### 2.3.AtomicMarkableReference

AtomicStampedReferenceå…³ç³»çš„æ˜¯å˜é‡è¢«æ”¹äº†å‡ æ¬¡ï¼Œä½†æœ‰çš„æ—¶å€™åªéœ€è¦å…³å¿ƒ**æœ‰æ²¡æœ‰æ›´æ”¹è¿‡**ï¼Œæ‰€ä»¥å‡ºç°AtomicMarkableReference

```java
import java.util.concurrent.atomic.AtomicMarkableReference;

public class UseAtomic4AtomicMarkableReference {
    public static void main(String[] args) throws InterruptedException {
        GarbageBag bag = new GarbageBag("è£…æ»¡äº†åƒåœ¾");

        //å‚æ•°2å¯ç†è§£ä¸ºæ ‡è®°ï¼Œæ ‡è®°æ˜¯å¦æ”¹è¿‡
        AtomicMarkableReference<GarbageBag> ref = new AtomicMarkableReference<>(bag, true);
        System.out.println("ä¸»çº¿ç¨‹ start...");

        //è®°å½•åŸæ¥çš„å€¼
        GarbageBag prev = ref.getReference();
        System.out.println(prev.toString());

        //æ–°çº¿ç¨‹ä¿®æ”¹
        new Thread(() -> {
            System.out.println("æ‰“æ‰«å«ç”Ÿçš„çº¿ç¨‹ start...");
            bag.setDesc("ç©ºåƒåœ¾è¢‹");
            while (!ref.compareAndSet(bag, bag, true, false)) {
            }
            System.out.println(bag.toString());
        }).start();
        Thread.sleep(1000);

        System.out.println("ä¸»çº¿ç¨‹æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ");
        boolean success = ref.compareAndSet(prev, new GarbageBag("ç©ºåƒåœ¾è¢‹"), true, false);
        System.out.println("æ¢äº†ä¹ˆï¼Ÿ" + success);
        System.out.println(ref.getReference().toString());
    }
}

class GarbageBag {
    String desc;
    public GarbageBag(String desc) {
        this.desc = desc;
    }
    public void setDesc(String desc) {
        this.desc = desc;
    }
    @Override
    public String toString() {
        return desc;
    }
}
```

### 3.åŸå­æ•°ç»„

åŒ…å«AtomicIntegerArrayã€AtomicLongArrayã€AtomicReferenceArray

```java
public class UseAtomic5Array {
    static int[] value = new int[]{1, 2};
    static AtomicIntegerArray ai = new AtomicIntegerArray(value);

    public static void main(String[] args) {
        //(ç´¢å¼•ï¼Œæ–°å€¼)
        ai.getAndSet(0, 3);
        System.out.println(ai.get(0));

        //æ•°ç»„æ‹·è´cloneï¼ŒåŸæ•°ç»„å†…å®¹ä¸å˜
        System.out.println(value[0]);
    }
}
```

### 4.å­—æ®µæ›´æ–°å™¨

åŒ…å«AtomicReferenceFieldUpdaterã€AtomicIntegerFieldUpdaterã€AtomicLongFieldUpdaterï¼Œå¿…é¡»é…åˆ`volatile`ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™å‡ºç°æŠ¥é”™

```java
Exception in thread "main" java.lang.IllegalArgumentException: Must be volatile type
```

```java
public class UseAtomic6AtomicIntegerFieldUpdater {
    private volatile int field;

    public static void main(String[] args) {
        AtomicIntegerFieldUpdater fieldUpdater = AtomicIntegerFieldUpdater.newUpdater(UseAtomic6AtomicIntegerFieldUpdater.class, "field");

        UseAtomic6AtomicIntegerFieldUpdater test5 = new UseAtomic6AtomicIntegerFieldUpdater();
        
        fieldUpdater.compareAndSet(test5, 0, 10);
        System.out.println(test5.field);// ä¿®æ”¹æˆåŠŸ field = 10
        
        fieldUpdater.compareAndSet(test5, 10, 20);
        System.out.println(test5.field);// ä¿®æ”¹æˆåŠŸ field = 20
        
        fieldUpdater.compareAndSet(test5, 10, 30);
        System.out.println(test5.field);// ä¿®æ”¹å¤±è´¥ field = 20
    }
}
```

### 5.LongAdder

#### 5.1.é—®é¢˜å¼•å…¥

é«˜å¹¶å‘ä¸‹Nå¤šçº¿ç¨‹åŒæ—¶å»æ“ä½œä¸€ä¸ªå˜é‡ä¼šé€ æˆå¤§é‡çº¿ç¨‹CASå¤±è´¥ï¼Œç„¶åå¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œå¯¼è‡´ä¸¥é‡æµªè´¹CPUèµ„æºï¼Œé™ä½å¹¶å‘æ€§ï¼Œæ—¢ç„¶AtomicLongæ€§èƒ½é—®é¢˜æ˜¯ç”±äºè¿‡å¤šçº¿ç¨‹åŒæ—¶å»ç«äº‰åŒä¸€ä¸ªå˜é‡çš„æ›´æ–°è€Œé™ä½çš„ï¼Œé‚£ä¹ˆå¦‚æœ**æŠŠä¸€ä¸ªå˜é‡åˆ†è§£ä¸ºå¤šä¸ªå˜é‡ï¼Œè®©åŒæ ·å¤šçš„çº¿ç¨‹å»ç«äº‰å¤šä¸ªèµ„æº**å°±å¯ä»¥è§£å†³è¯¥æ€§èƒ½é—®é¢˜

#### 5.2.åŸç†&æºç 

åŸç†å°±æ˜¯ä¸Šé¢æåˆ°çš„**é«˜å¹¶å‘ä¸‹å°†ä¸€ä¸ªå…±äº«å˜é‡åˆ†è§£æˆå¤šä¸ªå˜é‡ï¼Œè®©å¤šçº¿ç¨‹ç«äº‰å¤šä¸ªèµ„æº**ï¼Œæºç ä¸­æœ‰å‡ ä¸ªå…³é”®

```java
// ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–
transient volatile Cell[] cells;
// åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨CASç´¯åŠ è¿™ä¸ªåŸŸ
transient volatile long base;
// åœ¨cellsåˆ›å»ºæˆ–æ‰©å®¹æ—¶ç½®ä¸º1, è¡¨ç¤ºåŠ é”
transient volatile int cellsBusy;
```

å…¶ä¸­`Cell`ä¸ºç´¯åŠ å•å…ƒï¼Œæºç å¦‚ä¸‹

```java
// é˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«
@sun.misc.Contended
static final class Cell {
	volatile long value;
	Cell(long x) { value = x; }
	// æœ€é‡è¦çš„æ–¹æ³•, ç”¨æ¥CASæ–¹å¼è¿›è¡Œç´¯åŠ , prevè¡¨ç¤ºæ—§å€¼, nextè¡¨ç¤ºæ–°å€¼
	final boolean cas(long prev, long next) {
		return UNSAFE.compareAndSwapLong(this, valueOffset, prev, next);
	}
	// çœç•¥ä¸é‡è¦ä»£ç 
}
```

`@sun.misc.Contended`ä¸ºäº†é˜²æ­¢ä¼ªå…±äº«ï¼Œä½•ä¸ºä¼ªå…±äº«å‘¢ï¼Ÿå…ˆä»ç¼“å­˜è¯´èµ·ï¼Œæ¯”è¾ƒç¼“å­˜ä¸å†…å­˜çš„é€Ÿåº¦

| ä»CPUåˆ° |        å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ        |
| :-----: | :------------------------------: |
| å¯„å­˜å™¨  | 1 cycle (4GHz çš„ CPU çº¦ä¸º0.25ns) |
|   L1    |            3~4 cycle             |
|   L2    |           10~20 cycle            |
|   L3    |           40~45 cycle            |
|  å†…å­˜   |          120~240 cycle           |

è¡¨ä¸­å¯è§CPUä¸å†…å­˜çš„é€Ÿåº¦ç›¸å·®å¾ˆå¤§ï¼Œéœ€è¦è€ƒé¢„è¯»å–æ•°æ®åˆ°ç¼“å­˜æ¥æå‡æ•ˆç‡ï¼Œè€Œç¼“å­˜ç³»ç»Ÿä»¥ç¼“å­˜è¡Œ(CacheLine)ä¸ºå•ä½ï¼Œ**æ¯å—ç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜åŒºåŸŸ**ï¼Œå¤§å°ä¸€èˆ¬æ˜¯64Byte(8ä¸ªlong)ï¼Œç¼“å­˜è¡Œçš„åŠ å…¥å¯èƒ½äº§ç”Ÿæ•°æ®å‰¯æœ¬ï¼Œå³å†…å­˜ä¸­åŒä¸€åŒºåŸŸå¯èƒ½å¯¹åº”ä¸åŒç¼“å­˜è¡Œï¼ŒCPUä¸ºä¿è¯æ•°æ®ä¸€è‡´ï¼Œè‹¥æŸä¸ªç¼“å­˜è¡Œå†…çš„æŸäº›æ•°æ®è¢«æ”¹ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ•´ä¸ªç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œä¿®æ”¹å…±äº«åŒä¸€ç¼“å­˜è¡Œçš„å˜é‡ä¼šæ— æ„ä¸­å½±å“å½¼æ­¤çš„æ€§èƒ½

> 1ä½è¡¨ç¤º0æˆ–1ï¼Œ1å­—èŠ‚=8ä½

![1658644292375](assets/1658644292375.png)

**å¤šä¸ªåœ°å€è¿ç»­çš„å˜é‡æ‰æœ‰å¯èƒ½è¢«æ”¾åˆ°åŒä¸€ä¸ªç¼“å­˜è¡Œä¸­**ï¼Œ`Cell[]`æ°å¥½åœ°å€è¿ç»­ï¼Œä¸€ä¸ª`Cell`ä¸º24å­—èŠ‚(16å­—èŠ‚å¯¹è±¡å¤´+8å­—èŠ‚`value`)ï¼Œæ‰€ä»¥ä¸€ä¸ªç¼“å­˜è¡Œå¯å­˜ä¸¤ä¸ª`Cell`ï¼Œé‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œè‹¥`Core-0`è¦ä¿®æ”¹`Cell[0]`ï¼Œ`Core-1`è¦ä¿®æ”¹`Cell[1]`ï¼Œæ— è®ºè°ä¿®æ”¹æˆåŠŸéƒ½ä¼šå¯¼è‡´ç¼“å­˜è¡Œå¤±æ•ˆï¼Œ

![1658644552208](assets/1658644552208.png)

```java
public void add(long x) {
	// as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„
	// b ä¸ºåŸºç¡€å€¼
	// x ä¸ºç´¯åŠ å€¼
	Cell[] as; long b, v; int m; Cell a;
	// è¿›å…¥ if çš„ä¸¤ä¸ªæ¡ä»¶
	// 1. as æœ‰å€¼, è¡¨ç¤ºå·²ç»å‘ç”Ÿè¿‡ç«äº‰, è¿›å…¥ if
	// 2. cas ç»™ base ç´¯åŠ æ—¶å¤±è´¥äº†, è¡¨ç¤º base å‘ç”Ÿäº†ç«äº‰, è¿›å…¥ if
	if ((as = cells) != null || !casBase(b = base, b + x)) {
		// uncontended è¡¨ç¤º cell æ²¡æœ‰ç«äº‰
		boolean uncontended = true;
		if (
            // as è¿˜æ²¡æœ‰åˆ›å»º
            as == null || (m = as.length - 1) < 0 ||
            // å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell è¿˜æ²¡æœ‰
            (a = as[getProbe() & m]) == null ||
            // cas ç»™å½“å‰çº¿ç¨‹çš„ cell ç´¯åŠ å¤±è´¥ uncontended=false ( a ä¸ºå½“å‰çº¿ç¨‹çš„ cell )
            !(uncontended = a.cas(v = a.value, v + x))
        ) {
            // è¿›å…¥ cell æ•°ç»„åˆ›å»ºã€cell åˆ›å»ºçš„æµç¨‹
            longAccumulate(x, null, uncontended);
        }
    }
}
```

#### 5.3.è§£å†³ä¼ªå…±äº«

ä¼ªå…±äº«æ˜¯å•¥åœ¨åŸç†&æºç éƒ¨åˆ†å·²ç»è®²è§£

â‘ **å¡«å……æ³•**ï¼šä¸ºä¿è¯ä¸€ä¸ªå˜é‡è¢«å­˜äºåŒä¸€ç¼“å­˜è¡Œï¼Œæ‰€ä»¥å¡«å……å¯¹è±¡ï¼Œä»¥`Cell`å¯¹è±¡ä¸ºä¾‹ï¼Œä¸€ä¸ª`Cell`ä¸º24å­—èŠ‚ï¼Œå…¶ä¸­å¯¹è±¡å¤´å 16å­—èŠ‚ï¼Œ`value`å 8å­—èŠ‚ï¼Œè¡¥å……40å­—èŠ‚å³å¯ï¼Œå³è¡¥å……5ä¸ª`long`

```java
static final class Cell {
	volatile long value;
	
	public long p1, p2, p3, p4, p5;
	// çœç•¥å…¶ä»–ä»£ç 
}
```

â‘¡**@sun.misc.Contended**ï¼šåŸç†æ˜¯åœ¨æ·»åŠ è¯¥æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µå‰åå„å¢åŠ 128å­—èŠ‚çš„`padding`ï¼Œä»è€Œä½¿å¯¹è±¡è¢«ä¸ç¼“å­˜åˆ°ç¼“å­˜ä¸­ä¸åŒçš„ç¼“å­˜è¡Œï¼Œé˜²æ­¢ä¼ªå…±äº«ï¼Œ`-XX:ContendedPaddingWidth`å¯ä¿®æ”¹128å­—èŠ‚çš„å¡«å……å®½åº¦ï¼Œé»˜è®¤æƒ…å†µä¸‹æ­¤æ³¨è§£ç”¨äºJavaæ ¸å¿ƒç±»ï¼Œç”¨æˆ·è·¯å¾„ä¸‹çš„ç±»éœ€è¦ä½¿ç”¨è¯¥æ³¨è§£åˆ™é…ç½®`--XX:-RestrictContended`

```java
@sun.misc.Contended
static final class Cell {
	volatile long value;
	
	// çœç•¥å…¶ä»–ä»£ç 
}
```

![1658646043173](assets/1658646043173.png)

#### 5.4.AtomicLong&LongAdderçš„åŒºåˆ«

* AtomicLongä»¥CAS+è‡ªæ—‹çš„æ–¹å¼æ›´æ–°ï¼Œå…·æœ‰åŸå­æ€§çš„è¯»å†™ç»“åˆAPI
* LongAdderåœ¨å¹¶å‘é‡ä½æ—¶ä½¿ç”¨CASï¼ŒæˆåŠŸåˆ™ç»“æŸï¼›ä½†åœ¨å¹¶å‘é‡é«˜æ—¶å°†`value`åˆ†æˆ`Cell[]`ï¼Œéœ€è¦æ—¶å¯å¯¹`Cell[]`æ‰©å®¹ï¼ŒæˆåŠŸåˆ™ç»“æŸï¼Œå¤±è´¥åˆ™CASï¼Œå–å€¼æ—¶é€šè¿‡`sum()`å¯¹æ¯ä¸ª`cell`ç´¯åŠ ï¼Œå…¶æ²¡æœ‰åŸå­æ€§åŸå­æ€§è¯»å†™ç»“åˆAPIï¼Œä½†ä¿è¯æœ€ç»ˆä¸€è‡´
* .ä½å¹¶å‘åœºæ™¯AtomicLongå’ŒLongAdderæ€§èƒ½ç›¸ä¼¼ï¼Œé«˜å¹¶å‘åœºæ™¯LongAdderæ€§èƒ½ä¼˜äºAtomicLong



> [å‚è€ƒæ–‡ç« ](https://blog.csdn.net/weixin_45735355/article/details/121946452)















