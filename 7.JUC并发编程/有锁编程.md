# æœ‰é”ç¼–ç¨‹

## ä¸€ã€å…±äº«å¸¦æ¥çš„é—®é¢˜

ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º0çš„é™æ€å˜é‡ï¼Œä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œç»“æœæ˜¯0å—ï¼Ÿ

```java
static int i = 0;
public static void main(String[] args) throws InterruptedException {
	Thread t1 = new Thread(() -> {
		i++;
	}, "t1");
    
	Thread t2 = new Thread(() -> {
		i--;
	}, "t2");
    
	t1.start();
	t2.start();
	t1.join();
	t2.join();
	System.out.println(i);
}
```

ç»“æœæ­£æ•°ã€è´Ÿæ•°ã€é›¶éƒ½æœ‰ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ¥ä¸‹æ¥ä»å­—èŠ‚ç å¼€å§‹æ­¥æ­¥æ·±å…¥ğŸ™ƒ

å¯¹äº`i++`è€Œè¨€ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„JVMå­—èŠ‚ç æŒ‡ä»¤ï¼Œ`i--`ä¹Ÿç±»ä¼¼ï¼Œå¯çœ‹åˆ°åˆ†æˆå››æ­¥

```java
getstatic i	//è·å–é™æ€å˜é‡içš„å€¼
iconst_1	//å‡†å¤‡å¸¸é‡1
iadd		//è‡ªå¢ï¼Œi--æ”¹æˆ isub
putstatic i //å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

é€šè¿‡ä¸Šä¸€å¼ å›¾è§£å¯çŸ¥ï¼Œå®Œæˆé™æ€å˜é‡è‡ªå¢å’Œè‡ªå‡éœ€è¦åœ¨ä¸»å†…å­˜ä¸çº¿ç¨‹å·¥ä½œå†…å­˜é—´è¿›è¡Œæ•°æ®äº¤æ¢

![1658372661291](../7.JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/assets/1658372661291.png)

å¯¹äºå•çº¿ç¨‹ï¼Œä»¥ä¸Šè‡ªå¢å’Œè‡ªå‡çš„8æ¡å­—èŠ‚ç æŒ‡ä»¤é¡ºåºæ‰§è¡Œï¼Œä¸ä¼šå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Œä½†å¯¹å¤šçº¿ç¨‹æ¥è¯´è¿™8æ¡æŒ‡ä»¤å¯èƒ½äº¤é”™è¿è¡Œï¼Œå³çº¿ç¨‹1å¯èƒ½è¿è¡Œåˆ°ç¬¬ä¸‰æ¡æŒ‡ä»¤å°±åˆ‡æ¢ä¸Šä¸‹æ–‡ç»™çº¿ç¨‹2ï¼Œçº¿ç¨‹2è‹¥é¡ºåˆ©çš„è¿è¡Œå®Œåˆ™å°†ç»“æœ-1å†™å›ä¸»å­˜ï¼Œæ­¤æ—¶ç»§ç»­æ‰§è¡Œçº¿ç¨‹1çš„ç¬¬ä¸‰å¤©æŒ‡ä»¤åˆ™å°†ç»“æœ1å†™å›ä¸»å­˜ï¼Œæœ€ç»ˆä¸»å­˜ä¸­içš„ç»“æœä¸º1ï¼Œå½“ç„¶è¿™8æ¡å­—èŠ‚ç æŒ‡ä»¤é—´è¿˜å­˜åœ¨å„ç§äº¤æ›¿æ–¹å¼ï¼Œæ‰€ä»¥æœ€ç»ˆiçš„å€¼å¯èƒ½ä¸ºæ­£æ•°ã€è´Ÿæ•°æˆ–é›¶

**å…¶å®ç¨‹åºè¿è¡Œå¤šçº¿ç¨‹æœ¬èº«æ˜¯ä¸å­˜åœ¨é—®é¢˜çš„ï¼Œé—®é¢˜å‡ºç°åœ¨å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºï¼Œæˆ–è€…è¯´å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºä¹Ÿæ²¡é—®é¢˜ï¼Œé—®é¢˜å‡ºç°åœ¨å¤šçº¿ç¨‹å¯¹å…±äº«å˜é‡è¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™**ï¼Œå‡ºç°äº†é—®é¢˜å½“ç„¶å°±è¦è§£å†³ï¼Œè¯·æ¥ç€å¾€ä¸‹çœ‹<span style="color:green">å¤§æ ‡é¢˜[äºŒ]å°±æ˜¯è§£å†³æ–¹æ¡ˆ</span>

å¯¹å…±äº«èµ„æºå¤šçº¿ç¨‹è¯»å†™æ“ä½œçš„ä»£ç å—ç§°ä¸º**ä¸´ç•ŒåŒº**ï¼Œå¤šçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…è¿è¡Œï¼Œç”±äºå­—èŠ‚ç æŒ‡ä»¤æ‰§è¡Œé¡ºåºä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ç§°ä¸ºå‘ç”Ÿ**ç«æ€æ¡ä»¶**

```java
static int i = 0;
static void increment()
//ä¸´ç•ŒåŒº
{	i++;	}
static void decrement()
//ä¸´ç•ŒåŒº
{	i--;	}
```

## äºŒã€synchronized

### 1.ä»€ä¹ˆæ˜¯synchronizedï¼Ÿ

`synchronized`åˆç§°å¯¹è±¡é”ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰å¯¹è±¡é”ï¼Œå…¶ä»–çº¿ç¨‹æƒ³è¦è·å–å¯¹è±¡é”æ—¶ä¼šè¢«é˜»å¡

`synchronized`ç”¨äºè§£å†³å¤šçº¿ç¨‹æ“ä½œåŒä¸€èµ„æºæ—¶æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œå³**èµ„æºäº‰æŠ¢é—®é¢˜**ï¼Œä¿è¯æŒæœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒæŒ‡ä»¤äº¤æ›¿è¿è¡Œï¼Œè§£å†³å¹¶å‘ç¼–ç¨‹ä¸‰å¤§ç‰¹æ€§ä¹‹**åŸå­æ€§**

![1658300586029](../7.JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/assets/1658300586029.png)

![1658300599862](../7.JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/assets/1658300599862.png)

### 2.synchronizedå¯é‡å…¥è¯æ˜

å¯é‡å…¥è¡¨ç¤ºè‡ªå·±å¯ä»¥ç¬¬äºŒæ¬¡è·å¾—é”ï¼Œè‹¥ä¸å¯é‡å…¥é‚£ä¹ˆè‡ªå·±ç¬¬äºŒæ¬¡è·å–é”æ—¶ä¹Ÿå°†è¢«é”ä½

```java
public class Re_synchronized {
    public synchronized void method1() {
        //mainçº¿ç¨‹è·å–é”
        System.out.println("11111");
        method2();//è‹¥æ˜¯éå¯é‡å…¥ï¼Œç”±äºmethod1æœ‰é”ï¼Œå†å»method2ä¹Ÿéœ€è¦é”ï¼Œæ–¹æ³•ä¼šé˜»å¡åœ¨æ­¤
    }

    public synchronized void method2() {
        //mainçº¿ç¨‹è·å–é”
        System.out.println("22222");
    }

    public static void main(String[] args) {
        Re_synchronized re = new Re_synchronized();
        re.method1();
    }
}
```

### 3.synchronizedè§£å†³å…±äº«å¸¦æ¥çš„é—®é¢˜

#### 3.1.synchronizedä»£ç å—

è¯­æ³•æ ¼å¼å¦‚ä¸‹

```java
synchronized(å¯¹è±¡)//çº¿ç¨‹1ï¼Œçº¿ç¨‹2(blocked)
{
	ä¸´ç•ŒåŒº
}
```

è§£å†³é—®é¢˜çš„ä»£ç å¦‚ä¸‹

```java
static int i = 0;
static final Object room = new Object();

public static void main(String[] args) throws InterruptedException {
	Thread t1 = new Thread(() -> {
		synchronized (room) {
            i++;
        }
	}, "t1");
    
	Thread t2 = new Thread(() -> {
		synchronized (room) {
            i--;
        }
	}, "t2");
    
	t1.start();
	t2.start();
	t1.join();
	t2.join();
	System.out.println(i);
}
```

ä»¥ä¸Šä»£ç å¦‚ä½•ç†è§£å‘¢ï¼Ÿè¯·ç»§ç»­å¾€ä¸‹åº·

`synchronized(å¯¹è±¡)`ä¸­çš„å¯¹è±¡ç›¸å½“äºä¸€ä¸ªæˆ¿é—´`room`ï¼Œè¯¥æˆ¿é—´åªæœ‰å”¯ä¸€çš„å…¥å£ï¼Œæ¯æ¬¡åªèƒ½æœ‰ä¸€äººè¿›å…¥ï¼Œçº¿ç¨‹t1ã€t2æƒ³è±¡æˆä¸¤ä¸ªäººï¼Œå½“çº¿ç¨‹t1æ‰§è¡Œ`synchronized(room)`ï¼Œç›¸å½“äºt1åˆ°è¾¾æˆ¿é—´å°±æŠŠæˆ¿é—¨é”ä¸Šï¼Œå¹¶æ‹¿èµ°äº†é’¥åŒ™ï¼Œåœ¨æˆ¿é—´å†…æ‰§è¡Œ`i++`ï¼Œè‹¥æ­¤æ—¶t2æ‰§è¡Œ`synchronized(room)`ï¼Œä½†å‘ç°æˆ¿é—¨è¢«é”ä½ï¼Œå°±åªèƒ½åœ¨é—¨å¤–ç­‰ï¼Œå‘ç”Ÿé˜»å¡ï¼Œæ°å¥½æ­¤æ—¶çº¿ç¨‹t1çš„CPUæ—¶é—´ç‰‡ç”¨å®Œï¼Œå³ä½¿ç”¨æˆ¿é—´çš„æ—¶é—´ç”¨å®Œï¼Œé‚£ä¹ˆt1å°†è¢«æå‡ºé—¨å¤–ï¼Œæ³¨æ„**t1è¢«æå‡ºé—¨å¤–æ—¶è¿˜æ˜¯å¸¦ç€é’¥åŒ™çš„ï¼Œè€Œä¸”æˆ¿é—´é—¨ä¹Ÿæ²¡å¼€**ï¼Œæ‰€ä»¥t2è¿˜æ˜¯åœ¨é—¨å¤–ç­‰ï¼Œç­‰å¾…CPUå†æ¬¡è½®è¯¢åˆ°t1æ—¶ï¼Œä»–å¸¦ç€é’¥åŒ™å…‰è£å›å½’ï¼Œt1å†æ¬¡å ç”¨æˆ¿é—´ï¼Œå½“t1æ‰§è¡Œå®Œ`synchronized{}`å†…çš„ä»»åŠ¡æ‰ä¼šå¼€é—¨å‡ºæ¥ï¼Œå”¤é†’å¹¶æŠŠé”äº¤ç»™t2ï¼Œè¿™æ˜¯t2æ‰å¯ä»¥è¿›å…¥æˆ¿é—´ï¼Œç»§ç»­å…³é—¨...

Javaæ˜¯é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œæ‰€ä»¥é¢å‘å¯¹è±¡æ”¹è¿›

```java
class Room {
	int value = 0;
    
	public void increment() {
		synchronized (this) {
			value++;
        }
	}
    public void decrement() {
        synchronized (this) {
            value--;
        }
    }
    public int get() {
        synchronized (this) {
            return value;
        }
    }
}

public class Test1 {
	public static void main(String[] args) throws InterruptedException {
		Room room = new Room();
        
		Thread t1 = new Thread(() -> {
			room.increment();
		}, "t1");
        
		Thread t2 = new Thread(() -> {
			room.decrement();
		}, "t2");
        
		t1.start();
		t2.start();
		t1.join();
		t2.join();
		System.out.println(room.get());
	}
}
```

ä»¥ä¸Šé€šä¿—çš„è¡¨è¾¾ç›¸ä¿¡ä½ å·²ç»ç†è§£äº†`synchronized(){}`çš„å·¥ä½œåŸç†ï¼Œ**å®é™…`synchronized`ä½¿ç”¨å¯¹è±¡é”ä¿è¯ä¸´ç•ŒåŒºä»£ç çš„åŸå­æ€§ï¼Œä½¿ä¸´ç•ŒåŒºçš„æ“ä½œä¸å¯åˆ†å‰²**ï¼Œç»§ç»­è¯·æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ğŸ¤¯ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ä¿®æ”¹æµ‹è¯•ä»£ç å¦‚ä¸‹

â‘ åœ¨`i++`å’Œ`i--`å¤–åŠ ä¸€å±‚`for`å¾ªç¯ï¼Œå†æŠŠ`synchronized(obj)`æ”¾åœ¨`for`å¾ªç¯çš„å¤–é¢å¦‚ä½•ç†è§£ï¼Ÿ**åŸå­æ€§**

â‘¡å¦‚æœ`t1 synchronized(obj1)`è€Œ`t2 synchronized(obj2)`ä¼šæ€æ ·è¿ä½œï¼Ÿ**é”å¯¹è±¡**

```java
//è‹¥t1å…ˆæ‰§è¡Œï¼Œè¿›å…¥obj1æˆ¿é—´ï¼Œå…³é—¨å–é”
//t1ä¸­é€”è¢«è¸¢å‡ºæˆ¿é—´ï¼Œt2å¼€å§‹æ‰§è¡Œï¼Œä½†t2è¿›å…¥çš„æ˜¯obj2æˆ¿é—´ï¼ŒåŒæ ·å…³é—¨å–é”
//è‹¥t2é¡ºåˆ©è¿è¡Œå®Œï¼Œåˆ™ä¼šå†æ¬¡åˆ‡å›t1ï¼Œå³ç»“æœä¸´ç•ŒåŒºå†…ä»£ç æ— æ³•ä¿è¯åŸå­æ€§
public class Test02 {
    static final Object room1 = new Object();
    static final Object room2 = new Object();

    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            synchronized (room1) {
                System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
                try {
                    Thread.sleep(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");

            }
        }, "t1");

        Thread t2 = new Thread(() -> {
            synchronized (room2) {
                System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
                try {
                    Thread.sleep(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
            }
        }, "t2");

        t1.start();
        t2.start();
        t1.join();
        t2.join();
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t2å¼€å§‹è¿è¡Œ
t2è¿è¡Œç»“æŸ
t1è¿è¡Œç»“æŸ
```

â‘¢å¦‚æœ`t1 synchronized(obj)`è€Œ`t2`æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚ä½•ç†è§£ï¼Ÿ**é”å¯¹è±¡**

```java
//è‹¥t1å…ˆæ‰§è¡Œï¼Œè¿›å…¥obj1æˆ¿é—´ï¼Œå…³é—¨å–é”
//t1ä¸­é€”è¢«è¸¢å‡ºæˆ¿é—´ï¼Œt2å¼€å§‹æ‰§è¡Œï¼Œä½†t2ä¸å­˜åœ¨æˆ¿é—´çš„æ¦‚å¿µï¼Œæ‰€ä»¥å®ƒè¿è¡Œå®ƒçš„
//è‹¥å®ƒä¸­é€”CPUæ—¶é—´ç‰‡ç”¨å®Œï¼Œé‚£ä¹ˆt1ä¼šå¸¦é”å›å½’åˆ°obj1ï¼Œå‡è®¾æ­¤æ—¶t1å®Œæ¯•ï¼Œæ¥ç€åˆ‡å›t2ç›´åˆ°ç»“æŸï¼Œæ‰€ä»¥è¿˜æ˜¯æ— æ³•ä¿è¯åŸå­æ€§
public class Test03 {
    static final Object room1 = new Object();
    static final Object room2 = new Object();

    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {//åŠ é”
            synchronized (room1) {
                System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
                try {
                    Thread.sleep(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");

            }
        }, "t1");

        Thread t2 = new Thread(() -> {//ä¸åŠ é”
            System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
        }, "t2");

        t1.start();
        t2.start();
        t1.join();
        t2.join();
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t2å¼€å§‹è¿è¡Œ
t2è¿è¡Œç»“æŸ
t1è¿è¡Œç»“æŸ
```

#### 3.2.synchronizedæ–¹æ³•

è¯­æ³•æ ¼å¼å¦‚ä¸‹

```java
class Test{
	public synchronized void test() {
        ...
	}
}
ç­‰ä»·äº
class Test{
	public void test() {
		synchronized(this) {
			...
		}
	}
}
```

```java
class Test{
	public synchronized static void test() {
        ...
	}
}
ç­‰ä»·äº
class Test{
	public static void test() {
		synchronized(Test.class) {
			...
		}
	}
}
```

è§£å†³é—®é¢˜çš„ä»£ç å¦‚ä¸‹ï¼Œç›´æ¥é¢å‘å¯¹è±¡

```java
class Room {
	int value = 0;
    
	public synchronized void increment() {
		value++;
	}
    public synchronized void decrement() {
        value--;
    }
    public synchronized int get() {
        return value;
    }
}

public class Test1 {
	public static void main(String[] args) throws InterruptedException {
		Room room = new Room();
        
		Thread t1 = new Thread(() -> {
			room.increment();
		}, "t1");
        
		Thread t2 = new Thread(() -> {
			room.decrement();
		}, "t2");
        
		t1.start();
		t2.start();
		t1.join();
		t2.join();
		System.out.println(room.get());
	}
}
```

ä¸ºäº†æ›´å¥½çš„ç†è§£**å¯¹è±¡é”**ï¼Œè¯·çœ‹ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼Œå¹¶åˆ†æè¾“å‡ºæƒ…å†µ

```java
//å†™åœ¨æ–¹æ³•ä¸Šçš„synchronizedå®é™…é”çš„ä¹Ÿæ˜¯å¯¹è±¡ï¼Œçœ‹ä»¥ä¸Šçš„æ‹†è§£ä»£ç å°±å¯ä»¥çŸ¥é“
//æ‰€ä»¥å°±ç›¸å½“äºt1å’Œt2åŒæ—¶äº‰æŠ¢æˆ¿é—´n1çš„ä½¿ç”¨æƒï¼Œè‹¥t1è¿›å…¥æˆ¿é—´n1å°±å°†æˆ¿é—¨é”ä¸Šï¼Œå¹¶ä¸”æŒæœ‰é”ï¼Œä¿è¯åŸå­æ€§
public class Test01 {
    public static void main(String[] args) {
        Number1 n1 = new Number1();
        new Thread(() -> { n1.a(); }, "t1").start();
        new Thread(() -> { n1.b(); }, "t2").start();
    }
}

class Number1 {
    public synchronized void a() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }

    public synchronized void b() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t1è¿è¡Œç»“æŸ
t2å¼€å§‹è¿è¡Œ
t2è¿è¡Œç»“æŸ
```

```java
//è¿™å…¶å®å°±ç›¸å½“äºä¸€ä¸ªåŠ é”ä¸€ä¸ªæ²¡åŠ é”çš„æƒ…å†µï¼Œè‹¥t1å…ˆæ‰§è¡Œï¼Œè¿›å…¥n1æˆ¿é—´ï¼Œå…³é—¨å–é”
//t1ä¸­é€”è¢«è¸¢å‡ºæˆ¿é—´ï¼Œt2å¼€å§‹æ‰§è¡Œï¼Œä½†t2ä¸å­˜åœ¨æˆ¿é—´çš„æ¦‚å¿µï¼Œæ‰€ä»¥å®ƒè¿è¡Œå®ƒçš„
//è‹¥å®ƒä¸­é€”CPUæ—¶é—´ç‰‡ç”¨å®Œï¼Œé‚£ä¹ˆt1ä¼šå¸¦é”å›å½’åˆ°n1ï¼Œå‡è®¾æ­¤æ—¶t1å®Œæ¯•ï¼Œæ¥ç€åˆ‡å›t2ç›´åˆ°ç»“æŸï¼Œæ‰€ä»¥è¿˜æ˜¯æ— æ³•ä¿è¯åŸå­æ€§
public class Test02 {
    public static void main(String[] args) {
        Number2 n1 = new Number2();
        new Thread(() -> { n1.a(); }, "t1").start();
        new Thread(() -> { n1.b(); }, "t2").start();
    }
}

class Number2 {
    public synchronized void a() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }

    public void b() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t2å¼€å§‹è¿è¡Œ
t1è¿è¡Œç»“æŸ
t2è¿è¡Œç»“æŸ
```

```java
//è¿™ä¸ªä¸è®²äº†ï¼Œä¹Ÿæ— æ³•ä¿è¯åŸå­æ€§ï¼Œä¸åŒå¯¹è±¡ä¸åŒæˆ¿å­ä¸åŒé”
public class Test03 {
    public static void main(String[] args) {
        Number3 n1 = new Number3();
        Number3 n2 = new Number3();
        new Thread(() -> { n1.a(); }, "t1").start();
        new Thread(() -> { n2.b(); }, "t2").start();
    }
}

class Number3 {
    public synchronized void a() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }

    public synchronized void b() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t2å¼€å§‹è¿è¡Œ
t1è¿è¡Œç»“æŸ
t2è¿è¡Œç»“æŸ
```

ä¸ºäº†æ›´å¥½çš„ç†è§£**å¯¹è±¡é”ä¸ç±»é”**ï¼Œè¯·çœ‹ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼Œå¹¶åˆ†æè¾“å‡ºæƒ…å†µ

```java
//t1é€šè¿‡n1è°ƒç”¨a()ï¼Œstaticé”çš„æ˜¯ç±»æœ¬èº«ï¼Œè€Œt2é€šè¿‡n1è°ƒç”¨b()ï¼Œé”çš„æ˜¯n1å¯¹è±¡ï¼Œæ‰€ä»¥ä¸¤è€…é”çš„ä¸åŒï¼Œä¸ä¿è¯åŸå­æ€§
public class Test04 {
    public static void main(String[] args) {
        Number4 n1 = new Number4();
        new Thread(() -> { n1.a(); }, "t1").start();
        new Thread(() -> { n1.b(); }, "t2").start();
    }
}

class Number4 {
    public static synchronized void a() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }

    public synchronized void b() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t2å¼€å§‹è¿è¡Œ
t2è¿è¡Œç»“æŸ
t1è¿è¡Œç»“æŸ
```

```java
//t1é€šè¿‡n1è°ƒç”¨a()ï¼Œstaticé”çš„æ˜¯ç±»æœ¬èº«ï¼Œè€Œt2é€šè¿‡n2è°ƒç”¨b()ï¼Œé”çš„æ˜¯n2å¯¹è±¡ï¼Œæ‰€ä»¥ä¸¤è€…é”çš„ä¸åŒï¼Œä¸ä¿è¯åŸå­æ€§
public class Test05 {
    public static void main(String[] args) {
        Number5 n1 = new Number5();
        Number5 n2 = new Number5();
        new Thread(() -> { n1.a(); }, "t1").start();
        new Thread(() -> { n2.b(); }, "t2").start();
    }
}

class Number5 {
    public static synchronized void a() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }

    public synchronized void b() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t2å¼€å§‹è¿è¡Œ
t2è¿è¡Œç»“æŸ
t1è¿è¡Œç»“æŸ
```

```java
//t1é€šè¿‡n1è°ƒç”¨a()ï¼Œstaticé”çš„æ˜¯Number6ç±»æœ¬èº«ï¼Œè€Œt2é€šè¿‡n1è°ƒç”¨b()ï¼Œstaticé”çš„æ˜¯Number6ç±»æœ¬èº«ï¼Œæ‰€ä»¥ä¸¤è€…é”çš„ç›¸åŒï¼Œä¿è¯åŸå­æ€§
public class Test06 {
    public static void main(String[] args) {
        Number6 n1 = new Number6();
        new Thread(() -> { n1.a(); }, "t1").start();
        new Thread(() -> { n1.b(); }, "t2").start();
    }
}

class Number6 {
    public static synchronized void a() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }

    public static synchronized void b() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t1è¿è¡Œç»“æŸ
t2å¼€å§‹è¿è¡Œ
t2è¿è¡Œç»“æŸ
```

```java
//t1é€šè¿‡n1è°ƒç”¨a()ï¼Œstaticé”çš„æ˜¯Number7ç±»æœ¬èº«ï¼Œè€Œt2é€šè¿‡n2è°ƒç”¨b()ï¼Œstaticé”çš„æ˜¯Number7ç±»æœ¬èº«ï¼Œæ‰€ä»¥ä¸¤è€…é”çš„ç›¸åŒï¼Œä¿è¯åŸå­æ€§
public class Test07 {
    public static void main(String[] args) {
        Number6 n1 = new Number6();
        Number6 n2 = new Number6();
        new Thread(() -> { n1.a(); }, "t1").start();
        new Thread(() -> { n2.b(); }, "t2").start();
    }
}

class Number7 {
    public static synchronized void a() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }

    public static synchronized void b() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
t1è¿è¡Œç»“æŸ
t2å¼€å§‹è¿è¡Œ
t2è¿è¡Œç»“æŸ
```

**æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åä¼šé‡Šæ”¾é”**

```java
public class Test01 {
    public static void main(String[] args) {
        Number1 n1 = new Number1();
        new Thread(() -> { n1.a(); }, "t1").start();
        new Thread(() -> { n1.b(); }, "t2").start();
    }
}

class Number1 {
    public synchronized void a() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        throw new RuntimeException();
        //System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }

    public synchronized void b() {
        System.out.println(Thread.currentThread().getName() + "å¼€å§‹è¿è¡Œ");
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "è¿è¡Œç»“æŸ");
    }
}
--------------------------------------------------
t1å¼€å§‹è¿è¡Œ
Exception in thread "t1" java.lang.RuntimeException
	at com.yc.Test00_synchronized.exception.Number1.a(Test01.java:31)
	at com.yc.Test00_synchronized.exception.Test01.lambda$main$0(Test01.java:14)
	at java.lang.Thread.run(Thread.java:745)
t2å¼€å§‹è¿è¡Œ
t2è¿è¡Œç»“æŸ
```

## ä¸‰ã€å˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§åˆ†æ

### 1.æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡æ˜¯å¦å®‰å…¨ï¼Ÿ

è‹¥æ²¡è¢«å…±äº«åˆ™çº¿ç¨‹å®‰å…¨ï¼Œè‹¥è¢«å…±äº«åˆ™æ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µï¼Œå¦‚æœåªæœ‰è¯»æ“ä½œåˆ™çº¿ç¨‹å®‰å…¨ï¼Œå¦‚æœæœ‰è¯»å†™æ“ä½œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨

### 2.å±€éƒ¨å˜é‡æ˜¯å¦å®‰å…¨ï¼Ÿ

å±€éƒ¨å˜é‡æœ¬èº«æ˜¯å®‰å…¨çš„ï¼Œä½†å±€éƒ¨å˜é‡çš„å¼•ç”¨å¯¹è±¡æœªå¿…ï¼Œè‹¥å¯¹è±¡çš„ä½œç”¨åŸŸåœ¨æ–¹æ³•å†…éƒ¨åˆ™æ˜¯å®‰å…¨çš„ï¼Œè‹¥å¯¹è±¡çš„ä½œç”¨åŸŸè¿˜åœ¨æ–¹æ³•å¤–éƒ¨ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼Œä¸‹é¢å…·ä½“åˆ†æå±€éƒ¨å˜é‡çš„å®‰å…¨æ€§

è‹¥æ˜¯åŸºæœ¬ç±»å‹çš„å±€éƒ¨å˜é‡ï¼Œä»£ç å¦‚ä¸‹ï¼Œåˆ™è¯¥å±€éƒ¨å˜é‡åªä¼šè¢«ä¿å­˜åœ¨æ¯ä¸ªçº¿ç¨‹çš„è™šæ‹Ÿæœºæ ˆä¸­çš„æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œå¦‚ä¸‹å›¾

```java
public static void test1() {
	int i = 10;
	i++;
}
```

![1658494849006](assets/1658494849006.png)

è‹¥æ˜¯å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œå…ˆçœ‹ä¸€ä¸ªæˆå‘˜å˜é‡çš„ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼Œç”±äºlistæ˜¯æˆå‘˜å˜é‡ï¼Œè€Œçº¿ç¨‹ä¸­ä½¿ç”¨çš„æ˜¯å †ä¸­åŒä¸€ä¸ªlistï¼Œå¦‚å›¾ï¼Œæ‰€ä»¥ä¸¤ä¸ªçº¿ç¨‹è½®è¯¢ï¼Œä¸”çº¿ç¨‹è¿è¡Œçš„è¿›åº¦ä¸åŒï¼Œæ‰€ä»¥å¯èƒ½å¯¼è‡´`method3`æŠ¥é”™

```java
class ThreadUnsafe {
	ArrayList<String> list = new ArrayList<>();
	public void method1(int loopNumber) {
		for (int i = 0; i < loopNumber; i++) {
			// { ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶
			method2();
			method3();
			// } ä¸´ç•ŒåŒº
		}
	}
	private void method2() {
		list.add("1");
	}
	private void method3() {
		list.remove(0);
	}
}
```

```java
static final int THREAD_NUMBER = 2;
static final int LOOP_NUMBER = 200;
public static void main(String[] args) {
	ThreadUnsafe test = new ThreadUnsafe();
	for (int i = 0; i < THREAD_NUMBER; i++) {//åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹
		new Thread(() -> {
			test.method1(LOOP_NUMBER);
		}, "Thread" + i).start();
	}
}
```

![1658495921869](assets/1658495921869.png)

è‹¥æ˜¯å¼•ç”¨ç±»å‹çš„å±€éƒ¨å˜é‡ï¼Œä»£ç å¦‚ä¸‹ï¼Œåˆ™liståœ¨çº¿ç¨‹å†…éƒ¨è¢«åˆ›å»ºï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯¹åº”ä¸€ä¸ªlistï¼Œå¦‚å›¾ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°æŠ¥é”™é—®é¢˜

```java
class ThreadSafe {
	public final void method1(int loopNumber) {
		ArrayList<String> list = new ArrayList<>();
		for (int i = 0; i < loopNumber; i++) {
			method2(list);
			method3(list);
		}
	}
	private void method2(ArrayList<String> list) {
		list.add("1");
	}
	private void method3(ArrayList<String> list) {
		list.remove(0);
	}
}
```

![1658496006516](assets/1658496006516.png)

è¯•é—®`method2`å’Œ`method3`çš„ä¿®é¥°ç¬¦å˜ä¸º`public`è¿˜ä¼šæ˜¯å®‰å…¨çš„å—ï¼Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´ä¸å®‰å…¨ï¼Œä»æ­¤å¤„å¯ä»¥çœ‹å‡º`private`æˆ–`final`æä¾›å®‰å…¨çš„æ„ä¹‰æ‰€åœ¨ï¼Œè¯·ä½“ä¼šå¼€é—­åŸåˆ™ä¸­çš„é—­

* å…¶å®ƒçº¿ç¨‹è°ƒç”¨`method2`æˆ–`method3`
* åœ¨å‰ä¸€ç§æƒ…å†µçš„åŸºç¡€ä¸Šï¼Œä¸ºThreadSafeç±»æ·»åŠ å­ç±»ï¼Œå­ç±»è¦†ç›–`method2`æˆ–`method3`

### 3.å¸¸è§çº¿ç¨‹å®‰å…¨ç±»

Integerã€Stringã€StringBufferã€Randomã€Vectorã€Hashtableã€java.util.concurrentåŒ…ä¸‹çš„ç±»ï¼Œå…·ä½“å®ç°è¯·è‡ªå·±çœ‹æºç 

## å››ã€Monitor

### 1.Monitoræ˜¯ä»€ä¹ˆï¼Ÿ

Monitorå¯ä»¥ç¿»è¯‘æˆç›‘è§†å™¨æˆ–è€…ç®¡ç¨‹ï¼Œç”±JVMæä¾›çš„Javaå¯¹è±¡ç›‘è§†å™¨

### 2.ObjectMonitorç»“æ„ä½“

Monitoræ˜¯åŸºäºC++ä»£ç ä¸­çš„ObjectMonitorç»“æ„ä½“å®ç°çš„ï¼ŒObjectMonitorç»“æ„ä½“å¦‚ä¸‹

```
ObjectMonitor() {
    _header       = NULL;
    _count        = 0; // ç”±äºsynchronizedæ˜¯å¯é‡å…¥é”ï¼Œcountç”¨äºè®°å½•å½“å‰å¯¹è±¡é”æ‹¥æœ‰è€…çº¿ç¨‹è·å–é”çš„æ¬¡æ•°
    _waiters      = 0,
    _recursions   = 0;
    _object       = NULL;
    _owner        = NULL;
    _WaitSet      = NULL; // è°ƒç”¨äº†waitæ–¹æ³•ï¼Œå¤„äºWAIT/TIME_WAITçš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ°WaitSet
    _WaitSetLock  = 0 ;
    _Responsible  = NULL ;
    _succ         = NULL ;
    _cxq          = NULL ;
    FreeNext      = NULL ;
    _EntryList    = NULL ; // å¤„äºç­‰å¾…é”blockçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ°EntryList
    _SpinFreq     = 0 ;
    _SpinClock    = 0 ;
    OwnerIsThread = 0 ;
}
```

### 3.MonitoråŸç†

JVMä¸­Monitorä¸»è¦åŸºäºObjectMonitorç»“æ„ä½“ä¸­çš„**EntrySetã€WaitSetä¸¤ä¸ªé˜Ÿåˆ—ä»¥åŠè®¡æ•°å™¨count**å®ç°çš„

å½“çº¿ç¨‹æ‰§è¡Œåˆ°ä¸´ç•ŒåŒºæ—¶ï¼Œé¦–å…ˆæŸ¥çœ‹å¯¹è±¡å¤´ä¸­æ˜¯å¦å·²æœ‰å…³è”çš„Monitorå¯¹è±¡ï¼Œå¦‚æœå·²å…³è”åˆ™å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°Monitorå¯¹è±¡çš„EntryListé˜Ÿåˆ—ï¼Œå¦‚æœæ²¡å…³è”åˆ™å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå…³è”ååˆ™è¡¨ç¤ºMonitorå¯¹è±¡çš„æ‹¥æœ‰è€…å˜æˆå½“å‰çº¿ç¨‹ï¼Œå³å½“å‰çº¿ç¨‹è·å–åˆ°æŸä¸ªå¯¹è±¡é”ï¼Œå˜æˆé”çš„æ‹¥æœ‰è€…ï¼Œå‡†å¤‡å¼€å§‹è¿è¡Œä¸´ç•ŒåŒºçš„ä»£ç ï¼Œæ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤`monitorenter`ï¼Œæ­¤æ—¶`count++`ï¼Œå½“è¯¥çº¿ç¨‹å°è¯•å†æ¬¡è·å–é”æ˜¯æ‰§è¡Œ`count++`ï¼Œè€Œä¸æ˜¯è¿›å…¥EntryListé˜Ÿåˆ—é˜»å¡ç­‰å¾…ï¼Œæ­¤å¤„ä½“ç°å¯é‡å…¥ï¼Œå½“ä¸´ç•ŒåŒºçš„ä»£ç åº”å®Œæˆæˆ–å¼‚å¸¸é€€å‡ºæ—¶ä½¿`count--`ï¼Œå½“countå˜ä¸º0åˆ™å½“å‰çº¿ç¨‹é‡Šæ”¾é”ï¼ŒMonitorå¯¹è±¡é‡æ–°åˆ°EntryListé˜Ÿåˆ—é€‰ä¸€ä¸ªæ–°çš„æ‹¥æœ‰è€…æŒæœ‰é”ï¼Œä¸€èˆ¬ä½¿éå…¬å¹³ç«äº‰ï¼Œå½“æ‹¥æœ‰é”çš„çº¿ç¨‹è°ƒç”¨`wait()`åˆ™çº¿ç¨‹è¿›å…¥WaitSetï¼Œç­‰å¾…`notify()`å”¤é†’æˆ–ç­‰å¾…æ—¶é—´åˆ°è¾¾æ‰èƒ½å˜æˆé”çš„æ‹¥æœ‰è€…ï¼Œæ‰€ä»¥`wait()`æ˜¯é‡Šæ”¾é”çš„

ä¸€ä¸ªå¯¹è±¡å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå½“ä¸€ä¸ªå¯¹è±¡æŒæœ‰Monitorå¯¹è±¡åœ°å€åå°±å¤„ç†é”å®šçŠ¶æ€ï¼Œ**JVMç»™æ¯ä¸ªå¯¹è±¡å’Œclasså­—èŠ‚ç éƒ½ä¼šè®¾ç½®ä¸€ä¸ªç›‘å¬å™¨Monitor**ï¼Œç”¨äºæ£€æµ‹å¹¶å‘ä»£ç çš„é‡å…¥ï¼Œ**ä¸åŠ synchronizedçš„å¯¹è±¡ä¸ä¼šå…³è”Monitor**

## äº”ã€waitå’Œnotify

åœ¨[çº¿ç¨‹åŸºç¡€](/7.JUCå¹¶å‘ç¼–ç¨‹/çº¿ç¨‹åŸºç¡€)å…¶å®å·²ç»äº†è§£è¿‡`wait()`å’Œ`notify()`å’Œ`notifyAll()`ï¼Œæ­¤å¤„å°±åªæä¸€å¥`wait()`ä¼šé‡Šæ”¾é”ï¼Œä¸”`wait()`å¿…é¡»åœ¨`synchronized`å†…éƒ¨ä½¿ç”¨ï¼Œå³å¿…é¡»é…åˆ`Monitor`ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥æ¨¡æ‹Ÿåœºæ™¯æ­¥æ­¥å‡çº§

â‘ ä½¿ç”¨`synchronized+sleep`çš„åœºæ™¯å¯¼è‡´ä¸é‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿè¿›ä¸æ¥ï¼Œå°±ä¸€ç›´é˜»å¡ï¼Œæ•ˆç‡å¤ªä½ï¼Œè¯·çœ‹â‘¡

```java
import java.util.concurrent.atomic.AtomicBoolean;
import static java.lang.Thread.sleep;

/**
 * å‡è®¾æŸçº¿ç¨‹éœ€è¦å·¥ä½œä¸­éœ€è¦å–æ°´æ‰èƒ½ç»§ç»­å·¥ä½œï¼Œä»¥ä¸‹æ¨¡æ‹Ÿåœºæ™¯
 */
public class Test01 {
    public static void main(String[] args) throws InterruptedException {
        Object room = new Object();//å¯¹è±¡é”
        AtomicBoolean has = new AtomicBoolean(false);//è¿™åªæ˜¯ä¸€ä¸ªåŸå­æ“ä½œç±»ï¼Œå…ˆä¸ç®¡

        new Thread(() -> {//è¿™æ˜¯ä¸€ä¸ªå·¥ä½œçº¿ç¨‹
            synchronized (room) {
                System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹å·¥ä½œ");
                System.out.println("æœ‰æ°´å—ï¼Ÿ" + has);
                if (!has.get()) {
                    System.out.println("æ²¡æ°´ï¼Ÿé‚£ä¸å¹²äº†ï¼Œæ‰¾ä¸ªäººæ¥ç»™æˆ‘é€æ°´");
                    System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹ä¼‘æ¯");
                    try {
                        sleep(2);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("æœ‰æ°´å—ï¼Ÿ" + has);
                if (has.get()) {
                    System.out.println("ç»ˆäºå–åˆ°æ°´äº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»");
                    System.out.println("--" + Thread.currentThread().getName() + "ç»§ç»­è¿è¡Œ");
                }
                System.out.println("--" + Thread.currentThread().getName() + "å·¥ä½œç»“æŸ");
            }
        }, "å·¥ä½œçº¿ç¨‹").start();

        for (int i = 0; i < 5; i++) {//å¤§å“¥ä¸èƒ½ä¸€ç›´å¹²æ´»ï¼Œæ€»æœ‰ç»“æŸçš„æ—¶å€™ï¼Œä½†æ˜¯æˆ¿é—´é‡ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªäººå¹²æ´»
            new Thread(() -> {
                System.out.println("--" + Thread.currentThread().getName() + "ç­‰å¾…æˆ¿é—´ä½¿ç”¨æƒ");
                synchronized (room) {
                    System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹å·¥ä½œ");
                    System.out.println("--" + Thread.currentThread().getName() + "å·¥ä½œç»“æŸ");
                }
            }, "t" + (i + 2)).start();
        }

        sleep(1);//ä¸»çº¿ç¨‹ç¡ä¸€ä¼šå†è®©å°å¼Ÿé€æ°´

        new Thread(() -> {//è¿™æ˜¯ç»™å¤§å“¥é€æ°´çš„çº¿ç¨‹ï¼Œæ³¨æ„ä¸èƒ½å»æŠ¢å¤§å“¥çš„æˆ¿é—´å•Šï¼Œå¤§å“¥åœ¨é‡Œé¢æ‹¿ç€é’¥åŒ™è¿˜é”ç€é—¨å‘¢ï¼ŒæŠ¢å¤§å“¥çš„é‚£è‚¯å®šæŠ¢ä¸åˆ°å•Šï¼Œæ­¤å¤„å¯ä»¥åŠ å¦ä¸€æŠŠå¯¹è±¡é”æˆ–ç›´æ¥ä¸åŠ é”
            has.set(true);
            System.out.println("å°å¼Ÿç»™é€æ°´æ¥äº†");
        }).start();
    }
}
--------------------------------------------------
--å·¥ä½œçº¿ç¨‹å¼€å§‹å·¥ä½œ
æœ‰æ°´å—ï¼Ÿfalse
æ²¡æ°´ï¼Ÿé‚£ä¸å¹²äº†ï¼Œæ‰¾ä¸ªäººæ¥ç»™æˆ‘é€æ°´
--å·¥ä½œçº¿ç¨‹å¼€å§‹ä¼‘æ¯
--t2ç­‰å¾…æˆ¿é—´ä½¿ç”¨æƒ
--t3ç­‰å¾…æˆ¿é—´ä½¿ç”¨æƒ
--t4ç­‰å¾…æˆ¿é—´ä½¿ç”¨æƒ
--t5ç­‰å¾…æˆ¿é—´ä½¿ç”¨æƒ
--t6ç­‰å¾…æˆ¿é—´ä½¿ç”¨æƒ
å°å¼Ÿç»™é€æ°´æ¥äº†
æœ‰æ°´å—ï¼Ÿtrue
ç»ˆäºå–åˆ°æ°´äº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»
--å·¥ä½œçº¿ç¨‹ç»§ç»­è¿è¡Œ
--å·¥ä½œçº¿ç¨‹å·¥ä½œç»“æŸ
--t6å¼€å§‹å·¥ä½œ
--t6å·¥ä½œç»“æŸ
--t5å¼€å§‹å·¥ä½œ
--t5å·¥ä½œç»“æŸ
--t4å¼€å§‹å·¥ä½œ
--t4å·¥ä½œç»“æŸ
--t3å¼€å§‹å·¥ä½œ
--t3å·¥ä½œç»“æŸ
--t2å¼€å§‹å·¥ä½œ
--t2å·¥ä½œç»“æŸ
```

â‘¡ä½¿ç”¨`synchronized+wait+notify`çš„åœºæ™¯ä¼šé‡Šæ”¾é”ï¼Œè§£å†³é˜»å¡é—®é¢˜ï¼Œä½†æ˜¯`notify()`åªä¼šå”¤é†’ä¸€ä¸ª`wait()`ï¼Œå¦ä¸€ä¸ªå› ä¸ºä¸€ç›´æ²¡è¢«å”¤é†’ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨ç­‰å¾…ï¼Œè¯·çœ‹â‘¢

```java
import java.util.concurrent.atomic.AtomicBoolean;
import static java.lang.Thread.sleep;

/**
 * æ¨¡æ‹Ÿt1çº¿ç¨‹éœ€è¦å–æ°´æ‰èƒ½ç»§ç»­å·¥ä½œï¼Œt2çº¿ç¨‹éœ€è¦åƒç‚¹æ°´æœæ‰èƒ½ç»§ç»­å·¥ä½œï¼Œå‡è®¾ä»–ä»¬éƒ½ç‚¹åŒä¸€ä»½å¤–å–å‘¢ï¼Ÿ
 */
public class Test02 {
    public static void main(String[] args) throws InterruptedException {
        Object room = new Object();//å¯¹è±¡é”
        AtomicBoolean has = new AtomicBoolean(false);//è¿™åªæ˜¯ä¸€ä¸ªåŸå­æ“ä½œç±»ï¼Œå…ˆä¸ç®¡

        new Thread(() -> {//t1éœ€è¦å–æ°´
            synchronized (room) {
                System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹å·¥ä½œ");
                System.out.println("æœ‰æ°´å—ï¼Ÿ" + has);
                if (!has.get()) {
                    System.out.println("æ²¡æ°´ï¼Ÿé‚£ä¸å¹²äº†ï¼Œæ‰¾ä¸ªäººæ¥ç»™æˆ‘é€æ°´");
                    System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹ä¼‘æ¯");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("æœ‰æ°´å—ï¼Ÿ" + has);
                if (has.get()) {
                    System.out.println("ç»ˆäºå–åˆ°æ°´äº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»");
                    System.out.println("--" + Thread.currentThread().getName() + "ç»§ç»­è¿è¡Œ");
                    System.out.println("--" + Thread.currentThread().getName() + "å®Œæˆå·¥ä½œåï¼Œå·¥ä½œç»“æŸ");
                } else {
                    System.out.println("ç­‰äº†è¿™ä¹ˆä¹…è¿˜ä¸ç»™æ°´ï¼Œä¸å¹²äº†");
                    System.out.println("--" + Thread.currentThread().getName() + "æœªå®Œæˆå·¥ä½œï¼Œå·¥ä½œç»“æŸ");
                }
            }
        }, "t1").start();

        new Thread(() -> {//t2éœ€è¦åƒæ°´æœ
            synchronized (room) {
                System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹å·¥ä½œ");
                System.out.println("æœ‰æ°´æœå—ï¼Ÿ" + has);
                if (!has.get()) {
                    System.out.println("æ²¡æ°´æœï¼Ÿé‚£ä¸å¹²äº†");
                    System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹ä¼‘æ¯");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("æœ‰æ°´æœå—ï¼Ÿ" + has);
                if (has.get()) {
                    System.out.println("ç»ˆäºåƒåˆ°æ°´æœäº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»");
                    System.out.println("--" + Thread.currentThread().getName() + "ç»§ç»­è¿è¡Œ");
                }
                System.out.println("--" + Thread.currentThread().getName() + "å·¥ä½œç»“æŸ");
            }
        }, "t2").start();

        sleep(1);//ä¸»çº¿ç¨‹ç¡ä¸€ä¼šå†è®©å°å¼Ÿé€æ°´

        new Thread(() -> {
            synchronized (room) {
                has.set(true);
                System.out.println("é€å¤–å–çš„æ¥äº†ï¼Œå‡ºæ¥æ‹¿");
                room.notify();
            }
        }).start();
    }
}
--------------------------------------------------
--t1å¼€å§‹å·¥ä½œ
æœ‰æ°´å—ï¼Ÿfalse
æ²¡æ°´ï¼Ÿé‚£ä¸å¹²äº†ï¼Œæ‰¾ä¸ªäººæ¥ç»™æˆ‘é€æ°´
--t1å¼€å§‹ä¼‘æ¯
--t2å¼€å§‹å·¥ä½œ
æœ‰æ°´æœå—ï¼Ÿfalse
æ²¡æ°´æœï¼Ÿé‚£ä¸å¹²äº†
--t2å¼€å§‹ä¼‘æ¯
é€å¤–å–çš„æ¥äº†ï¼Œå‡ºæ¥æ‹¿
æœ‰æ°´å—ï¼Ÿtrue
ç»ˆäºå–åˆ°æ°´äº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»
--t1ç»§ç»­è¿è¡Œ
--t1å®Œæˆå·¥ä½œåï¼Œå·¥ä½œç»“æŸ
//æ­¤å¤„ç¨‹åºå¹¶æ²¡æœ‰ç»“æŸ
```

â‘¢ä½¿ç”¨`synchronized+wait+notifyAll`çš„åœºæ™¯ä¼šé‡Šæ”¾é”ï¼Œè§£å†³é˜»å¡é—®é¢˜ï¼ŒåŒæ—¶å”¤é†’æ‰€æœ‰å› ä¸º`wait()`åœ¨ç­‰å¾…çš„çº¿ç¨‹ï¼Œä½†æ˜¯é‡‡ç”¨`if`çš„æ–¹å¼å°±åªæœ‰ä¸€æ¬¡æœºä¼šå¯ä»¥åˆ¤æ–­é˜»å¡æ¡ä»¶ï¼Œå”¤é†’ä¹‹åä¼šè·³å‡º`if`ç»§ç»­å‘ä¸‹è¿è¡Œï¼Œé‚£å¦‚æœè¢«å”¤é†’åæ¡ä»¶è¿˜æ˜¯ä¸æˆç«‹å‘¢ï¼Ÿæ‰€ä»¥éœ€è¦æ”¹è¿›æˆ`while`å¾ªç¯

```java
import java.util.concurrent.atomic.AtomicBoolean;
import static java.lang.Thread.sleep;

/**
 * æ¨¡æ‹Ÿt1çº¿ç¨‹éœ€è¦å–æ°´æ‰èƒ½ç»§ç»­å·¥ä½œï¼Œt2çº¿ç¨‹éœ€è¦åƒç‚¹æ°´æœæ‰èƒ½ç»§ç»­å·¥ä½œï¼Œå‡è®¾ä»–ä»¬éƒ½ç‚¹åŒä¸€ä»½å¤–å–å‘¢ï¼Ÿ
 */
public class Test03 {
    public static void main(String[] args) throws InterruptedException {
        Object room = new Object();//å¯¹è±¡é”
        AtomicBoolean has = new AtomicBoolean(false);//è¿™åªæ˜¯ä¸€ä¸ªåŸå­æ“ä½œç±»ï¼Œå…ˆä¸ç®¡

        new Thread(() -> {//t1éœ€è¦å–æ°´
            synchronized (room) {
                System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹å·¥ä½œ");
                System.out.println("æœ‰æ°´å—ï¼Ÿ" + has);
                while (!has.get()) {
                    System.out.println("æ²¡æ°´ï¼Ÿé‚£ä¸å¹²äº†ï¼Œæ‰¾ä¸ªäººæ¥ç»™æˆ‘é€æ°´");
                    System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹ä¼‘æ¯");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("æœ‰æ°´å—ï¼Ÿ" + has);
                if (has.get()) {
                    System.out.println("ç»ˆäºå–åˆ°æ°´äº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»");
                    System.out.println("--" + Thread.currentThread().getName() + "ç»§ç»­è¿è¡Œ");
                    System.out.println("--" + Thread.currentThread().getName() + "å®Œæˆå·¥ä½œåï¼Œå·¥ä½œç»“æŸ");
                } else {
                    System.out.println("ç­‰äº†è¿™ä¹ˆä¹…è¿˜ä¸ç»™æ°´ï¼Œä¸å¹²äº†");
                    System.out.println("--" + Thread.currentThread().getName() + "æœªå®Œæˆå·¥ä½œï¼Œå·¥ä½œç»“æŸ");
                }
            }
        }, "t1").start();

        new Thread(() -> {//t2éœ€è¦åƒæ°´æœ
            synchronized (room) {
                System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹å·¥ä½œ");
                System.out.println("æœ‰æ°´æœå—ï¼Ÿ" + has);
                while (!has.get()) {
                    System.out.println("æ²¡æ°´æœï¼Ÿé‚£ä¸å¹²äº†");
                    System.out.println("--" + Thread.currentThread().getName() + "å¼€å§‹ä¼‘æ¯");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("æœ‰æ°´æœå—ï¼Ÿ" + has);
                if (has.get()) {
                    System.out.println("ç»ˆäºåƒåˆ°æ°´æœäº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»");
                    System.out.println("--" + Thread.currentThread().getName() + "ç»§ç»­è¿è¡Œ");
                }
                System.out.println("--" + Thread.currentThread().getName() + "å·¥ä½œç»“æŸ");
            }
        }, "t2").start();

        sleep(1);//ä¸»çº¿ç¨‹ç¡ä¸€ä¼šå†è®©å°å¼Ÿé€æ°´

        new Thread(() -> {
            synchronized (room) {
                has.set(true);
                System.out.println("é€å¤–å–çš„æ¥äº†ï¼Œå‡ºæ¥æ‹¿");
                room.notifyAll();
            }
        }).start();
    }
}
--------------------------------------------------
--t1å¼€å§‹å·¥ä½œ
æœ‰æ°´å—ï¼Ÿfalse
æ²¡æ°´ï¼Ÿé‚£ä¸å¹²äº†ï¼Œæ‰¾ä¸ªäººæ¥ç»™æˆ‘é€æ°´
--t1å¼€å§‹ä¼‘æ¯
--t2å¼€å§‹å·¥ä½œ
æœ‰æ°´æœå—ï¼Ÿfalse
æ²¡æ°´æœï¼Ÿé‚£ä¸å¹²äº†
--t2å¼€å§‹ä¼‘æ¯
é€å¤–å–çš„æ¥äº†ï¼Œå‡ºæ¥æ‹¿
æœ‰æ°´æœå—ï¼Ÿtrue
ç»ˆäºåƒåˆ°æ°´æœäº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»
--t2ç»§ç»­è¿è¡Œ
--t2å·¥ä½œç»“æŸ
æœ‰æ°´å—ï¼Ÿtrue
ç»ˆäºå–åˆ°æ°´äº†ï¼Œå‡†å¤‡å¼€å§‹å¹²æ´»
--t1ç»§ç»­è¿è¡Œ
--t1å®Œæˆå·¥ä½œåï¼Œå·¥ä½œç»“æŸ
```

â‘£å°ç»“`synchronized+wait+notifyAll`çš„ä½¿ç”¨æ¶æ„

```java
synchronized(lock) {
	while(æ¡ä»¶ä¸æˆç«‹) {//å¾ªç¯æ˜¯ä¸ºäº†ä½¿è¢«å”¤é†’åçœ‹æ¡ä»¶æ—¶å€™æˆç«‹ï¼Œè‹¥å¼€å§‹ä¸æˆç«‹åˆ™ç»§ç»­ç­‰å¾…
		lock.wait();
	}
	//æ­¤å¤„æ¡ä»¶æˆç«‹ï¼Œä¸”è¢«å”¤é†’ï¼Œåˆ™å¼€å§‹å¹²æ´»
}
//å¦ä¸€ä¸ªçº¿ç¨‹
synchronized(lock) {
	lock.notifyAll();//å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹
}
```

## å…­ã€LockSupport

### 1.LockSupportæ˜¯ä»€ä¹ˆï¼Ÿ

LockSupportå†…éƒ¨å­˜åœ¨ä¸¤ä¸ªé‡è¦æ–¹æ³•ï¼Œå³`LockSupport.park()`å’Œ`LockSupport.unpark(çº¿ç¨‹å¯¹è±¡)`ï¼Œå…¶ä¸­`LockSupport.park()`ä¼šæ£€æŸ¥çº¿ç¨‹çš„è®¸å¯è¯ï¼Œè‹¥çº¿ç¨‹æ²¡æœ‰è®¸å¯è¯å°†ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°`unpark()`å¤„è·å–è®¸å¯è¯ï¼Œé»˜è®¤çº¿ç¨‹æ˜¯ä¸æŒæœ‰è®¸å¯è¯çš„ï¼›`LockSupport.unpark(çº¿ç¨‹å¯¹è±¡)`ä¼šç»™çº¿ç¨‹å¯¹è±¡å…³è”è®¸å¯è¯ï¼Œä½¿çº¿ç¨‹ä»`park()`é˜»å¡ä½ç½®è§£é™¤é˜»å¡

### 2.park&unparkå’Œwait&notifyç›¸æ¯”

`wait()`ã€`notify()`ã€`notifyAll()`å¿…é¡»é…åˆMonitorä½¿ç”¨ï¼Œå³é…åˆ`synchronized`ä½¿ç”¨ï¼Œè€Œ`park()`ã€`unpark()`ä¸å¿…

`park()`ã€`unpark()`çš„è§£é”é¡ºåºçµæ´»ï¼Œå¯ä»¥å…ˆ`unpark()`ï¼Œä½†`wait()`ã€`notify()`å°±ä¸èƒ½å…ˆ`notify()`

`park()`ã€`unpark()`ä»¥çº¿ç¨‹ä¸ºå•ä½ç²¾ç¡®é˜»å¡å’Œå”¤é†’ï¼Œä½†`notify()`åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹

### 3.ä½¿ç”¨

â‘ å…ˆ`park()`å†`unpark()`

```java
Thread thread = new Thread(() -> {
    System.out.println("å­çº¿ç¨‹å¼€å§‹park");
    //æ²¡æœ‰è®¸å¯è¯ï¼ŒæŒ‚èµ·è‡ªå·±
    LockSupport.park();
    System.out.println("å­çº¿ç¨‹ç»“æŸ");
});

thread.start();

Thread.sleep(1000);
System.out.println("ä¸»çº¿ç¨‹å¼€å§‹unpark");
//è®©å­çº¿ç¨‹æœ‰è®¸å¯è¯ï¼Œparkæ–¹æ³•è¿”å›
LockSupport.unpark(thread);
```

â‘¡å…ˆ`unpark()`å†`park()`

```java
System.out.println("å¼€å§‹pack");
//ä½¿ç”¨å½“å‰çº¿ç¨‹è·å–è®¸å¯è¯
LockSupport.unpark(Thread.currentThread());
//å†æ¬¡è°ƒç”¨parkï¼Œunparkåè°ƒç”¨parkä¼šç«‹å³è¿”å›
LockSupport.park();
System.out.println("ç»“æŸpack");
```

## ä¸ƒã€é”çš„æ´»è·ƒæ€§

### 1.æ­»é”

**ä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”**ï¼Œä¾‹å¦‚å¦‚ä¸‹æƒ…å†µ

```java
import static java.lang.Thread.sleep;

public class DeadLock {
    public static void main(String[] args) {
        Object A = new Object();
        Object B = new Object();

        Thread t1 = new Thread(() -> {
            synchronized (A) {//è·å–Aå¯¹è±¡é”
                System.out.println("lock A");
                try {
                    sleep(2);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (B) {//è·å–Bå¯¹è±¡é”
                    System.out.println("lock B");
                    System.out.println("t1è·å¾—ä¸¤æŠŠé”åçš„æ“ä½œ");
                }
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            synchronized (B) {//è·å–Bå¯¹è±¡é”
                System.out.println("lock B");
                try {
                    sleep(1);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (A) {//è·å–Aå¯¹è±¡é”
                    System.out.println("lock A");
                    System.out.println("t2è·å¾—ä¸¤æŠŠé”åçš„æ“ä½œ");
                }
            }
        }, "t2");
        t1.start();
        t2.start();
    }
}
```

IDEAå¯æŸ¥çœ‹çº¿ç¨‹ç›¸äº’ç­‰å¾…çš„æƒ…å†µ

![1658558611574](assets/1658558611574.png)

![1658558638860](assets/1658558638860.png)

### 2.æ´»é”

**ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸ**ï¼Œè¿™æ˜¯å‘ç”Ÿæ´»é”ï¼Œä¾‹å¦‚å¦‚ä¸‹æƒ…å†µ

```java
import static java.lang.Thread.sleep;

public class LiveLock {

    static volatile int count = 10;
    static final Object lock = new Object();

    public static void main(String[] args) {
        new Thread(() -> {
            // æœŸæœ›å‡åˆ° 0 é€€å‡ºå¾ªç¯
            while (count > 0) {
                try {
                    sleep(2);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                count--;
                System.out.println(count);
            }
        }, "t1").start();
        new Thread(() -> {
            // æœŸæœ›è¶…è¿‡ 20 é€€å‡ºå¾ªç¯
            while (count < 20) {
                try {
                    sleep(2);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                count++;
                System.out.println(count);
            }
        }, "t2").start();
    }
}
```

### 3.é¥¥é¥¿

å¾ˆå¤šæ•™ç¨‹ä¸­æŠŠé¥¥é¥¿å®šä¹‰ä¸º**ä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½å§‹ç»ˆå¾—ä¸åˆ°CPUè°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸ**ï¼Œé¥¥é¥¿çš„æƒ…å†µä¸æ˜“æ¼”ç¤ºï¼Œè®²è¯»å†™é”æ—¶ä¼šæ¶‰åŠé¥¥é¥¿é—®é¢˜

## å…«ã€Lock

### 1.ReentrantLock

#### 1.1.åŸºæœ¬è¯­æ³•æ ¼å¼

```java
//1.è·å–é”
reentrantLock.lock();
try {
	//ä¸´ç•ŒåŒº
} finally {
	//2.é‡Šæ”¾é”ï¼Œä¸€å®šä¸è¦å¿½ç•¥è¿™ä¸ªæ­¥éª¤
	reentrantLock.unlock();
}
```

#### 1.2.å¯é‡å…¥

å¯é‡å…¥è¡¨ç¤ºè‡ªå·±å¯ä»¥ç¬¬äºŒæ¬¡è·å¾—é”ï¼Œè‹¥ä¸å¯é‡å…¥é‚£ä¹ˆè‡ªå·±ç¬¬äºŒæ¬¡è·å–é”æ—¶ä¹Ÿå°†è¢«é”ä½ï¼Œ`synchronized`ä¹Ÿå¯é‡å…¥

```java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class Re_reentrantLock {
    //Lockæ¥å£       ReentrantLockå¯é‡å…¥é”
    Lock lock = new ReentrantLock();

    public void set() {
        try {
            lock.lock();
            System.out.println("set");
            get();//åŒä¸€ä¸ªçº¿ç¨‹åœ¨setä¸­è·å–é”åˆè°ƒç”¨geté‡æ–°è·å–åŒä¸€æŠŠé”
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();//å¿…é¡»é‡Šæ”¾é”
        }
    }

    public void get() {
        try {
            lock.lock();//ç¬¬äºŒæ¬¡è·å¾—é”
            System.out.println("get");
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    public static void main(String[] args) {
        Re_reentrantLock re = new Re_reentrantLock();
        re.set();
    }
}
```

#### 1.3.å¯æ‰“æ–­

å¯é€šè¿‡`lockInterruptibly()`åœ¨ç­‰å¾…åŠ é”çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œ`lock()`æ–¹å¼åŠ é”å°±ä¸èƒ½è¢«æ‰“æ–­äº†ï¼ŒåŒæ—¶å¯é€šè¿‡`isLocked()`è·å–é”çš„çŠ¶æ€ï¼Œ`synchronized`ä¸å¯ä¸­æ–­ä¸”æ— æ³•è·å–é”çŠ¶æ€

```java
import java.util.concurrent.locks.ReentrantLock;
import static java.lang.Thread.sleep;

public class Interrupted {
    public static void main(String[] args) throws InterruptedException {
        ReentrantLock lock = new ReentrantLock();

        Thread t1 = new Thread(() -> {
            System.out.println(Thread.currentThread().getName() + "å¯åŠ¨");
            try {
                lock.lockInterruptibly();
                System.out.println(Thread.currentThread().getName() + "è·å–å¯è¢«æ‰“æ–­çš„é”");
            } catch (InterruptedException e) {
                e.printStackTrace();
                System.out.println(Thread.currentThread().getName() + "ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­");
                return;
            }

            try {
                System.out.println(Thread.currentThread().getName() + "ç­‰å¾…é”è¿‡ç¨‹ä¸­æœªè¢«ä¸­æ–­ï¼ŒæˆåŠŸè·å–é”");
            } finally {
                lock.unlock();
                System.out.println(Thread.currentThread().getName() + "é‡Šæ”¾é”");
            }
        }, "t1");

        lock.lock();//å…ˆæŠŠé”åŠ ç»™ä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆt1çº¿ç¨‹å°±å¿…é¡»è¦ç­‰åˆ°ä¸»çº¿ç¨‹é‡Šæ”¾é”æ‰èƒ½åŠ é”ï¼Œåœ¨ç­‰å¾…è¿‡ç¨‹ä¸­å¯ä»¥æ‰“æ–­t1çº¿ç¨‹ï¼ŒæŸ¥çœ‹æŠ¥é”™
        System.out.println(Thread.currentThread().getName() + "è·å¾—é”");
        t1.start();
        try {
            sleep(1);//ç­‰å¾…t1çº¿ç¨‹åˆ°è¾¾ç­‰å¾…é”çš„çŠ¶æ€
            t1.interrupt();//æ‰“æ–­
            System.out.println("æ‰§è¡Œæ‰“æ–­");
        } finally {
            lock.unlock();
        }
    }
}
--------------------------------------------------
mainè·å¾—é”
t1å¯åŠ¨
æ‰§è¡Œæ‰“æ–­
t1ç­‰é”çš„è¿‡ç¨‹ä¸­è¢«æ‰“æ–­
java.lang.InterruptedException
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:898)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:1222)
	at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:335)
	at com.yc.Test04_shareproblem.Test04_Lock.Interrupted.lambda$main$0(Interrupted.java:20)
	at java.lang.Thread.run(Thread.java:745)  
```

#### 1.4.é”è¶…æ—¶

å¯é€šè¿‡`tryLock()`å’Œ`tryLock(long time, TimeUnit unit)`å°è¯•è·å–é”ï¼Œè¿”å›å¸ƒå°”ç»“æœï¼Œ`synchronized`ä¸èƒ½è®¾ç½®è¶…æ—¶æ—¶é—´

â‘ `boolean tryLock()`åˆ¤æ–­é”å¯ä¸å¯ä»¥ï¼Œç„¶åç«‹å³è¿”å›ç»“æœï¼Œæ¨¡æ‹Ÿ**ç«‹å³å¤±è´¥**

```java
import java.util.concurrent.locks.ReentrantLock;
import static java.lang.Thread.sleep;

public class tryLock {
    public static void main(String[] args) throws InterruptedException {
        ReentrantLock lock = new ReentrantLock();

        Thread t1 = new Thread(() -> {
            System.out.println(Thread.currentThread().getName() + "å¯åŠ¨");
            if (!lock.tryLock()) {
                System.out.println(Thread.currentThread().getName() + "è·å–é”å¤±è´¥ï¼Œç«‹åˆ»è¿”å›");
                return;
            }
            try {
                System.out.println(Thread.currentThread().getName() + "æˆåŠŸè·å–é”");
            } finally {
                lock.unlock();
            }
        }, "t1");

        lock.lock();
        System.out.println(Thread.currentThread().getName() + "è·å¾—é”");
        t1.start();
        try {
            sleep(2);
        } finally {
            lock.unlock();
        }

    }
}
--------------------------------------------------
mainè·å¾—é”
t1å¯åŠ¨
t1è·å–é”å¤±è´¥ï¼Œç«‹åˆ»è¿”å›
```

â‘¡`boolean tryLock(long time, TimeUnit unit)`åˆ¤æ–­é”å¯ä¸å¯ä»¥ï¼Œç„¶ååœ¨è§„å®šæ—¶é—´å†…è¿”å›ç»“æœï¼Œæ¨¡æ‹Ÿ**è¶…æ—¶å¤±è´¥**

```java
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.ReentrantLock;

public class tryLockTime {
    public static void main(String[] args) throws InterruptedException {
        ReentrantLock lock = new ReentrantLock();

        Thread t1 = new Thread(() -> {
            System.out.println(Thread.currentThread().getName() + "å¯åŠ¨");
            try {
                if (!lock.tryLock(2, TimeUnit.SECONDS)) {
                    System.out.println(Thread.currentThread().getName() + "è·å–é”å¤±è´¥ï¼Œè¶…æ—¶è¿”å›");
                    return;
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            try {
                System.out.println(Thread.currentThread().getName() + "æˆåŠŸè·å–é”");
            } finally {
                lock.unlock();
            }
        }, "t1");

        lock.lock();
        System.out.println(Thread.currentThread().getName() + "è·å¾—é”");
        t1.start();
        try {
            TimeUnit.SECONDS.sleep(3);
        } finally {
            lock.unlock();
        }

    }
}
--------------------------------------------------
mainè·å¾—é”
t1å¯åŠ¨
t1è·å–é”å¤±è´¥ï¼Œè¶…æ—¶è¿”å›
```

#### 1.5.å…¬å¹³é”

ReentrantLocké»˜è®¤æ˜¯ä¸å…¬å¹³é”ï¼Œå¯é€šè¿‡`new ReentrantLock(true)`è®¾ç½®å…¬å¹³é”ï¼Œ`synchronized`åªèƒ½æ˜¯éå…¬å¹³é”ï¼Œå°±ä¸è¯æ˜äº†

#### 1.6.æ¡ä»¶å˜é‡

`synchronized`ä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯`waitSet`ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥`waitSet`ï¼ŒReentrantLockæ¡ä»¶å˜é‡çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå®ƒæ”¯æŒå¤šä¸ªæ¡ä»¶ï¼Œè¿™å°±å¥½æ¯”`synchronized`åªæœ‰ä¸€é—´ä¼‘æ¯å®¤ï¼Œè€ŒReentrantLockæœ‰å¥½å‡ é—´

ReentrantLockå¯é€šè¿‡`newCondition()`è®¾ç½®æ¡ä»¶ï¼Œ`newCondition()`è¿”å›Conditionç±»ï¼ŒConditionç±»ä¸­å«ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•

* `await()`ï¼šç›¸å½“`Object.wait()`ï¼Œæ‰§è¡Œå‰éœ€è¦è·å–é”`lock()`ï¼Œæ‰§è¡Œåä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥`conditionObject`ç­‰å¾…ï¼Œ**è‹¥è¢«å”¤é†’ã€æ‰“æ–­ã€è¶…æ—¶éœ€è¦é‡æ–°è·å–é”ï¼Œé‡æ–°è·å–é”åç»§ç»­ä»`await()`åæ‰§è¡Œ**
* `singal()`ï¼šç›¸å½“`Object.notify()`ï¼Œéšæœºå”¤é†’`conditionObject`ä¸­ç­‰å¾…çš„
* `singalAll()`ï¼šç›¸å½“`Object.notifyAll()`

â‘ **åŒæ­¥æ¨¡å‹ä¹‹é¡ºåºæ§åˆ¶**ï¼šä½¿abcä¸‰ä¸ªæ–¹æ³•æŒ‰`a-b-c`çš„é¡ºåºè°ƒç”¨ï¼Œåˆ©ç”¨`wait+notifyAll`

```java
public class NoConditionDemo1 {
    private int signal;

    public synchronized void a() {
        while (signal != 0) {
            try {
                wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        System.out.println("a" + signal);
        signal++;
        notifyAll();
    }

    public synchronized void b() {
        while (signal != 1) {
            try {
                wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        System.out.println("b" + signal);
        signal++;
        notifyAll();
    }

    public synchronized void c() {
        while (signal != 2) {
            try {
                wait();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        System.out.println("c" + signal);
        signal = 0;
        notifyAll();
    }

    public static void main(String[] args) {
        //æ•´ä¸ªç¨‹åº ä¸€ç›´ä»¥   a0,b1,c2è¾“å‡º .
        NoConditionDemo1 d = new NoConditionDemo1();
        A a = new A(d);
        B b = new B(d);
        C c = new C(d);
        new Thread(a).start();
        new Thread(a).start();
        new Thread(a).start();
        new Thread(a).start();

        new Thread(c).start();
        new Thread(c).start();
        new Thread(c).start();
        new Thread(c).start();

        new Thread(b).start();
        new Thread(b).start();
        new Thread(b).start();
        new Thread(b).start();
    }
}

// A B Cä¸‰ä¸ªç±»ï¼Œç”¨æ¥è¡¨ç¤ºå¤šä¸ªçº¿ç¨‹è°ƒç”¨DemoNoConditionçš„å‡ ä¸ªæ–¹æ³•æ¥æ‰“å°abc
class A implements Runnable {
    private NoConditionDemo1 demoCondition;

    public A(NoConditionDemo1 demo) {
        this.demoCondition = demo;
    }

    @Override
    public void run() {
        while (true) {
            demoCondition.a();
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class B implements Runnable {
    private NoConditionDemo1 demoCondition;

    public B(NoConditionDemo1 demoCondition) {
        this.demoCondition = demoCondition;
    }

    @Override
    public void run() {
        while (true) {
            demoCondition.b();
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class C implements Runnable {
    private NoConditionDemo1 demoCondition;

    public C(NoConditionDemo1 demoCondition) {
        this.demoCondition = demoCondition;
    }

    @Override
    public void run() {
        while (true) {
            demoCondition.c();
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
```

â‘¡**åŒæ­¥æ¨¡å‹ä¹‹é¡ºåºæ§åˆ¶**ï¼šä½¿abcä¸‰ä¸ªæ–¹æ³•æŒ‰`a-b-c`çš„é¡ºåºè°ƒç”¨ï¼Œåˆ©ç”¨`await+signal`

```java
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class ConditionDemo2 {
    private int signal;

    private final Lock lock = new ReentrantLock();

    private final Condition a = lock.newCondition();
    private final Condition b = lock.newCondition();
    private final Condition c = lock.newCondition();

    public void a() {
        lock.lock();
        try {
            while (signal != 0) {
                try {
                    a.await();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            System.out.println("a" + signal);
            signal++;
            b.signal();
        } finally {
            lock.unlock();
        }
    }

    public void b() {
        lock.lock();
        try {
            while (signal != 1) {
                try {
                    b.await();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            System.out.println("b" + signal);
            signal++;
            c.signal();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    public void c() {
        lock.lock();
        try {
            while (signal != 2) {
                try {
                    c.await();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            System.out.println("c" + signal);
            signal = 0;
            a.signal();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    public static void main(String[] args) {
        //æ•´ä¸ªç¨‹åº ä¸€ç›´ä»¥   a0,b1,c2è¾“å‡º .
        ConditionDemo2 d = new ConditionDemo2();
        A1 a = new A1(d);
        B1 b = new B1(d);
        C1 c = new C1(d);
        new Thread(a).start();
        new Thread(a).start();
        new Thread(a).start();
        new Thread(a).start();

        new Thread(c).start();
        new Thread(c).start();
        new Thread(c).start();
        new Thread(c).start();

        new Thread(b).start();
        new Thread(b).start();
        new Thread(b).start();
        new Thread(b).start();
    }
}

class A1 implements Runnable {
    private ConditionDemo2 demoCondition;

    public A1(ConditionDemo2 demo) {
        this.demoCondition = demo;
    }

    @Override
    public void run() {
        while (true) {
            demoCondition.a();
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class B1 implements Runnable {
    private ConditionDemo2 demoCondition;

    public B1(ConditionDemo2 demoCondition) {
        this.demoCondition = demoCondition;
    }

    @Override
    public void run() {
        while (true) {
            demoCondition.b();
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class C1 implements Runnable {
    private ConditionDemo2 demoCondition;

    public C1(ConditionDemo2 demoCondition) {
        this.demoCondition = demoCondition;
    }

    @Override
    public void run() {
        while (true) {
            demoCondition.c();
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
```

**â‘¢å¼‚æ­¥æ¨¡å‹ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…**ï¼šåˆ©ç”¨`await+signal`æ¨¡æ‹Ÿç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…

```java
class AppleBox {
    int index = 0;
    Apple[] apples = new Apple[5];

	//åˆ›å»ºé”ï¼Œæ›¿æ¢synchronized
	private final Lock lock = new ReentrantLock();
	//ä¸€ä¸ªé”å¯ä»¥æœ‰å¤šä¸ªç­‰å¾…é˜Ÿåˆ—
	private final Condition produceCondition = lock.newCondition();
	private final Condition consumeCondition = lock.newCondition();

    //ç”Ÿäº§
    public void deposite(Apple apple) throws InterruptedException {
        lock.lock();

        try {
            //å­˜æ»¡ï¼Œå¦‚æœäº§å“ä¸€ç›´æ²¡è¢«æ¶ˆè´¹ï¼Œåˆ™äº§å“å°±ä¸€ç›´å¾€produceConditionå­˜
            while (index == apples.length) {//ä¸è¦ifï¼Œé†’æ¥ä¹‹åéœ€è¦åˆ¤æ–­indexï¼Œé˜²æ­¢indexè¶Šç•Œï¼Œå¤šæ¬¡å®¹é”™
                produceCondition.await();
            }
            consumeCondition.signal();//å”¤é†’æ¶ˆè´¹è€…ä»awaité†’æ¥å†æ¬¡åˆ¤æ–­æ˜¯ä¸æ˜¯ç©ºï¼Œä¸ç©ºå°±è¦ç»§ç»­å‘ä¸‹æ¶ˆè´¹index--
            apples[index] = apple;
            index++;
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    //æ¶ˆè´¹
    public Apple withdraw() {
        lock.lock();

        try {
            //ç©ºçš„ï¼Œå¦‚æœå®¹å™¨ä¸€ç›´æ²¡äº§å“ï¼Œåˆ™æ¶ˆè´¹è€…ä¸€ç›´å¾€consumeConditionç­‰å¾…
            while (index == 0) {//ä¸è¦ifï¼Œé†’æ¥ä¹‹åéœ€è¦åˆ¤æ–­indexï¼Œé˜²æ­¢indexè¶Šç•Œï¼Œå¤šæ¬¡å®¹é”™
                consumeCondition.await();
            }
            produceCondition.signal();//å”¤é†’ç”Ÿäº§è€…ä»awaité†’æ¥å†æ¬¡åˆ¤æ–­æ˜¯ä¸æ˜¯æ»¡ï¼Œä¸æ»¡å°±è¦ç»§ç»­ç”Ÿäº§index++
            index--;
            return apples[index];
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
        return null;
    }
}
```

#### 1.7.Lockä¸synchronizedæ¯”è¾ƒ

![1658567271396](assets/1658567271396.png)

### 2.ReentrantReadWriteLock

ReentrantReadWriteLockç§°ä¸ºè¯»å†™é”ï¼Œä½¿è¯»æ“ä½œå’Œå†™æ“ä½œå„æœ‰ä¸€æŠŠé”ï¼Œ**è¯»é”ä¸å†™é”ä¸èƒ½åŒæ—¶æ‹¥æœ‰ï¼Œè¯»é”åœ¨è¯»æ“ä½œé—´å…±äº«ï¼Œå†™é”åœ¨è¯»å†™æ“ä½œé—´éƒ½ç‹¬å (æ’ä»–é”)ï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘çš„æƒ…å†µ**

çœ‹ä»¥ä¸‹çš„ä½¿ç”¨æ¡ˆä¾‹

```java
/**
- éœ€æ±‚ï¼šä¸¤ä¸ªè¯»çº¿ç¨‹ï¼Œä¸¤ä¸ªå†™çº¿ç¨‹ï¼Œ4ä¸ªçº¿ç¨‹åŒæ—¶å¯åŠ¨(CyclicBarrier)ï¼Œæµ‹è¯•è¿™4ä¸ªçº¿ç¨‹çš„è¯»å†™é¡ºåº
- 1.å½“æœ‰è¯»é”æ—¶ï¼Œä¸èƒ½åŠ å†™é”ï¼Œä¸”è¯»é”åœ¨è¯»æ“ä½œå…±äº«
- 2.å½“æœ‰å†™é”æ—¶ï¼Œä¸èƒ½åŠ è¯»é”ï¼Œä¸”å†™é”æ’ä»–ï¼Œå…¶ä»–è¯»æ“ä½œä¹Ÿä¸èƒ½è¿›è¡Œ
 */
public class ReentrantReadWriteLockTest {
	//è¯»å†™é”
	private static ReentrantReadWriteLock reentrantReadWriteLock = new ReentrantReadWriteLock();
    //çº¿ç¨‹æ± 
	private static ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 10, 60L, TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>());
    //æ æ†
	private static CyclicBarrier cyclicBarrier = new CyclicBarrier(4);
	private static int i = 100;

    //è¯»æ“ä½œ
	public static void read(Thread thread) {
		//åœ¨æ­¤å¤„ç­‰å¾…ï¼Œç­‰å¾…åŒæ—¶è¿è¡Œä¿¡å·
        try {
            cyclicBarrier.await();
        } catch (Exception e) {
            e.printStackTrace();
        }

  		//è¯»é”ï¼šæŠ¢åˆ°è¯»é”ï¼Œåˆ™ä¸¤ä¸ªè¯»é”çº¿ç¨‹å¯ä»¥åŒæ—¶å‘ä¸‹è¿è¡Œ-->è¯»é”å…±äº«
  		reentrantReadWriteLock.readLock().lock();
  
  		//è¯»çº¿ç¨‹ pool-1-thread-3 å¼€å§‹æ‰§è¡Œ  i=100
  		//è¯»çº¿ç¨‹ pool-1-thread-2 å¼€å§‹æ‰§è¡Œ  i=100
  		//è¯»çº¿ç¨‹ pool-1-thread-2 ç»“æŸ
  		//è¯»çº¿ç¨‹ pool-1-thread-3 ç»“æŸ
  
        try {
            System.out.println("è¯»çº¿ç¨‹ " + thread.getName() + " å¼€å§‹æ‰§è¡Œ  i=" + i);
            Thread.sleep(1000);
            System.out.println("è¯»çº¿ç¨‹ " + thread.getName() + " ç»“æŸ");
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            reentrantReadWriteLock.readLock().unlock();
        }
  	}

    //å†™æ“ä½œ
    public static void write(Thread thread) {
        //åœ¨æ­¤å¤„ç­‰å¾…ï¼Œç­‰å¾…åŒæ—¶è¿è¡Œä¿¡å·
        try {
            cyclicBarrier.await();
        } catch (Exception e) {
            e.printStackTrace();
        }

        //å†™é”ï¼šåªèƒ½æœ‰ä¸€ä¸ªåœ¨å†™ï¼Œä¸”ä¸èƒ½è¯»
        reentrantReadWriteLock.writeLock().lock();
  
        //å†™çº¿ç¨‹ pool-1-thread-1 å¼€å§‹æ‰§è¡Œ  i=101
        //å†™çº¿ç¨‹ pool-1-thread-1 ç»“æŸ
        //å†™çº¿ç¨‹ pool-1-thread-2 å¼€å§‹æ‰§è¡Œ  i=102
        //å†™çº¿ç¨‹ pool-1-thread-2 ç»“æŸ
  
        try {
            i++;
            System.out.println("å†™çº¿ç¨‹ " + thread.getName() + " å¼€å§‹æ‰§è¡Œ  i=" + i);
            System.out.println("å†™çº¿ç¨‹ " + thread.getName() + " ç»“æŸ");
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            reentrantReadWriteLock.writeLock().unlock();
        }
	}

    public static void main(String[] args) {
        //æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
        executor.execute(() -> {
            write(Thread.currentThread());
        });
        executor.execute(() -> {
            write(Thread.currentThread());
        });
        executor.execute(() -> {
            read(Thread.currentThread());
        });
        executor.execute(() -> {
            read(Thread.currentThread());
        });
        executor.shutdown();
    }
}
```

## ä¹ã€AQS

AQSå†…å«[æ— é”ç¼–ç¨‹](/7.JUCå¹¶å‘ç¼–ç¨‹/æ— é”ç¼–ç¨‹)CASçš„ç›¸å…³çŸ¥è¯†

### 1.AQSæ˜¯ä»€ä¹ˆï¼Ÿ

é˜Ÿåˆ—åŒæ­¥å™¨AbstractQueuedSynchronizerï¼Œ**ç”¨æ¥æ„å»ºé”ï¼Œæ˜¯å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶**ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œ

AQSæ˜¯å®ç°é”çš„å…³é”®ï¼Œç®€å•ç†è§£ä¸¤è€…çš„å…³ç³»å°±æ˜¯ï¼š**é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼ŒAQSé¢å‘çš„æ˜¯é”çš„å®ç°è€…**ï¼Œç®€åŒ–é”çš„å®ç°æ–¹å¼ï¼Œå±è”½åŒæ­¥çŠ¶æ€ç®¡ç†ï¼Œçº¿ç¨‹æ’é˜Ÿï¼Œç­‰å¾…å”¤é†’åº•å±‚æ“ä½œçš„ç»†èŠ‚ï¼Œå¯¹å¤–æ”¾å‡º**æ¨¡æ¿æ–¹æ³•ä¾›å­ç±»å®ç°**

### 2.AQSç±»å›¾

![1658573618525](assets/1658573618525.png)

**AbstractQueuenSynchronize**ï¼š**AQSæ¡†æ¶æ ¸å¿ƒç±»**ï¼Œ**å†…éƒ¨ä»¥è™šæ‹Ÿé˜Ÿåˆ—çš„æ–¹å¼ç®¡ç†çº¿ç¨‹çš„é”è·å–ä¸é”é‡Šæ”¾**ï¼Œå…¶ä¸­`tryAcquire()`å’Œ`tryRelease()`å¹¶æ²¡æœ‰æä¾›é»˜è®¤çš„å®ç°ï¼Œéœ€è¦å­ç±»é‡å†™æ–¹æ³•çš„å…·ä½“é€»è¾‘ï¼Œç›®çš„æ˜¯ä½¿å¼€å‘äººå¯ä»¥è‡ªå®šä¹‰è·å–é”å’Œé‡Šæ”¾é”çš„æ–¹å¼

**Node**ï¼šAbstractQueuenSynchronizeçš„å†…éƒ¨ç±»ï¼Œ**ç”¨äºæ„å»ºè™šæ‹Ÿé˜Ÿåˆ—ï¼Œå³ç”¨äºæ„å»ºåŒå‘é“¾è¡¨**ï¼Œå°†æ¯ä¸ªè¿›å…¥åŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹å°è£…æˆNodeå¯¹è±¡åŠ å…¥é˜Ÿåˆ—ï¼Œç®¡ç†éœ€è¦è·å–é”çš„çº¿ç¨‹

**Sync**ï¼šReentrantLockçš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿AbstractQueuenSynchronizeï¼Œå®ç°`tryRelease()`å¹¶æä¾›æŠ½è±¡æ–¹æ³•`lock`ä¾›å­ç±»å®ç°

**NonfairSync**ï¼šReentrantlockçš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿Syncï¼Œ**éå…¬å¹³é”çš„å®ç°ç±»**

**FairSync**ï¼šReentrantlockçš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿Syncï¼Œ**å…¬å¹³é”çš„å®ç°ç±»**

**Reentrantlock**ï¼šå®ç°äº†Lockæ¥å£ï¼Œåˆ›å»ºæ—¶é»˜è®¤ä¸ºéå…¬å¹³é”

### 3.AQSåº•å±‚ç»“æ„

![1658574560230](assets/1658574560230.png)

#### 3.1.state

AQSå†…éƒ¨ç”¨`volatile`ä¿®é¥°çš„`int`ç±»å‹çš„æˆå‘˜å˜é‡`state`æ¥**æ§åˆ¶åŒæ­¥çŠ¶æ€**

* `state=0`ï¼šè¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹æ­£åœ¨ç‹¬å å…±äº«èµ„æºçš„é”
* `state=1`ï¼šè¡¨ç¤ºæœ‰çº¿ç¨‹æ­£åœ¨å…±äº«èµ„æºçš„é”

`state`æ—¢å¯ä»¥è¡¨ç¤ºå æ²¡å ï¼Œè¿˜å¯ä»¥è¡¨ç¤ºå å¤šå°‘

* å¯¹äºç‹¬å é”ä½¿ç”¨0è¡¨ç¤ºæ²¡å ï¼Œ1è¡¨ç¤ºå 
* å¯¹äºè¯»å†™é”å°†32ä½æ‹†æˆ16ä½åˆ†åˆ«æ ‡è¯†è¯»é”å’Œå†™é”
* `state`çš„å­—é¢å€¼å°±è¡¨ç¤ºå å¤šå°‘

AQSå†…éƒ¨ä¸`state`ç›¸å…³çš„æ–¹æ³•æœ‰`getState()`ã€`setState()`ã€`compareAndSetState()`ï¼Œå…¶ä¸­`compareAndSetState()`æ˜¯ä½¿ç”¨CASæ¥è®¾ç½®çŠ¶æ€ï¼Œä¿è¯åŸå­æ€§ï¼ŒCASè¯·ç§»æ­¥[æ— é”ç¼–ç¨‹](/7.JUCå¹¶å‘ç¼–ç¨‹/æ— é”ç¼–ç¨‹)

#### 3.2.CLHé˜Ÿåˆ—

CLHæ˜¯è™šæ‹ŸåŒç«¯é˜Ÿåˆ—ï¼Œè™šæ‹ŸæŒ‡çš„æ˜¯ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œåªå­˜åœ¨Nodeä¹‹é—´çš„å…³ç³»ï¼Œ**AQSå†…éƒ¨ä¼šå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹åŒ…è£…æˆCLHé˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹Node**ï¼ŒNodeæºç å¦‚ä¸‹

![1658575466787](assets/1658575466787.png)

CLHåˆ†ä¸ºåŒæ­¥é˜Ÿåˆ—ä»¥åŠç­‰å¾…æ¡ä»¶é˜Ÿåˆ—ï¼Œå…¶å¢åˆ èŠ‚ç‚¹çš„å·¥ä½œæµç¨‹å¦‚ä¸‹

* åŒæ­¥é˜Ÿåˆ—å¢åˆ èŠ‚ç‚¹çš„å·¥ä½œæµç¨‹

![1658575637802](assets/1658575637802.png)

* ç­‰å¾…æ¡ä»¶é˜Ÿåˆ—å¢åˆ èŠ‚ç‚¹çš„å·¥ä½œæµç¨‹

![1658575716189](assets/1658575716189.png)

![1658575772277](assets/1658575772277.png)

#### 3.3.æ¨¡æ¿æ¨¡å¼

æ¨¡æ¿æ¨¡å¼æŒ‡çš„æ˜¯**å·¥ä½œæµç¨‹å›ºå®šï¼Œä½†å…·ä½“å®ç°ä¸å›ºå®šçš„æƒ…å†µä¸‹ï¼Œå°†å›ºå®šçš„æµç¨‹å°è£…ï¼Œå¹¶æä¾›å…·ä½“å®ç°ç»™ç”¨æˆ·å®ç°**ï¼Œå¦‚JdbcTemplateçš„JDBCä¸­è·å–æ•°æ®åº“è¿æ¥ç­‰æµç¨‹æ˜¯å›ºå®šä¸å˜çš„ï¼Œåªæ˜¯sqlè¯­å¥ä¸åŒï¼Œåªéœ€ç”¨æˆ·ç¼–å†™sqlä»¥åŠè¿”å›éƒ¨åˆ†è¿”å›ç»“æœåŒ…è£…æˆä»€ä¹ˆå¯¹è±¡ä¸ç¡®å®šã€HttpServletçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°

AQSæœ‰å¦‚ä¸‹æ¨¡æ¿æ–¹æ³•

|        |          è·å–          |           æ”¯æŒä¸­æ–­çš„è·å–            |               å°è¯•è·å–ï¼Œå¸¦è¶…æ—¶æ—¶é—´                |      é‡Šæ”¾       |
| :----: | :--------------------: | :---------------------------------: | :-----------------------------------------------: | :-------------: |
| ç‹¬å å¼ |    acquire(int arg)    |    acquireInterruptibly(int arg)    |    tryAcquireNanos(int arg, long nanosTimeout)    |    release()    |
| å…±äº«å¼ | acquireShared(int arg) | acquireSharedInterruptibly(int arg) | tryAcquireSharedNanos(int arg, long nanosTimeout) | releaseShared() |

AQSä¸­éœ€è¦è¢«å­ç±»è¦†ç›–ï¼Œä»è€Œéœ€è¦ç”¨æˆ·è‡ªå·±ç¼–å†™å®ç°é€»è¾‘çš„æµç¨‹æ–¹æ³•å¦‚ä¸‹

|        |                           å°è¯•è·å–                           |                          å°è¯•é‡Šæ”¾                           |
| :----: | :----------------------------------------------------------: | :---------------------------------------------------------: |
| ç‹¬å å¼ |              tryAcquire(int)ï¼Œè·å–æˆåŠŸè¿”å›true               |              tryRelease(int)ï¼Œé‡Šæ”¾æˆåŠŸè¿”å›true              |
| å…±äº«å¼ | tryAcquireShared(int)ï¼Œè´Ÿæ•°è¡¨ç¤ºè·å–å¤±è´¥ï¼Œ0è¡¨ç¤ºè·å–æˆåŠŸä¸”æ— å‰©ä½™èµ„æºï¼Œæ­£æ•°è¡¨ç¤ºè·å–æˆåŠŸä¸”æœ‰å‰©ä½™ | tryReleaseShared(int)ï¼Œé‡Šæ”¾æˆåŠŸä¸”å…è®¸å”¤é†’ååºNodeçš„è¿”å›true |

åŒæ­¥å™¨æ˜¯å¦å¤„äºç‹¬å æ¨¡å¼é€šè¿‡`isHeldExclusively()`è®¾ç½®ï¼Œä¸€èˆ¬ç‹¬å å’Œå…±äº«åªéœ€è¦å®ç°ä¸€ç§å³å¯ï¼Œä½†AQSä¹Ÿæ”¯æŒè‡ªå®šä¹‰åŒæ­¥å™¨ï¼Œä»è€ŒåŒæ—¶å®ç°ç‹¬å å’Œå…±äº«ï¼Œå¦‚ReentrantReadWriteLock

æ¥ä¸‹æ¥åº·åº·AQSå†…æ¨¡æ¿æ–¹æ³•çš„æºç ï¼Œæ­¤å¤„ä¸æ‡‚æ²¡å…³ç³»ï¼Œå·¥ä½œæµç¨‹éƒ¨åˆ†ä¼šè¯¦ç»†ä»‹ç»

* ç‹¬å å¼

```java
public final void acquire(int arg) {
    //tryAcquireï¼šå°è¯•è·å–é”ï¼Œæä¾›ç»™å­ç±»å®ç°å…·ä½“çš„å–é”é€»è¾‘ï¼Œfalseè¡¨ç¤ºè·å–é”å¤±è´¥ï¼Œtrueè¡¨ç¤ºå–é”æˆåŠŸï¼Œç›´æ¥è®©acquire()è¿è¡Œå®Œ
	//tryAcquireï¼šè¿”å›falseï¼Œï¼falseä¸ºtrueè¡¨ç¤ºçº¿ç¨‹éœ€è¦è¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„çŠ¶æ€ä¸ºç‹¬å æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯Node.EXCLUSIVEï¼Œè¿›å…¥addWaiteræ–¹æ³•
	if (!tryAcquire(arg) &&
		//addWaiterï¼šåˆ›å»ºNodeåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨
		//acquireQueuedï¼šå¹¶å‘ä¸‹ï¼Œå½“å‰èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—çš„è¿‡ç¨‹ä¸­å¯èƒ½é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹å–åˆ°é”èµ°äº†ï¼Œæ­¤æ—¶è‡ªæ—‹åˆ¤æ–­å¦‚æœå½“å‰èŠ‚ç‚¹åœ¨é˜Ÿå¤´ä¸”å¯ä»¥æ‹¿åˆ°é”å°±è¿”å›falseï¼Œè·³å‡ºifï¼Œè·å–åˆ°é”èµ°äººï¼Œå¦åˆ™è¿”å›trueè¿›å…¥ifè¯­å¥
		acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
		//selfInterruptï¼šä¸­æ–­çº¿ç¨‹
	    selfInterrupt();
	}

}

public final boolean release(int arg) {
    if (tryRelease(arg)) {//é‡Šæ”¾èµ„æºæˆåŠŸï¼Œè¿›å…¥if
        Node h = head;//è·å–åŒæ­¥é˜Ÿåˆ—å¤´ç»“ç‚¹ï¼Œå°±æ˜¯å½“å‰éœ€è¦é‡Šæ”¾çš„èŠ‚ç‚¹
        //å¦‚å¤´ç»“ç‚¹éç©ºï¼Œä¸”å¤´ç»“ç‚¹çŠ¶æ€ä¸ä¸º0,é‚£ä¹ˆé˜Ÿåˆ—ä¸­å¯èƒ½å­˜åœ¨å¾…å”¤é†’çš„ç»“ç‚¹
        if (h != null && h.waitStatus != 0)
            //å”¤é†’åç»§ç»“ç‚¹ï¼Œè®©åç»§ç»“ç‚¹ç«äº‰èµ„æº(parkAndCheckInterrupt()ä¸­çš„park)
            unparkSuccessor(h);
        //é‡Šæ”¾ç‹¬å é”æˆåŠŸï¼Œè¿”å›true
        return true;
    }
    //é‡Šæ”¾ç‹¬å èµ„æºå¤±è´¥ï¼Œè¿”å›false
    return false;
}
```

* å…±äº«å¼

```java
public final void acquireShared(int arg) {
	//tryAcquireSharedéœ€å­ç±»å…·ä½“å®ç°å–é”æ¡ä»¶,è´Ÿæ•°è¡¨ç¤ºè·å–å¤±è´¥,0æˆ–æ­£æ•°è¡¨ç¤ºè·å–æˆåŠŸä¸”æ•°å€¼è¡¨ç¤ºå‰©ä½™èµ„æºæ•°é‡
    if (tryAcquireShared(arg) < 0)
    	//doAcquireSharedï¼šæ“ä½œé˜Ÿåˆ—
        doAcquireShared(arg);
}

public final boolean releaseShared(int arg) {
	//tryReleaseSharedéœ€å­ç±»å…·ä½“å®æ”¾é”æ¡ä»¶ï¼Œtrueè¡¨ç¤ºèƒ½é‡Šæ”¾
    if (tryReleaseShared(arg)) {
        doReleaseShared();
        return true;
    }
    return false;
}
```

### 4.AQSå·¥ä½œæµç¨‹

#### 4.1.ç‹¬å å¼acquire

![1658577594528](assets/1658577594528.png)

ä»¥ReentrantLockçš„AQSçš„acquire()ä¸ºå…¥å£

```java
public final void acquire(int arg) {
	//tryAcquireï¼šå°è¯•è·å–æ‰€ï¼Œæä¾›ç»™å­ç±»å®ç°
	//tryAcquireï¼šè¿”å›falseï¼Œï¼falseä¸ºtrueè¡¨ç¤ºçº¿ç¨‹éœ€è¦è¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„çŠ¶æ€ä¸ºç‹¬å æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯Node.EXCLUSIVEï¼Œè¿›å…¥addWaiteræ–¹æ³•
    if (!tryAcquire(arg) &&
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
------------------------------------------
private Node addWaiter(Node mode) {
	//å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeèŠ‚ç‚¹
   Node node = new Node(Thread.currentThread(), mode);
   //tailé»˜è®¤ä¸ºnullï¼Œå¦‚æœtailä¸ä¸ºç©ºï¼Œè¯´æ˜åŒæ­¥é˜Ÿåˆ—å·²ç»æœ‰èŠ‚ç‚¹
   Node pred = tail;
   if (pred != null) {
   		//å°†å½“å‰èŠ‚ç‚¹æ·»åŠ åˆ°å°¾èŠ‚ç‚¹
       node.prev = pred;
       //ä¸€æ¬¡CASè®¾ç½®å°¾èŠ‚ç‚¹
       if (compareAndSetTail(pred, node)) {
           pred.next = node;
           return node;
       }
   }
   //å°¾èŠ‚ç‚¹=nullï¼Œå½“å‰èŠ‚ç‚¹æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è¿›å…¥enqæ–¹æ³•
   //èµ„æºäº‰æŠ¢å¤ªå¤šï¼Œä¸€æ¬¡CASå¤±è´¥ï¼Œåˆ™è¿›å…¥enqæ–¹æ³•
   enq(node);
   return node;
}
------------------------------------------
private Node enq(final Node node) {
	//é€šè¿‡è‡ªæ—‹çš„æ–¹å¼
    for (;;) {
        Node t = tail;
        if (t == null) {å¦‚é˜Ÿå°¾ä¸ºç©ºï¼Œå³åŒæ­¥é˜Ÿåˆ—ä¸ºç©º
        	//é¦–èŠ‚ç‚¹æ˜¯è™šæ‹ŸèŠ‚ç‚¹
            if (compareAndSetHead(new Node()))//è®¾ç½®å¤´èŠ‚ç‚¹ï¼ŒåŒæ—¶å°¾èŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹
                tail = head;
        } else {
        	//è®¾ç½®å½“å‰èŠ‚ç‚¹åˆ°å°¾éƒ¨
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}
```

å›é€€åˆ°acquire()ä¸Š

```java
public final void acquire(int arg) {
    if (!tryAcquire(arg) &&
    	//æ ¹æ®ä¸Šé¢åˆ†æï¼ŒaddWaiterè¿”å›çš„æ˜¯nodeï¼Œæ–°æ’å…¥èŠ‚ç‚¹ï¼Œæ¥ç€çœ‹acquireQueuedæ–¹æ³•
         acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
------------------------------------------
final boolean acquireQueued(final Node node, int arg) {
	//æ ‡è®°æ˜¯å¦æˆåŠŸæ‹¿åˆ°èµ„æº
    boolean failed = true;
    try {
    	//æ ‡è®°ç­‰å¾…è¿‡ç¨‹æ˜¯å¦è¢«ä¸­æ–­
        boolean interrupted = false;
        //çœ‹åˆ°æ­»å¾ªç¯å°±æƒ³åˆ°è‡ªæ—‹
        for (;;) {
        	//è·å–nodeçš„å‰é©±èŠ‚ç‚¹ï¼Œæ³¨æ„headåªæ˜¯ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹
            final Node p = node.predecessor();
            //å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹(å“¨å…µ) && å¯æ˜¯è·å–åˆ°é”
            if (p == head && tryAcquire(arg)) {
            	//åˆ™å°†å½“å‰çº¿ç¨‹èŠ‚ç‚¹è®¾ç½®ä¸ºå“¨å…µèŠ‚ç‚¹ï¼Œå¤´ç»“ç‚¹å¯¹åº”çš„threadå±æ€§ä¸ºnull,æ­¤æ—¶å¤´èŠ‚ç‚¹å·²ç»è·å–åˆ°é”äº†
                setHead(node);
                //å°†ä¹‹å‰çš„å“¨å…µèŠ‚ç‚¹ç½®æˆåƒåœ¾ï¼Œæ–¹ä¾¿åƒåœ¾å›æ”¶gc
                p.next = null;
                //æ ‡è¯†æˆåŠŸè·å–åˆ°èµ„æº
                failed = false;
                //è¡¨ç¤ºçº¿ç¨‹æœªè¢«ä¸­æ–­ï¼Œæ­£å¸¸è·å–åˆ°é”
                return interrupted;
            }
            //è‹¥nodeçš„å‰é©±ä¸æ˜¯å¤´ç»“ç‚¹head,æˆ–æ˜¯å¤´èŠ‚ç‚¹ä½†è°ƒç”¨tryAcquire()å°è¯•è·å–é”å¤±è´¥ï¼Œåˆ™:
           	//1.shouldParkAfterFailedAcquireè·å–å‰é©±èŠ‚ç‚¹çŠ¶æ€ï¼Œåˆ¤æ–­å½“å‰èŠ‚ç‚¹çº¿ç¨‹æ˜¯å¦éœ€è¦é˜»å¡åŒæ—¶åˆ é™¤é˜Ÿåˆ—ä¸­å–æ¶ˆçš„çº¿ç¨‹èŠ‚ç‚¹
            //      è‹¥ä¸éœ€è¦é˜»å¡(å‰é©±èŠ‚ç‚¹ä¸å¤„äºå”¤é†’çŠ¶æ€)è¿”å›falseï¼Œåˆ™å†æ¬¡è¿›å…¥è‡ªæ—‹æŸ¥æ‰¾å‰é©±å¹¶å°è¯•è·å–é”
            //      è‹¥éœ€è¦é˜»å¡(å‰é©±èŠ‚ç‚¹å¤„äºå”¤é†’çŠ¶æ€)åˆ™è¿”å›trueï¼Œè¿›å…¥parkAndCheckInterruptæ–¹æ³•
            //2.parkAndCheckInterrupté˜»å¡å½“å‰çº¿ç¨‹åœ¨parkä½ç½®ï¼Œç›´åˆ°unparkæˆ–interruptåå†æ¬¡æ£€æŸ¥è¯¥çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œå¹¶è¿”å›ä¸­æ–­çŠ¶æ€
            //      è‹¥å”¤é†’åè¯¥çº¿ç¨‹ä¸å¤„äºä¸­æ–­çŠ¶æ€è¿”å›falseï¼Œåˆ™å†æ¬¡è¿›å…¥è‡ªæ—‹æŸ¥æ‰¾å‰é©±å¹¶å°è¯•è·å–é”
            //      è‹¥å”¤é†’åè¯¥çº¿ç¨‹å¤„äºä¸­æ–­çŠ¶æ€è¿”å›trueï¼Œåˆ™è®¾ç½®interrupted=trueï¼Œåˆ™å†æ¬¡è¿›å…¥è‡ªæ—‹æŸ¥æ‰¾å‰é©±å¹¶å°è¯•è·å–é”ï¼Œä½†è¿”å›ä¼šæ˜¯true
            //          å›åˆ°acquire()ä¸­æ‰§è¡ŒselfInterrupt()æ–¹æ³•ï¼Œå®Œæˆå½“å‰çº¿ç¨‹çš„ä¸­æ–­ä¿¡å·å‘å‡º
            if (shouldParkAfterFailedAcquire(p, node) &&
                    parkAndCheckInterrupt())
                interrupted = true;
    } finally {
    	if (failed)//æœªæˆåŠŸè·å–åˆ°èµ„æºï¼Œä¸”æ­¤æ—¶
	        //å¦‚æœnodeçš„å‰é©±ç»“ç‚¹ä¸ºç©º,è¯´æ˜nodeä¸ºå¤´ç»“ç‚¹,ä»£ç æŠ›å‡ºå¼‚å¸¸
	        cancelAcquire(node);//å–æ¶ˆå¯¹èµ„æºçš„è·å–
    }
}
------------------------------------------
//cancledè¡¨ç¤ºnodeæ‰€ä»£è¡¨çš„çº¿ç¨‹å·²å–æ¶ˆæ’é˜Ÿ,éœ€è¦ä»åŒæ­¥é˜Ÿåˆ—ç§»é™¤
//signalæ„æ€æ˜¯å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”,åˆ™å½“å‰èŠ‚ç‚¹è¢«å”¤é†’,å…¶åç»§èŠ‚ç‚¹éœ€è¦è¢«é˜»å¡
private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
    //æ ¹æ®å‰é©±ç»“ç‚¹çš„çŠ¶æ€åˆ¤æ–­æ˜¯å¦å°†çº¿ç¨‹é˜»å¡
    int ws = pred.waitStatus;//å‰é©±èŠ‚ç‚¹
    if (ws == Node.SIGNAL)//å‰é©±èŠ‚ç‚¹å¤„äºå”¤é†’çŠ¶æ€ï¼Œåªè¦å‰é©±çš„å‰é©±é‡Šæ”¾é”ï¼Œå‰é©±èŠ‚ç‚¹å°±è¿è¡Œï¼Œå½“å‰çº¿ç¨‹é˜»å¡
        return true;
    if (ws > 0) {//å‰é©±èŠ‚ç‚¹å¤„äºcancledçŠ¶æ€(åŸå› å¯èƒ½æ˜¯è¶…æ—¶æˆ–ä¸­æ–­)ï¼Œåˆ™å°†æ‰€æœ‰å¤„äºå–æ¶ˆçŠ¶æ€çš„å‰é©±èŠ‚ç‚¹ä»åŒæ­¥é˜Ÿåˆ—ä¸­åˆ é™¤
        //è®©å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸æ–­å¾ªç¯ï¼Œè·³è¿‡æ‰€æœ‰è¢«æ’¤é”€çš„å‰é©±èŠ‚ç‚¹ï¼ŒæŒ‡å‘ä¸€ä¸ªæœ€è¿‘ws<0(æœªæ’¤é”€çš„)çš„å‰é©±èŠ‚ç‚¹
        do {
            //æ­¤æ—¶å‰é©±èŠ‚ç‚¹æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œä¿®æ”¹å‰é©±æŒ‡å‘å‰é©±çš„å‰é©±
            node.prev = pred = pred.prev;
        } while (pred.waitStatus > 0);
        //é€€å‡ºå¾ªç¯è¡¨ç¤ºå½“å‰predå°±æ˜¯Nodeç»“ç‚¹çš„å‰é©±ç»“ç‚¹ï¼Œæ­¤æ—¶å·²ç»å°†åŒæ­¥é˜Ÿåˆ—ä¸­æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹ç§»é™¤
        pred.next = node;
    } else {//å‰é©±æœªå–æ¶ˆï¼Œé€šè¿‡CASè®¾ç½®å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºå”¤é†’
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    //è¿”å›falseè¡¨ç¤ºä¸é˜»å¡çº¿ç¨‹
    return false;
}
------------------------------------------
private final boolean parkAndCheckInterrupt() {
	//é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä¸€ç›´é˜»å¡åˆ°å½“å‰ä½ç½®ï¼Œç›´åˆ°è¢«å”¤é†’(unparkæˆ–interrupt)
    LockSupport.park(this);
    //ç›´åˆ°è¢«å”¤é†’å,é‡æ–°åˆ¤æ–­å½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€
    //ä»unparkSuccessor()ä¸­è¢«unparkååˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œè¢«ä¸­æ–­è¿”å›true,interruptedè¢«è®¾ç½®ä¸ºtrueä½œä¸ºacquireQueued()æ–¹æ³•çš„è¿”å›è¿›å…¥åˆ°ä¸‹é¢çš„selfInterrupté€šçŸ¥çº¿ç¨‹ä¸­æ–­
    return Thread.interrupted();
}
```

å†æ¬¡å›é€€åˆ°acquire()ä¸Š

```java
public final void acquire(int arg) {
   if (!tryAcquire(arg) &&
       acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
       //è¿”å›falseï¼Œåˆ™è¡¨ç¤ºå·²è¿›å…¥é˜Ÿåˆ—ï¼Œæˆ–è€…è·å–åˆ°èµ„æº
       //è¿”å›trueï¼Œåˆ™è¿›å…¥selfInterruptæ–¹æ³•ï¼Œæ–¹æ³•é‡Œé¢å¾ˆç®€å•
       selfInterrupt();
}
------------------------------------------
static void selfInterrupt() {
	//ä¸­æ–­çº¿ç¨‹
	Thread.currentThread().interrupt();
}
```

#### 4.2.ç‹¬å å¼release

```java
public final boolean release(int arg) {
    if (tryRelease(arg)) {//é‡Šæ”¾èµ„æºæˆåŠŸï¼Œè¿›å…¥if
        Node h = head;//è·å–åŒæ­¥é˜Ÿåˆ—å¤´ç»“ç‚¹ï¼Œå°±æ˜¯å½“å‰éœ€è¦é‡Šæ”¾çš„èŠ‚ç‚¹
        //å¦‚å¤´ç»“ç‚¹éç©ºï¼Œä¸”å¤´ç»“ç‚¹çŠ¶æ€ä¸ä¸º0,é‚£ä¹ˆé˜Ÿåˆ—ä¸­å¯èƒ½å­˜åœ¨å¾…å”¤é†’çš„ç»“ç‚¹
        if (h != null && h.waitStatus != 0)
            //å”¤é†’åç»§ç»“ç‚¹ï¼Œè®©åç»§ç»“ç‚¹ç«äº‰èµ„æº(parkAndCheckInterrupt()ä¸­çš„park)
            unparkSuccessor(h);
        //é‡Šæ”¾ç‹¬å é”æˆåŠŸï¼Œè¿”å›true
        return true;
    }
    //é‡Šæ”¾ç‹¬å èµ„æºå¤±è´¥ï¼Œè¿”å›false
    return false;
}
-------------------------------------
private void unparkSuccessor(Node node) {
   	int ws = node.waitStatus;
    if (ws < 0)//ç»“ç‚¹çŠ¶æ€å°äº0,åˆ™è‚¯å®šä¸æ˜¯cancledæ€
        //CASå°†ç»“ç‚¹çŠ¶æ€è®¾ä¸º0
        compareAndSetWaitStatus(node, ws, 0);

    Node s = node.next;//å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    //å¦‚åç»­ä¸ºç©º æˆ– æ˜¯å–æ¶ˆçŠ¶æ€,è¯´æ˜åç»§ç»“ç‚¹å¯¹åº”çš„çº¿ç¨‹å–æ¶ˆå¯¹èµ„æºçš„ç­‰å¾…
    if (s == null || s.waitStatus > 0) {
        s = null;
        //ä»åŒæ­¥é˜Ÿåˆ—é˜Ÿå°¾ç»“ç‚¹å¼€å§‹å‘å‰éå†ï¼Œæ‰¾åˆ°nodeç»“ç‚¹ç¬¬ä¸€ä¸ªä¸æ˜¯å–æ¶ˆçŠ¶æ€çš„ç»“ç‚¹ï¼Œå¦‚éå†åˆ°çš„ç»“ç‚¹téç©ºä¸”ä¸ç­‰äºå½“å‰node,åˆ™æ ¡éªŒæ­¤ç»“ç‚¹tçš„çŠ¶æ€
        //ç®€å•æ¥è¯´å°±æ˜¯å¯»æ‰¾åˆ°ä¸‹ä¸€ä¸ªéå–æ¶ˆæ€çš„ç»“ç‚¹s
        for (Node t = tail; t != null && t != node; t = t.prev)
            if (t.waitStatus <= 0)
                s = t;
    }

    if (s != null)
        //å”¤é†’åç»§èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹ ---> å”¤é†’åä»parkAndCheckInterrupt()çš„parkå¤„é†’æ¥åˆ¤æ–­ä¸­æ–­çŠ¶æ€
        LockSupport.unpark(s.thread);
}
```

### 5.åˆ©ç”¨AQSè‡ªå®šä¹‰XXX

å…¶å®åœ¨è‡ªå®šä¹‰çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºå…¬å¹³é”å¦‚ä½•å®ç°ï¼Œéå…¬å¹³é”å¦‚ä½•å®ç°ï¼Œç‹¬å é”å¦‚ä½•å®ç°ï¼Œå…±äº«é”å¦‚ä½•å®ç°

* `class NonFairSync extends Sync`å®ç°`tryAcquireShared()`ï¼Œä¸”`Sync sync = new NonFairSync(count);`
* `class FairSync extends Sync`å®ç°`tryAcquireShared()`ï¼Œä¸”`Sync sync = new FairSync (count);`
* ç‹¬å å’Œå…±äº«å’Œ`state`çŠ¶æ€æœ‰å…³

#### 5.1.è‡ªå®šä¹‰CountDownLatch(å…±äº«é”)

```java
/**
 - è‡ªå®šä¹‰CountDownLatch
 - 1.state:åˆå§‹å€¼ --- MyCountDownLatch(state)æ¨¡æ‹ŸCountDownLatchçš„æœ‰å‚æ„é€ 
 - 2.await:çº¿ç¨‹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…state=0å”¤é†’è·å–é” -- tryAcquireShared
 - 3.countDown:state-1ï¼Œstate>0æ—¶æ²¡æœ‰è¾¾åˆ°å–é”æ¡ä»¶ï¼Œstate=0æ—¶è¡¨ç¤ºéœ€è¦é‡Šæ”¾é” -- tryReleaseShared
 - 4.MySync:AQSå®ç°ç±»ï¼Œé‡å†™è·å–é‡Šæ”¾é”çš„æ¡ä»¶
 - tryAcquireShared()ï¼šstate=0è¡¨ç¤ºè§£é™¤é˜»å¡ï¼Œå³éœ€è¦å»å–é”äº†ï¼Œè¿”å›1ï¼Œå¦åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—è¿”å›-1
 - tryReleaseShared()ï¼šstate-1ï¼Œéœ€è¦ä¿®æ”¹stateçš„å€¼ï¼Œä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹äº‰æŠ¢stateï¼Œæ‰€ä»¥è‡ªæ—‹+CAS
 */
public class MyCountDownLatch {
    //AQS
    private static final class MySync extends AbstractQueuedSynchronizer {

        private static final long serialVersionUID = 8055037635125704937L;

        public MySync(int count) {
            //setStateæ˜¯AQSè‡ªå¸¦æ–¹æ³•ï¼Œè®¾ç½®stateå€¼
            setState(count);
        }

        //è·å–stateå€¼
        public int getCount() {
            return getState();
        }

        //å°è¯•è·å–é”
        @Override
        protected int tryAcquireShared(int arg) {
            //state>0 éƒ½ä¸èƒ½æŒæœ‰é”ï¼Œéƒ½åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç›´åˆ°state=0
            //å¼€å§‹æ—¶ï¼Œstateè¢«åˆå§‹åŒ–>0ï¼Œæ‰€ä»¥æ­¤æ—¶æ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¸èƒ½è·å–é”,ç›´åˆ°countDownå…¨éƒ¨è°ƒç”¨å®Œæ¯•

            //æŸ¥çœ‹åº•å±‚
            // è¿”å›å€¼<0,state!=0,è¡¨ç¤ºå½“å‰çº¿ç¨‹éœ€å¤„äºé˜»å¡çŠ¶æ€,æ¥ä¸‹æ¥acquireç»§ç»­å‘ä¸‹,å°†å½“å‰çº¿ç¨‹åŠ å…¥é˜»å¡é˜Ÿåˆ— --> é”è¢«å ç”¨
            // è¿”å›å€¼>0,state=0,è¡¨ç¤ºå½“å‰å½“å‰é˜»å¡é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹åŒæ—¶å…¨éƒ¨å”¤é†’,äº‰æŠ¢é‡Šæ”¾çš„é” --> é”è¢«é‡Šæ”¾
            return (getState() == 0) ? 1 : -1;
        }

        //å°è¯•é‡Šæ”¾é”
        @Override
        protected boolean tryReleaseShared(int arg) {
            //è¿”å›trueè¡¨ç¤ºdoReleaseShared --> é‡Šæ”¾é”

            //è€ƒè™‘å¤šçº¿ç¨‹å…±äº«ï¼Œå¹¶å‘æ“ä½œè¦ä¿è¯stateå…±äº«å˜é‡çš„åŸå­æ€§-->è‡ªæ—‹+CAS
            for (; ; ) {
                //åŸå€¼state
                int c = getState();
                if (c == 0) {//state=0 è¡¨ç¤ºé”å·²ç»è¢«è·å–ï¼Œä¸éœ€è¦é‡Šæ”¾
                    return false;
                }
                //ä¿®æ”¹state
                int nextc = c - 1;
                //compareAndSetStateæ˜¯AQSä¸­çš„æ–¹æ³•
                if (compareAndSetState(c, nextc)) {
                    //stateè®¾ç½®å®Œåä¸º0ï¼Œéœ€è¦é‡Šæ”¾é”ä¾›æ‰€æœ‰çº¿ç¨‹è¢«å”¤é†’æ¥äº‰æŠ¢é”
                    return nextc == 0;
                }
            }
        }
    }

    private final MySync mySync;

    public MyCountDownLatch(int count) {
        this.mySync = new MySync(count);
    }

    public void await() {//state=0æ‰èƒ½è·å–é”ï¼Œå¦åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—
        mySync.acquireShared(1);
    }

    public void countDown() {//ä¿®æ”¹åstate=0æ‰èƒ½é‡Šæ”¾é”
        mySync.releaseShared(1);
    }

    public int getCount() {
        return mySync.getCount();
    }
}
```

#### 5.2.è‡ªå®šä¹‰Semaphore(å…±äº«é”+éå…¬å¹³é”)

```java
/**
 - è‡ªå®šä¹‰Semaphore
 - state:åˆå§‹å€¼
 - acquire() state-1
 - release() state+1
 - Syncï¼šabstract
 - NonFairSync
 */
public class MySemaphore {
    //AQS
    static abstract class MySync extends AbstractQueuedSynchronizer {

        private static final long serialVersionUID = 8055037635125704937L;

        public MySync(int count) {
            //setStateæ˜¯AQSè‡ªå¸¦æ–¹æ³•ï¼Œè®¾ç½®stateå€¼
            setState(count);
        }

        //å°è¯•é‡Šæ”¾é”
        @Override
        protected boolean tryReleaseShared(int arg) {
            //è¿”å›trueè¡¨ç¤ºdoReleaseShared --> é‡Šæ”¾é”

            //è€ƒè™‘å¤šçº¿ç¨‹å…±äº«ï¼Œå¹¶å‘æ“ä½œè¦ä¿è¯stateå…±äº«å˜é‡çš„åŸå­æ€§-->è‡ªæ—‹+CAS
            for (; ; ) {
                //åŸå€¼
                int oldState = getState();
                int newState = oldState + arg;
                //compareAndSetStateæ˜¯AQSä¸­çš„æ–¹æ³•
                if (compareAndSetState(oldState, newState)) {
                    return true;
                }
            }
        }
    }

    //éå…¬å¹³
    static final class NonFairSync extends MySync {
        private static final long serialVersionUID = -2352767803293687627L;

        public NonFairSync(int count) {
            super(count);
        }

        @Override
        protected int tryAcquireShared(int arg) {
            for (; ; ) {
                //éå…¬å¹³é”ï¼Œç›´æ¥ä¸Šæ¥å°±æªé”
                int oldState = getState();
                int newState = oldState - arg;//è¯·æ±‚åï¼Œæºèµ„æºæ•°å‡å°‘
                //è¿”å›å€¼<0,é˜»å¡
                if (newState < 0 || compareAndSetState(oldState, newState)) {
                    return newState;
                }
            }
        }
    }

    private final MySync mySync;

    public MySemaphore(int count) {
        this.mySync = new NonFairSync(count);
    }

    public void acquire() {
        mySync.acquireShared(1);
    }

    public void release() {
        mySync.releaseShared(1);
    }
}
```

#### 5.3.è‡ªå®šä¹‰ReentrantLock(ç‹¬å é”)

```java
/**
 - Açº¿ç¨‹lock()æ—¶ï¼Œä¼šè°ƒç”¨tryAcquire()ç‹¬å è¯¥é”å¹¶å°†state+1
 - æ­¤æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å†tryAcquire()æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ°Açº¿ç¨‹unlock()åˆ°state=0(å³é‡Šæ”¾é”)ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”
 - å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒAçº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆstateä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µ
 - ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šä¹ˆæ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯stateæ˜¯èƒ½å›åˆ°é›¶æ€çš„
 - 
 - è‡ªå®šä¹‰ReentrantLock
 - è¦æ±‚ï¼šéå¯é‡å…¥é”ï¼Œç‹¬å é”
 */
public class MyReentrantLock implements Lock {

    //state=0å½“å‰çº¿ç¨‹æ²¡æœ‰è·å–åˆ°é”
    //state=1å½“å‰çº¿ç¨‹è·å–åˆ°é”
    private static class Sync extends AbstractQueuedSynchronizer {
        private static final long serialVersionUID = 6712919921457609668L;

        @Override //åˆ¤æ–­æ˜¯å¦å ç”¨
        protected boolean isHeldExclusively() {
            return getState() == 1;
        }

        //ç‹¬å é”ï¼šä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”ï¼Œæ­¤æ—¶state=0æ‰èƒ½æˆåŠŸè¿”å›true
        //ç‹¬å é”åªæœ‰ä¸¤ä¸ªçŠ¶æ€
        @Override
        protected boolean tryAcquire(int arg) {
            if (compareAndSetState(0, 1)) {//åŸå€¼0ï¼Œæ–°å€¼1ï¼Œæ”¹æˆåŠŸè¿”å›trueï¼Œåˆ™è·å–é”
                //å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºæ‰§è¡Œçº¿ç¨‹
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }

        //é‡Šæ”¾é”
        @Override
        protected boolean tryRelease(int arg) {
            if (getState() == 0) {//æ²¡æœ‰è·å–åˆ°é”
                throw new UnsupportedOperationException();
            }
            //è®¾ç½®å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¸ºnull
            setExclusiveOwnerThread(null);
            setState(0);
            return true;
        }

        Condition newCondition() {
            return new ConditionObject();
        }
    }

    private final Sync sync = new Sync();

    @Override
    public void lock() {//ç›´æ¥è·å–é”
        sync.acquire(1);
    }

    @Override
    public void lockInterruptibly() throws InterruptedException {
        //å“åº”ä¸­æ–­å¼ç›´æ¥è·å–é”
        sync.acquireInterruptibly(1);
    }

    @Override
    public boolean tryLock() {
        return sync.tryAcquire(1);
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquireNanos(1, unit.toNanos(time));
    }

    @Override
    public void unlock() {
        sync.release(1);
    }

    @Override
    public Condition newCondition() {
        return sync.newCondition();
    }
}
```

#### 5.4.ä¸‰å…ƒå…±äº«åŒæ­¥å·¥å…·ç±»

ä¸Semaphoreç±»ä¼¼ï¼Œæ¯æ¬¡åŒæ—¶è¿è¡Œä¸‰ä¸ªçº¿ç¨‹

```java
public class TrinityLock implements Lock {
    //ä¸º3è¡¨ç¤ºå…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å¾—é”
    private final Sync sync = new Sync(3);

    private static final class Sync extends AbstractQueuedSynchronizer {
        private static final long serialVersionUID = -5919240659191346108L;

        Sync(int count) {
            if (count <= 0) {
                throw new IllegalArgumentException("count must large than zero.");
            }
            setState(count);
        }

        @Override
        public int tryAcquireShared(int reduceCount) {
            for (; ; ) {
                int current = getState();
                int newCount = current - reduceCount;
                if (newCount < 0 || compareAndSetState(current, newCount)) {
                    return newCount;
                }
            }
        }

        @Override
        public boolean tryReleaseShared(int returnCount) {
            for (; ; ) {
                int current = getState();
                int newCount = current + returnCount;
                if (compareAndSetState(current, newCount)) {
                    return true;
                }
            }
        }

        final ConditionObject newCondition() {
            return new ConditionObject();
        }
    }

    @Override
    public void lock() {
        sync.acquireShared(1);
    }

    @Override
    public void unlock() {
        sync.releaseShared(1);
    }

    @Override
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireSharedInterruptibly(1);
    }

    @Override
    public boolean tryLock() {
        return sync.tryAcquireShared(1) >= 0;
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquireSharedNanos(1, unit.toNanos(time));
    }

    @Override
    public Condition newCondition() {
        return sync.newCondition();
    }
}
```

## åã€è¡¥å……-é”çš„ç§ç±»

### 1.å¯é‡å…¥é”

å¯é‡å…¥è¡¨ç¤ºåŒä¸€ä¸ªçº¿ç¨‹è·å–åŒä¸€æŠŠé”ä¸è¦åˆ‡æ¢ä¸Šä¸‹æ–‡

### 2.å…¬å¹³é”ä¸éå…¬å¹³é”

å…¬å¹³è¡¨ç¤ºçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºè·å–é”ï¼Œçº¿ç¨‹åˆ°è¾¾ä¼šç›´æ¥è¿›å…¥é˜Ÿåˆ—ï¼Œæ°¸è¿œåªæœ‰é˜Ÿå¤´çš„çº¿ç¨‹æ‰å¯è·å–é”

* ä¼˜ç‚¹æ˜¯æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¯ä»¥å¾—åˆ°è°ƒåº¦ï¼Œä¸è‡³äºé€ æˆ**é¥¥é¥¿**

* ç¼ºç‚¹æ˜¯ååé‡ä¸‹é™ï¼Œé™¤äº†é˜Ÿé¦–å…ƒç´ å…¶ä»–å…¨é˜»å¡ï¼Œè€Œä¸”CPUå”¤é†’é˜»å¡çº¿ç¨‹çš„å¼€é”€ä¼šå¾ˆå¤§

éå…¬å¹³è¡¨ç¤ºçº¿ç¨‹åœ¨ç”³è¯·é”æ—¶ï¼Œç›´æ¥å°è¯•è·å–é”ï¼Œè‹¥è·å–åˆ°åˆ™ç›´æ¥æ‹¿é”è·‘è·¯ï¼Œè·å–ä¸åˆ°å†è¿›å…¥é˜Ÿåˆ—å»æ’é˜Ÿ

* ä¼˜ç‚¹æ˜¯ååé‡ä¼šé«˜ä¸€ç‚¹ï¼Œè€Œä¸”å‡å°‘CPUçš„å”¤é†’æ¬¡æ•°ï¼Œå‡å°‘CPUå¼€é”€
* ç¼ºç‚¹æ˜¯å¯èƒ½å‡ºç°**é¥¥é¥¿**ç°è±¡ï¼Œå³é˜Ÿåˆ—ä¸­æŸäº›çº¿ç¨‹ç”±äºæŸäº›åŸå› ä¸€ç›´è·å–ä¸åˆ°é”ï¼Œå¯¼è‡´é¥¿æ­»

### 3.è‡ªæ—‹é”

 åˆ©ç”¨CASå®Œæˆè‡ªæ—‹é”ï¼Œä¸ä¼šé€ æˆé˜»å¡ï¼Œè€Œä¸”CASä¿è¯åŸå­æ€§

```java
//å®ç°å®‰å…¨çš„è‡ªå¢
public class SafeIncrement {
    private AtomicInteger atomicI = new AtomicInteger(0);

    public void increament() {
        for (;;) {//è‡ªæ—‹
            int i = atomicI.get();//å¦å¤–çº¿ç¨‹  å¯èƒ½ä¿®æ”¹è¿‡iå€¼
            boolean suc = atomicI.compareAndSet(i, ++i);
            if (suc) {//iä¿®æ”¹æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
                break;
            }
        }
    }
}
```




















