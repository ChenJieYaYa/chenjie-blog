# æ­¥æ­¥æ·±å…¥ä¹‹volatile

## ä¸€ã€å¤šçº¿ç¨‹æ“ä½œå…±äº«æ•°æ®å¸¦æ¥çš„é—®é¢˜

### 1.ä»£ç æè¿°é—®é¢˜

ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€å…±äº«å˜é‡ï¼Œä¸€ä¸ªè‡ªå¢žï¼Œä¸€ä¸ªè‡ªå‡ï¼Œæ¬¡æ•°éƒ½ä¸º5000æ¬¡ï¼Œç»“æžœä¼šæ˜¯0å—ï¼ŸðŸ¤”

```java
static int counter = 0;
public static void main(String[] args) throws InterruptedException {
	Thread t1 = new Thread(() -> {
		for (int i = 0; i < 5000; i++) {
			counter++;
		}
	}, "t1");
	Thread t2 = new Thread(() -> {
		for (int i = 0; i < 5000; i++) {
			counter--;
		}
	}, "t2");
    
	t1.start();
	t2.start();
	t1.join();
	t2.join();
	System.out.println(counter);
}
```

æµ‹è¯•ç»“æžœæ­£ã€è´Ÿã€é›¶éƒ½æœ‰ï¼Œè¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿ**å› ä¸ºè‡ªå¢žè‡ªå‡æ“ä½œå¹¶ä¸æ˜¯åŽŸå­æ“ä½œ**

### 2.é—®é¢˜åˆ†æž

æƒ³è¦äº†è§£è‡ªå¢žè‡ªå‡æ˜¯ä¸æ˜¯åŽŸå­æ“ä½œå¿…é¡»ä»Žå­—èŠ‚ç å¼€å§‹ï¼Œ













æ ˆä¸Žæ ˆå¸§
Java Virtual Machine Stacks ï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰
æˆ‘ä»¬éƒ½çŸ¥é“ JVM ä¸­ç”±å †ã€æ ˆã€æ–¹æ³•åŒºæ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿå…¶å®žå°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åŽï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ã€‚

1.æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜
2.æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•

çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰
å› ä¸ºä»¥ä¸‹ä¸€äº›åŽŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç 

1.çº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œ
2.åžƒåœ¾å›žæ”¶
3.æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ
4.çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lock ç­‰æ–¹æ³•

å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„

1.çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›žåœ°å€ç­‰
2.Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½


3.ä¸Šä¸‹æ–‡åˆ‡æ¢
ä¸Šä¸‹æ–‡ï¼šçº¿ç¨‹çš„è¿è¡Œæ¡ä»¶ä¸ŽçŠ¶æ€
å½“ä¸»åŠ¨è®©å‡ºCPU(sleep(),wwait())ï¼Œé˜»å¡žï¼Œæ—¶é—´ç‰‡ç”¨å®Œæˆ–ç»ˆæ­¢è¿è¡Œçš„çº¿ç¨‹æ—¶çº¿ç¨‹ä¸åœ¨å ç”¨CPUï¼Œå‰ä¸‰ç§éƒ½æ¶‰åŠçº¿ç¨‹åˆ‡æ¢ï¼Œéœ€ä¿ç•™å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå¾…å†æ¬¡å ç”¨CPUæ—¶ï¼Œæ¢å¤çŽ°åœºå¹¶åŠ è½½ä¸‹ä¸€ä¸ªå ç”¨CPUçº¿ç¨‹çš„ä¸Šä¸‹æ–‡
é¢‘ç¹çš„åˆ‡æ¢ä¸Šä¸‹æ–‡ä¼šæ¶ˆè€—CPU





å¹¶å‘ç¼–ç¨‹çš„æœ¬è´¨ï¼šå……åˆ†åˆ©ç”¨CPUèµ„æº