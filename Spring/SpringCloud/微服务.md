# 微服务

## 一、单体&集群&分布式

### 1.预览

![1665740928847](assets\1665740928847.png)

### 2.单体应用

**单体应用指将所有的功能集中在一个项目中开发**，采用分层、分包的方式实现代码解耦和管理，整个应用使用的都是同一个JVM，并且**整个项目打成一个包部署在一台服务器上**

单体应用架构简单，部署成本低，但其显而易见的缺陷是单台服务器的处理能力有限，随着业务扩大，导致代码量增大，造成编译和打包耗时，且耦合度高，升级维护都比较困难

<span style="color='#e89abe'">当单台服务器的硬件资源无法满足业务需求时，出现了集群</span>

### 3.集群&负载均衡

集群指将同一个业务部署在多个服务器上，该业务由多台服务器一起处理，其实就是**将单机多复制几份，每一份称为集群中的一个节点，所有的节点构成了集群，每个节点提供相同的服务**。集群中任意一台服务器出现问题，该服务器的业务可由其他服务器代为处理

集群结构的好处就是系统扩展非常容易，但问题是<span style="color='#e89abe'">用户请求该让集群中哪个节点处理？最好是能让压力小的相对叫空闲的服务器处理，出现了负载均衡</span>

**负载均衡起到分流的作用，保证每台服务器的压力比较平均**，充当调度者，用户的请求都交给它，然后它根据当前所有节点的负载情况决定将这个请求交给哪个节点处理。

随着业务又不断扩大，<span style="color='#e89abe'">集群中添加节点也无法使效率有明显提升，出现了微服务&分布式</span>

### 4.分布式&微服务

**从单机结构到集群结构你的代码基本无需要作任何修改，要做的仅仅是多部署几台服务器，每台服务器上运行相同的代码就行了**。但是当你要从集群结构演进到微服务结构时，之前的那套代码就需要发生较大的改动了。所以对于新系统我们建议，系统设计之初就采用微服务架构，这样后期运维的成本更低。但如果一套老系统需要升级成微服务结构的话，那就得对代码大动干戈了。所以，对于老系统而言究竟是继续保持集群模式，还是升级成微服务架构，这需要你们的架构师深思熟虑、权衡投入产出比。

**分布式结构就是将一个完整的系统按照业务功能拆分成一个个独立的子系统，在分布式结构中每个子系统就被称为服务**。这些**子系统被部署在不同的服务器，它们之间通过RPC方式通信**。每个子系统可以独立开发、独立部署、独立测试，系统与系统之间的边界非常明确，耦合度大大降低，从而系统更易于扩展；排错也变得相当容易，复用性更高，开发效率大大提升。

举个例子，假设需要开发一个在线商城，按照微服务的思想，我们需要按照功能模块拆分成多个独立的服务，如用户服务、产品服务、订单服务、后台管理服务、数据分析服务等等。每个服务都是独立的项目，可以独立运行。如果服务之间有依赖关系，那么通过RPC方式调用。假设这个商城要搞一次大促，下单量可能会大大提升，因此我们可以针对性地提升订单系统、产品系统的节点数量，而对于后台管理系统、数据分析系统而言节点数量维持原有水平即可。

**微服务与分布式的细微差别是微服务的应用不一定是分散在多个服务器上，也可以是同一个服务器，而分布式应用必须部署在多台服务器**，分布式是否属于微服务？答案是肯定的，**微服务的意思也就是将模块拆分成一个独立的服务单元，通过接口来实现数据的交互**。

### 5.小结

集群是一种物理形态，分布式是一种工作方式，而微服务是一种架构风格

## 二、微服务

### 1.微服务是什么？

分布式架构按照业务功能将系统拆分成若干子系统，降低服务耦合，但是**服务拆分时也有很多问题需要思考**，如服务拆分的粒度如何界定？服务之间如何通信和调用？服务的调用关系如何管理？服务的配置如何管理等等，因此人们需要制定一套行之有效的标准来约束分布式架构。

**微服务其实就是针对分布式架构建立的标准，解决服务拆分后存在的问题，可以认为微服务是一种经过良好架构设计的分布式架构方案**。

![1665989586432](assets\1665989586432.png)

### 2.SOA思想

**SOA思想指面向服务的架构思想，它将应用程序的不同功能单元（称为服务）进行拆分，并通过这些服务之间定义良好的接口和协议联系起来**。接口是采用中立的方式进行定义的，它应该独立于实现服务的硬件平台、操作系统和编程语言。这使得构件在各种各样的系统中的服务可以以一种统一和通用的方式进行交互。

SOA思想只是思想，如何让思想落地呢？例如SOAP(WebService(http+xml))、REST(SpringCloud(http+json))、RPC(Dubbo(socket))等就是很好的落地方案

------

任何分布式架构都离不开服务的拆分，微服务也是一样，这边总结几条拆分原则如下

- 不同微服务，不要重复开发相同业务
- 微服务数据独立，不要访问其它微服务的数据库
- 微服务可以将自己的业务暴露为接口，供其它微服务调用

### 3.微服务路由模式

**路由模式指客户端需要发现服务位置并路由到服务**，即微服务位置需透明且提供单一入口

![1665991217758](assets\1665991217758.png)

### 4.微服务弹性模式

微服务架构是高度分布式的，如何防止单个服务中的问题级联暴露给服务的消费者？存在以下四中弹性模式

|       模式       |                             说明                             |
| :--------------: | :----------------------------------------------------------: |
| 负载均衡(客户端) | 在客户端上缓存服务位置，以便客户端负载均衡到该微服务的所有健康实例 |
|    断路器模式    |       阻止客户端继续调用出现故障的或遭遇性能问题的服务       |
|     后备模式     | 客户端调用服务失败后尝试使用微服务之外的其他方法来执行工作(插件机制) |
|     舱壁模式     |  客户端隔离不同调用，防止表现不佳的服务占用客户端的所有资源  |

![1665992111666](assets\1665992111666.png)

### 5.微服务安全模式

首先对受保护的资源进行授权等权限管理操作，客户端尝试访问受保护的服务时需要进行身份验证并获得令牌，再由令牌服务器验证令牌

![1665992441976](assets\1665992441976.png)

### 6.微服务跟踪模式

微服务中单体应用被分解成可以彼此独立部署的小的功能部件，这些小功能部件之间的调试和跟踪也变得困难许多！客户端操作可能会调用多个服务，此时关联ID就是唯一标识，客户端每次事物调用都会携带关联ID，通过关联ID将各个服务产生的日志关联，并将所有日志聚合到可查数据库中

### 7.微服务布署模式

微服务架构内是不允许出现配置漂移的，即部署之后配置不允许改变

![1665994396722](assets\1665994396722.png)













































